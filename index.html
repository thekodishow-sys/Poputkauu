<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Попутка 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }
        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .screen.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .toast {
            transform: translateY(150%);
            transition: transform 0.3s ease-out;
            pointer-events: none;
        }
        .toast.show {
            transform: translateY(0);
            pointer-events: auto;
        }
        /* Стили для активных кнопок */
        .role-btn.active, .direction-buttons button.active, #time-interval-buttons button.active {
            background-color: #1e293b; /* bg-slate-800 */
            color: white;
        }
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            background-color: #ef4444; /* red-500 */
            border-radius: 9999px;
            border: 1px solid white;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">

    <div id="app-container" class="h-screen w-screen max-w-md mx-auto bg-white flex flex-col">
        <!-- Верхний бар -->
        <header id="app-header" class="p-4 flex items-center justify-between bg-white border-b border-slate-200 flex-shrink-0 sticky top-0 z-10">
            <button id="backButton" class="text-slate-500 hover:text-slate-800 transition-colors invisible">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <h1 id="headerTitle" class="text-lg font-semibold text-slate-800 text-center flex-grow">Попутка 12</h1>
            <div class="w-6"></div>
        </header>

        <main id="main-content" class="flex-grow overflow-y-auto p-5 relative">
            <!-- Главный экран выбора роли -->
            <div id="main-screen" class="screen active">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold mb-1">Добро пожаловать!</h2>
                    <p class="text-slate-500">Выберите вашу роль</p>
                </div>
                <div id="role-selector" class="mb-6 p-1 bg-slate-100 rounded-xl flex">
                    <button data-role="passenger" class="role-btn btn flex-1 py-3 px-4 rounded-lg font-semibold text-slate-500 transition-colors">Пассажир</button>
                    <button data-role="driver" class="role-btn btn flex-1 py-3 px-4 rounded-lg font-semibold text-slate-500 transition-colors">Водитель</button>
                </div>
                <button id="continue-btn" class="btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700 transition-all disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed" disabled>Продолжить</button>
            </div>

            <!-- Экраны, которые будут заполняться динамически -->
            <div id="route-selection-screen" class="screen"></div>
            <div id="passenger-home-screen" class="screen"></div>
            <div id="driver-dashboard-screen" class="screen"></div>
            <div id="offer-screen" class="screen"></div>
            <div id="passenger-request-screen" class="screen"></div>
            <div id="parcel-request-screen" class="screen"></div>
            <div id="list-screen" class="screen"></div>
            <div id="success-screen" class="screen"></div>
        </main>
        
        <div id="toast" class="toast fixed bottom-6 left-1/2 -translate-x-1/2 w-11/12 max-w-sm p-4 rounded-lg shadow-lg text-white text-center z-50"><p id="toast-message"></p></div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    const SUPABASE_URL = 'https://scqkpvmmoaolahpxinja.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzIıNiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjcWtwdm1tb2FvbGFocHhpbmphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDIwNDksImV4cCI6MjA3MTE3ODA0OX0.Uz5L2SF8O1EGf_efkq5FLi6g1yl7LlmnTZi_eLnISMw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const App = {
        state: {
            rideOffers: [],
            rideRequests: [],
            parcelRequests: [],
            userRole: null, 
            currentUser: null,
            selectedRoute: null, 
            toastTimeout: null,
            navigationHistory: ['main-screen'],
        },

        init() {
            try { 
                Telegram.WebApp.ready(); 
                Telegram.WebApp.expand(); 
                Telegram.WebApp.setHeaderColor('#ffffff');
                Telegram.WebApp.setBackgroundColor('#f8fafc');
                this.state.currentUser = Telegram.WebApp.initDataUnsafe?.user;
            } catch(e) { 
                console.warn("Telegram WebApp script not found or running in browser."); 
                this.state.currentUser = { id: 12345, first_name: 'Тест', username: 'testuser' };
            }
            
            this.render.allScreens();
            this.bindEvents();
            this.setDefaultDates();
        },

        setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            ['date-offer', 'date-request', 'date-parcel'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.setAttribute('min', today);
                    input.value = today;
                }
            });
        },
        
        bindEvents() {
            document.getElementById('role-selector').addEventListener('click', (e) => {
                const target = e.target.closest('.role-btn');
                if (!target) return;
                document.querySelectorAll('#role-selector .role-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                this.state.userRole = target.dataset.role;
                document.getElementById('continue-btn').disabled = false;
            });

            document.getElementById('continue-btn').addEventListener('click', () => {
                if (this.state.userRole) this.navigation.to('route-selection-screen', 'Выберите маршрут');
            });

            document.getElementById('backButton').addEventListener('click', () => this.navigation.back());
            
            document.body.addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (!target) return;
                const handlers = {
                    'select-route-koz-yo': this.handlers.onRouteSelect,
                    'view-driver-offers-btn': this.handlers.onViewDriverOffers,
                    'create-passenger-request-btn': () => this.navigation.to('passenger-request-screen', 'Заявка на поездку'),
                    'send-parcel-btn': () => this.navigation.to('parcel-request-screen', 'Отправить посылку'),
                    'view-passenger-requests-btn': this.handlers.onViewPassengerRequests,
                    'publish-ride-btn': () => this.navigation.to('offer-screen', 'Новая поездка'),
                    'back-to-hub-btn': () => {
                        const screen = this.state.userRole === 'driver' ? 'driver-dashboard-screen' : 'passenger-home-screen';
                        const title = this.state.userRole === 'driver' ? 'Кабинет водителя' : 'Пассажир';
                        this.navigation.to(screen, title);
                    },
                };
                if (handlers[target.id]) handlers[target.id].call(this, e);
                if (target.closest('.direction-buttons')) this.handlers.onDirectionSelect.call(this, e);
                if (target.closest('#time-interval-buttons')) this.handlers.onTimeSelect.call(this, e);
            });

            document.body.addEventListener('submit', (e) => {
                e.preventDefault();
                const targetId = e.target.id;
                const handlers = {
                    'passenger-request-form': this.handlers.onPassengerRequestSubmit,
                    'parcel-request-form': this.handlers.onParcelRequestSubmit,
                    'offer-form': this.handlers.onOfferSubmit,
                };
                if (handlers[targetId]) handlers[targetId].call(this, e);
            });

            document.body.addEventListener('change', (e) => {
                const targetId = e.target.id;
                if (targetId === 'via-cheboksary-toggle' || targetId === 'via-ferry-toggle') {
                    this.handlers.onRouteOptionChange(e.target);
                }
            });
        },

        handlers: {
            onRouteOptionChange(target) {
                const cheboksaryToggle = document.getElementById('via-cheboksary-toggle');
                const ferryToggle = document.getElementById('via-ferry-toggle');
                const cheboksaryContainer = document.getElementById('cheboksary-option-container');
                const ferryContainer = document.getElementById('ferry-option-container');

                if (target.id === 'via-cheboksary-toggle' && target.checked) {
                    ferryToggle.checked = false;
                }
                if (target.id === 'via-ferry-toggle' && target.checked) {
                    cheboksaryToggle.checked = false;
                }

                cheboksaryContainer.classList.toggle('opacity-50', ferryToggle.checked);
                ferryContainer.classList.toggle('opacity-50', cheboksaryToggle.checked);
                cheboksaryToggle.disabled = ferryToggle.checked;
                ferryToggle.disabled = cheboksaryToggle.checked;

                this.updateOfferOptionsUI();
            },
            updateOfferOptionsUI() {
                const cheboksaryToggle = document.getElementById('via-cheboksary-toggle');
                const ferryToggle = document.getElementById('via-ferry-toggle');
                
                document.getElementById('cheboksary-price').classList.toggle('hidden', !cheboksaryToggle.checked);
                document.getElementById('ferry-price-increase').classList.toggle('hidden', !ferryToggle.checked);
                
                let basePrice = 600;
                if (ferryToggle.checked) {
                    basePrice += 100;
                }
                document.getElementById('publish-price').textContent = basePrice;
            },
            onRouteSelect(e) {
                const button = e.target.closest('button');
                if (!button) return;
                this.state.selectedRoute = { from: button.dataset.from, to: button.dataset.to };
                const screen = this.state.userRole === 'passenger' ? 'passenger-home-screen' : 'driver-dashboard-screen';
                const title = this.state.userRole === 'passenger' ? 'Пассажир' : 'Кабинет водителя';
                this.navigation.to(screen, title);
            },
            onDirectionSelect(e) { 
                const button = e.target.closest('button'); 
                if (!button) return; 
                const form = button.closest('form'); 
                form.querySelector('.form-error-direction')?.classList.add('hidden'); 
                const container = button.parentElement; 
                container.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); 
                button.classList.add('active'); 
                form.querySelector('input[name="from"]').value = button.dataset.from; 
                form.querySelector('input[name="to"]').value = button.dataset.to; 
            },
            onTimeSelect(e) {
                const button = e.target.closest('button');
                if (!button) return;
                const form = button.closest('form');
                button.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                form.querySelector('#timeIntervalInput').value = button.textContent;
                form.querySelector('.form-error-time').classList.add('hidden');
            },
            async onViewDriverOffers() { 
                const { data, error } = await supabaseClient.from('ride_offers').select('*').order('ride_date', { ascending: true }).order('ride_time', { ascending: true });
                if (error) { this.showToast('Ошибка загрузки поездок', 'error'); console.error(error); return; }
                this.state.rideOffers = data;
                this.render.list(this.state.rideOffers, 'driverOffer'); 
                this.navigation.to('list-screen', 'Поездки водителей'); 
            },
            async onViewPassengerRequests() { 
                const { data: rides, error: ridesError } = await supabaseClient.from('ride_requests').select('*');
                const { data: parcels, error: parcelsError } = await supabaseClient.from('parcel_requests').select('*');
                if (ridesError || parcelsError) { this.showToast('Ошибка загрузки заявок', 'error'); console.error(ridesError || parcelsError); return; }
                const allRequests = [...rides.map(r => ({...r, type: 'ride'})), ...parcels.map(p => ({...p, type: 'parcel'}))];
                allRequests.sort((a,b) => new Date(a.ride_date) - new Date(b.ride_date));
                this.render.list(allRequests, 'passengerRequest'); 
                this.navigation.to('list-screen', 'Заявки от пассажиров'); 
            },
            async onPassengerRequestSubmit(e) { 
                const form = e.target; 
                const formData = new FormData(form); 
                let valid = true; 
                if (!formData.get('from')) { form.querySelector('.form-error-direction').classList.remove('hidden'); valid = false; } 
                if (!formData.get('timeInterval')) { form.querySelector('.form-error-time').classList.remove('hidden'); valid = false; }
                if (!formData.get('passengerName').trim()) { valid = false; this.showToast('Пожалуйста, укажите ваше имя', 'error'); } 
                if (!valid) return; 
                
                const { error } = await supabaseClient.from('ride_requests').insert({
                    passenger_id: this.state.currentUser.id, passenger_username: this.state.currentUser.username,
                    "from": formData.get('from'), "to": formData.get('to'), ride_date: formData.get('date'),
                    time_interval: formData.get('timeInterval'), passenger_name: formData.get('passengerName'), price: 600
                });
                if (error) { this.showToast('Ошибка создания заявки', 'error'); console.error(error); return; }
                this.resetForm(form); 
                this.render.success('Заявка создана', 'Водители скоро увидят вашу заявку.', 'Отлично'); 
            },
            async onParcelRequestSubmit(e) { 
                const form = e.target; 
                const formData = new FormData(form); 
                if (!formData.get('from')) { form.querySelector('.form-error-direction').classList.remove('hidden'); return; } 
                const { error } = await supabaseClient.from('parcel_requests').insert({
                    sender_id: this.state.currentUser.id, sender_username: this.state.currentUser.username,
                    "from": formData.get('from'), "to": formData.get('to'), ride_date: formData.get('date'),
                    sender_name: this.state.currentUser.first_name || 'Отправитель', price: 300
                });
                if (error) { this.showToast('Ошибка создания заявки', 'error'); console.error(error); return; }
                this.resetForm(form); 
                this.render.success('Заявка на посылку создана', 'Водители увидят вашу заявку.', 'Отлично'); 
            },
            async onOfferSubmit(e) { 
                const form = e.target; 
                const formData = new FormData(form); 
                if (!formData.get('from')) { form.querySelector('.form-error-direction').classList.remove('hidden'); return; } 
                if (!formData.get('driverName').trim() || !formData.get('driverCar').trim()) { this.showToast('Укажите имя и машину', 'error'); return; } 
                
                const viaCheboksary = form.querySelector('#via-cheboksary-toggle').checked;
                const viaFerry = form.querySelector('#via-ferry-toggle').checked;
                const finalPrice = viaFerry ? 700 : 600;

                const { error } = await supabaseClient.from('ride_offers').insert({
                    driver_id: this.state.currentUser.id, driver_username: this.state.currentUser.username,
                    "from": formData.get('from'), "to": formData.get('to'), ride_date: formData.get('date'),
                    ride_time: formData.get('time'), seats: parseInt(formData.get('seats')),
                    price: finalPrice, driver_name: formData.get('driverName'), driver_car: formData.get('driverCar'),
                    via_cheboksary: viaCheboksary, via_ferry: viaFerry
                });
                if (error) { this.showToast('Ошибка публикации', 'error'); console.error(error); return; }
                this.resetForm(form); 
                this.render.success('Поездка опубликована', 'Пассажиры теперь видят ваше предложение.', 'В кабинет'); 
            },
        },
        
        navigation: {
            to(screenId, title) {
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                document.getElementById('headerTitle').textContent = title;
                if (this.state.navigationHistory[this.state.navigationHistory.length - 1] !== screenId) {
                    this.state.navigationHistory.push(screenId);
                }
                document.getElementById('backButton').classList.toggle('invisible', this.state.navigationHistory.length <= 1);
                if (screenId === 'passenger-request-screen' || screenId === 'offer-screen') {
                    App.render.populateUserData(screenId);
                }
                document.getElementById('main-content').scrollTop = 0;
            },
            back() {
                this.state.navigationHistory.pop();
                const lastScreen = this.state.navigationHistory[this.state.navigationHistory.length - 1];
                let title = 'Попутка 12';
                if (lastScreen !== 'main-screen') {
                    const titles = {
                        'route-selection-screen': 'Выберите маршрут',
                        'passenger-home-screen': 'Пассажир',
                        'driver-dashboard-screen': 'Кабинет водителя',
                        'list-screen': document.getElementById('headerTitle').textContent,
                    };
                    title = titles[lastScreen] || 'Попутка 12';
                }
                this.to(lastScreen, title);
            }
        },

        render: {
            allScreens() {
                const templates = {
                    'route-selection-screen': `<div class="text-center mb-8"><h2 class="text-2xl font-bold mb-1">Выберите маршрут</h2></div><div class="space-y-4"><button id="select-route-koz-yo" data-from="Козьмодемьянск" data-to="Йошкар-Ола" class="btn w-full bg-slate-800 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">Козьмодемьянск &lt;—&gt; Йошкар-Ола</button></div>`,
                    'passenger-home-screen': `<div class="text-center mb-6"><h2 class="text-2xl font-bold mb-1">Что вы хотите сделать?</h2></div><div class="space-y-3"><button id="view-driver-offers-btn" class="btn w-full bg-slate-800 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">Смотреть поездки водителей</button><button id="create-passenger-request-btn" class="btn w-full bg-slate-100 text-slate-800 font-bold py-4 px-4 rounded-xl hover:bg-slate-200">Оставить заявку на поездку</button><button id="send-parcel-btn" class="btn w-full bg-purple-100 text-purple-800 font-bold py-4 px-4 rounded-xl hover:bg-purple-200">Отправить посылку</button></div>`,
                    'driver-dashboard-screen': `<div class="text-center mb-6"><h2 class="text-2xl font-bold mb-1">Кабинет водителя</h2></div><div id="driver-dashboard-buttons" class="space-y-3"><button id="view-passenger-requests-btn" class="btn w-full bg-slate-800 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">Смотреть заявки</button><button id="publish-ride-btn" class="btn w-full bg-slate-100 text-slate-800 font-bold py-4 px-4 rounded-xl hover:bg-slate-200">Опубликовать свою поездку</button></div>`,
                    'offer-screen': `<h2 class="text-xl font-bold mb-4">Данные о поездке</h2><form id="offer-form" class="space-y-4"><div><label class="block text-sm font-medium text-slate-600 mb-2">Направление</label><div class="direction-buttons p-1 bg-slate-100 rounded-xl flex"><button type="button" data-from="Козьмодемьянск" data-to="Йошкар-Ола" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">КЗМ → ЙО</button><button type="button" data-from="Йошкар-Ола" data-to="Козьмодемьянск" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">ЙО → КЗМ</button></div><input type="hidden" name="from" required><input type="hidden" name="to" required><div class="form-error-direction text-red-500 text-sm text-center mt-2 hidden">Пожалуйста, выберите направление</div></div><div class="space-y-2"><div id="cheboksary-option-container" class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between transition-opacity"><label for="via-cheboksary-toggle" class="text-slate-700 font-medium cursor-pointer flex-grow">До/Из Чебоксар</label><div class="flex items-center space-x-3"><span id="cheboksary-price" class="text-slate-800 font-semibold hidden">(400 ₽)</span><label for="via-cheboksary-toggle" class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-cheboksary-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div></div><div id="ferry-option-container" class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between transition-opacity"><label for="via-ferry-toggle" class="text-slate-700 font-medium cursor-pointer flex-grow">Через паром</label><div class="flex items-center space-x-3"><span id="ferry-price-increase" class="text-slate-800 font-semibold hidden">(+100 ₽)</span><label for="via-ferry-toggle" class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-ferry-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div></div></div><div class="grid grid-cols-2 gap-4"><div><label for="date-offer" class="block text-sm font-medium text-slate-600 mb-2">Дата</label><input type="date" name="date" id="date-offer" class="w-full p-3 border border-slate-200 rounded-lg" required></div><div><label for="time-offer" class="block text-sm font-medium text-slate-600 mb-2">Время</label><input type="time" name="time" id="time-offer" class="w-full p-3 border border-slate-200 rounded-lg" required></div></div><div class="grid grid-cols-2 gap-4"><div><label for="driver-name" class="block text-sm font-medium text-slate-600 mb-2">Ваше имя</label><input type="text" name="driverName" id="driver-name" class="w-full p-3 border border-slate-200 rounded-lg" placeholder="Алексей" required></div><div><label for="driver-car" class="block text-sm font-medium text-slate-600 mb-2">Марка машины</label><input type="text" name="driverCar" id="driver-car" class="w-full p-3 border border-slate-200 rounded-lg" placeholder="Kia Rio" required></div></div><div><label class="block text-sm font-medium text-slate-600 mb-2">Количество мест</label><input type="number" name="seats" min="1" max="8" class="w-full p-3 border border-slate-200 rounded-lg" placeholder="Например: 3" required></div><button id="publish-offer-btn" type="submit" class="btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">Опубликовать (<span id="publish-price">600</span> ₽)</button></form>`,
                    'passenger-request-screen': `<h2 class="text-xl font-bold mb-4">Ваша заявка</h2><form id="passenger-request-form" class="space-y-4"><div><label class="block text-sm font-medium text-slate-600 mb-2">Направление</label><div class="direction-buttons p-1 bg-slate-100 rounded-xl flex"><button type="button" data-from="Козьмодемьянск" data-to="Йошкар-Ола" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">КЗМ → ЙО</button><button type="button" data-from="Йошкар-Ола" data-to="Козьмодемьянск" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">ЙО → КЗМ</button></div><input type="hidden" name="from" required><input type="hidden" name="to" required><div class="form-error-direction text-red-500 text-sm text-center mt-2 hidden">Пожалуйста, выберите направление</div></div><input type="date" name="date" id="date-request" class="w-full p-3 border border-slate-200 rounded-lg" required><div><label for="passenger-name" class="block text-sm font-medium text-slate-600 mb-2">Ваше имя</label><input type="text" name="passengerName" id="passenger-name" class="w-full p-3 border border-slate-200 rounded-lg" placeholder="Мария" required></div><div><label class="block text-sm font-medium text-slate-600 mb-2">Желаемое время выезда</label><div id="time-interval-buttons" class="grid grid-cols-2 sm:grid-cols-4 gap-2"><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">04-06</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">06-08</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">08-10</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">10-12</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">12-14</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">14-16</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">16-18</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">18-20</button></div><input type="hidden" name="timeInterval" id="timeIntervalInput" required><div class="form-error-time text-red-500 text-sm text-center mt-2 hidden">Пожалуйста, выберите время</div></div><button type="submit" class="btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">Оставить заявку</button></form>`,
                    'parcel-request-screen': `<h2 class="text-xl font-bold mb-4">Отправить посылку</h2><form id="parcel-request-form" class="space-y-4"><div><label class="block text-sm font-medium text-slate-600 mb-2">Направление</label><div class="direction-buttons p-1 bg-slate-100 rounded-xl flex"><button type="button" data-from="Козьмодемьянск" data-to="Йошкар-Ола" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">КЗМ → ЙО</button><button type="button" data-from="Йошкар-Ола" data-to="Козьмодемьянск" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">ЙО → КЗМ</button></div><input type="hidden" name="from" required><input type="hidden" name="to" required><div class="form-error-direction text-red-500 text-sm text-center mt-2 hidden">Пожалуйста, выберите направление</div></div><div><label for="date-parcel" class="block text-sm font-medium text-slate-600 mb-2">Дата отправки</label><input type="date" name="date" id="date-parcel" class="w-full p-3 border border-slate-200 rounded-lg" required></div><div class="bg-slate-100 p-3 rounded-lg text-center text-slate-600">Стоимость отправки: <span class="font-bold">300 ₽</span></div><button type="submit" class="btn w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Создать заявку на посылку</button></form>`,
                    'list-screen': `<div id="list-container" class="space-y-3"></div><div id="no-results" class="text-center text-slate-500 py-10 hidden"><h3 id="no-results-title" class="text-lg font-semibold"></h3><p id="no-results-text" class="text-sm"></p></div>`,
                    'success-screen': `<div class="flex flex-col items-center justify-center h-full text-center"><div class="mb-4"><svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><h2 id="success-title" class="text-2xl font-bold mt-4 mb-1"></h2><p id="success-text" class="text-slate-600 mb-8"></p><button id="back-to-hub-btn" class="btn w-full max-w-xs bg-slate-800 text-white font-bold py-3 px-4 rounded-lg"></button></div>`,
                };
                for (const [id, html] of Object.entries(templates)) {
                    document.getElementById(id).innerHTML = html;
                }
            },
            list(items, type) {
                const container = document.getElementById('list-container');
                const noResults = document.getElementById('no-results');
                container.innerHTML = '';

                if (!items || items.length === 0) {
                    noResults.classList.remove('hidden');
                    document.getElementById('no-results-title').textContent = type === 'driverOffer' ? 'Поездок не найдено' : 'Заявок не найдено';
                    document.getElementById('no-results-text').textContent = type === 'driverOffer' ? 'Попробуйте зайти позже или оставьте свою заявку.' : 'Как только появятся новые заявки, вы их здесь увидите.';
                    return;
                }
                noResults.classList.add('hidden');

                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white border border-slate-200 rounded-xl p-4 space-y-3';
                    let routeInfo = '';
                    if (item.via_ferry) {
                        routeInfo = `<div class="mt-2 pt-2 border-t border-slate-100"><p class="text-sm text-center font-semibold bg-blue-500 text-white rounded-full px-3 py-1">⛴️ Через паром</p></div>`;
                    } else if (item.via_cheboksary) {
                        routeInfo = `<div class="mt-2 pt-2 border-t border-slate-100"><p class="text-sm text-center font-semibold bg-green-500 text-white rounded-full px-3 py-1">До/Из Чебоксар (400 ₽)</p></div>`;
                    }

                    if (type === 'driverOffer') {
                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="font-bold text-lg">${item.from} → ${item.to}</div>
                                <div class="text-lg font-semibold">${item.price} ₽</div>
                            </div>
                            <div class="text-slate-600">
                                <p><strong>Дата:</strong> ${this.formatDate(item.ride_date)} в <strong>${item.ride_time}</strong></p>
                                <p><strong>Водитель:</strong> ${item.driver_name} на ${item.driver_car}</p>
                                <p><strong>Свободных мест:</strong> ${item.seats}</p>
                            </div>
                            ${routeInfo}
                            <a href="https://t.me/${item.driver_username}" target="_blank" class="block w-full text-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Связаться с водителем</a>
                        `;
                    } else { // passengerRequest
                        const isParcel = item.type === 'parcel';
                        card.innerHTML = `
                            <div class="flex justify-between items-center">
                                <div class="font-bold text-lg">${item.from} → ${item.to}</div>
                                <div class="text-lg font-semibold">${item.price} ₽</div>
                            </div>
                            <div class="text-slate-600">
                                <p><strong>Дата:</strong> ${this.formatDate(item.ride_date)}</p>
                                <p><strong>${isParcel ? 'Отправитель' : 'Пассажир'}:</strong> ${isParcel ? item.sender_name : item.passenger_name}</p>
                                ${!isParcel ? `<p><strong>Время:</strong> ${item.time_interval}</p>` : ''}
                            </div>
                            <div class="flex items-center gap-2">
                                ${isParcel ? `<div class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Посылка</div>` : `<div class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">Пассажир</div>`}
                            </div>
                            <a href="https://t.me/${isParcel ? item.sender_username : item.passenger_username}" target="_blank" class="block w-full text-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">Связаться</a>
                        `;
                    }
                    container.appendChild(card);
                });
            },
            success(title, text, buttonText) {
                document.getElementById('success-title').textContent = title;
                document.getElementById('success-text').textContent = text;
                document.getElementById('back-to-hub-btn').textContent = buttonText;
                this.navigation.to('success-screen', 'Успех');
            },
            populateUserData(screenId) {
                if (!App.state.currentUser) return;
                const firstName = App.state.currentUser.first_name || '';
                if (screenId === 'passenger-request-screen') {
                    document.getElementById('passenger-name').value = firstName;
                } else if (screenId === 'offer-screen') {
                    document.getElementById('driver-name').value = firstName;
                }
            },
            formatDate(dateString) {
                const date = new Date(dateString);
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                if (date.toDateString() === today.toDateString()) return 'Сегодня';
                if (date.toDateString() === tomorrow.toDateString()) return 'Завтра';
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            }
        },

        resetForm(form) {
            form.reset();
            this.setDefaultDates();
            form.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
            
            const cheboksaryContainer = form.querySelector('#cheboksary-option-container');
            const ferryContainer = form.querySelector('#ferry-option-container');
            if (cheboksaryContainer && ferryContainer) {
                cheboksaryContainer.classList.remove('opacity-50');
                ferryContainer.classList.remove('opacity-50');
                form.querySelector('#via-cheboksary-toggle').disabled = false;
                form.querySelector('#via-ferry-toggle').disabled = false;
            }
            this.handlers.updateOfferOptionsUI();
        },
        
        showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const messageEl = document.getElementById('toast-message');
            messageEl.textContent = message;
            toast.className = 'toast fixed bottom-6 left-1/2 -translate-x-1/2 w-11/12 max-w-sm p-4 rounded-lg shadow-lg text-white text-center z-50';
            toast.classList.add(type === 'error' ? 'bg-red-500' : 'bg-green-500');
            toast.classList.add('show');
            if (this.state.toastTimeout) clearTimeout(this.state.toastTimeout);
            this.state.toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
