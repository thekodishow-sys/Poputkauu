<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ü–æ–ø—É—Ç–∫–∞ 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }
        .screen { display: none; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: block; }
        #chat-screen.active, #my-trips-screen.active { display: flex; flex-direction: column; height: 100%; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .role-btn.active, .direction-buttons button.active, #time-interval-buttons button.active {
            background-color: #1e293b; color: white;
        }
        .message { max-width: 75%; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background-color: #3b82f6; color: white; }
        .message.received { align-self: flex-start; background-color: #e5e7eb; color: #1f2937; }
        #role-switcher { position: relative; }
        #role-bg {
            position: absolute; width: 36px; height: 36px;
            top: 2px; left: 2px; background-color: white;
            border-radius: 9999px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transform: translateX(0px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #role-switcher.driver #role-bg { transform: translateX(36px); }
        #role-passenger-icon, #role-driver-icon { transition: opacity 0.3s ease-in-out; }
        #role-passenger-icon span, #role-driver-icon span {
            display: inline-block;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #role-switcher.passenger #role-passenger-icon span,
        #role-switcher.driver #role-driver-icon span { transform: scale(1.15) rotate(-8deg); }
        #role-switcher.passenger #role-driver-icon,
        #role-switcher.driver #role-passenger-icon { opacity: 0.5; }
        #profile-avatar-btn img { width: 100%; height: 100%; object-fit: cover; }
        .modal-overlay { opacity: 0; transition: opacity 0.3s ease-in-out; }
        .modal-overlay.show { opacity: 1; }
        .modal.show { transform: translateY(0); }
        .filter-type-btn.active { background-color: white; color: #1e293b; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        #filter-toggle-icon { transition: transform 0.3s ease-in-out; }
        #filter-content {
            max-height: 500px; overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out; opacity: 1;
        }
        #filter-content.collapsed { max-height: 0; opacity: 0; }
        #filter-toggle-btn.collapsed #filter-toggle-icon { transform: rotate(-180deg); }
        #main-content::-webkit-scrollbar { width: 4px; }
        #main-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        #main-content::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">

    <div id="init-screen" class="h-screen w-screen max-w-md mx-auto flex items-center justify-center text-center p-5">
        <!-- Content will be injected by JS -->
    </div>

    <div id="app-container" class="h-screen w-screen max-w-md mx-auto bg-white flex-col hidden">
        <!-- HEADER -->
        <header id="app-header" class="p-4 flex items-center justify-between bg-white border-b border-slate-200 flex-shrink-0 sticky top-0 z-10">
            <div class="w-10 h-10 flex items-center justify-start">
                <button id="backButton" class="text-slate-500 hover:text-slate-800 transition-colors invisible">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
            </div>
            <div id="role-switcher" class="flex items-center p-1 bg-slate-100 rounded-full cursor-pointer">
                <div id="role-bg"></div>
                <div id="role-passenger-icon" class="relative z-10 w-9 h-9 flex items-center justify-center text-xl"><span>üßç</span></div>
                <div id="role-driver-icon" class="relative z-10 w-9 h-9 flex items-center justify-center text-xl"><span>üöó</span></div>
            </div>
            <div class="w-10 h-10 flex items-center justify-end">
                <button id="profile-avatar-btn" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 font-semibold flex items-center justify-center overflow-hidden shrink-0"></button>
            </div>
        </header>

        <!-- MAIN CONTENT -->
        <main id="main-content" class="flex-grow overflow-y-auto relative">
            <div id="passenger-home-screen" class="screen active"></div>
            <div id="driver-dashboard-screen" class="screen"></div>
            <div id="offer-screen" class="screen"></div>
            <div id="passenger-request-screen" class="screen"></div>
            <div id="parcel-request-screen" class="screen"></div>
            <div id="list-screen" class="screen"></div>
            <div id="success-screen" class="screen"></div>
            <div id="my-trips-screen" class="screen"></div>
            <div id="profile-screen" class="screen"></div>
        </main>
        
        <!-- FOOTER -->
        <footer id="app-footer" class="p-5 border-t border-slate-200 bg-white flex-shrink-0">
            <a href="https://t.me/poputka12rus" target="_blank" class="text-sm btn w-full bg-sky-100 text-sky-800 font-bold py-3 px-4 rounded-xl hover:bg-sky-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                <span>–ù–∞—à–∞ –≥—Ä—É–ø–ø–∞ –≤ Telegram</span>
            </a>
            <a href="https://devtol.ru" target="_blank" class="block text-center text-xs text-slate-400 mt-2 hover:underline">
                powered by devtol
            </a>
        </footer>
    </div>

    <!-- MODALS -->
    <div id="booking-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
    <div id="booking-modal" class="modal fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto bg-transparent z-50 transform translate-y-full transition-transform duration-300">
        <div class="p-4">
            <div id="booking-options-container" class="space-y-2 bg-slate-100 rounded-xl"></div>
            <button id="booking-modal-cancel-btn" class="w-full p-3 mt-2 bg-white rounded-xl text-blue-500 text-lg font-semibold">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- HTML TEMPLATES -->
    <template id="passenger-home-screen-template">
        <div class="p-5">
            <div class="text-center mb-6"><h2 class="text-xl font-bold mb-1">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?</h2></div>
            <div class="space-y-3">
                <button id="view-driver-offers-btn" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">–°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–µ–∑–¥–∫–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π</button>
                <button id="create-passenger-request-btn" class="text-sm btn w-full bg-slate-100 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-200">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–µ–∑–¥–∫—É</button>
                <button id="send-parcel-btn" class="text-sm btn w-full bg-purple-100 text-purple-800 font-bold py-3 px-4 rounded-xl hover:bg-purple-200">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É</button>
                <button id="my-trips-btn" class="text-sm mt-4 btn w-full border border-slate-300 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-100">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏ –∏ –∑–∞—è–≤–∫–∏</button>
            </div>
        </div>
    </template>
    <template id="driver-dashboard-screen-template">
        <div class="p-5">
            <div class="text-center mb-6"><h2 class="text-xl font-bold mb-1">–ö–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è</h2></div>
            <div class="space-y-3">
                <button id="view-passenger-requests-btn" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">–°–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏</button>
                <button id="publish-ride-btn" class="text-sm btn w-full bg-slate-100 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-200">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–≤–æ—é –ø–æ–µ–∑–¥–∫—É</button>
                <button id="my-trips-btn" class="text-sm mt-4 btn w-full border border-slate-300 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-100">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</button>
            </div>
        </div>
    </template>
    <template id="list-screen-template">
         <div class="p-4 space-y-4">
            <div id="filter-section-container" class="hidden">
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <button id="filter-toggle-btn" class="flex justify-between items-center w-full mb-3">
                        <h3 class="text-base font-semibold text-slate-800">–§–∏–ª—å—Ç—Ä—ã</h3>
                        <svg id="filter-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="m18 15-6-6-6 6"/></svg>
                    </button>
                    <div id="filter-content" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="filter-from" class="block text-xs font-medium text-slate-600 mb-1">–û—Ç–∫—É–¥–∞</label>
                                <select id="filter-from" name="from" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white"></select>
                            </div>
                            <div>
                                <label for="filter-to" class="block text-xs font-medium text-slate-600 mb-1">–ö—É–¥–∞</label>
                                <select id="filter-to" name="to" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white"></select>
                            </div>
                        </div>
                        <div>
                            <label for="filter-date" class="block text-xs font-medium text-slate-600 mb-1">–î–∞—Ç–∞</label>
                            <input type="date" id="filter-date" name="date" class="w-full p-2 border border-slate-200 rounded-lg text-sm">
                        </div>
                        <div id="filter-type-container">
                            <label class="block text-xs font-medium text-slate-600 mb-1">–¢–∏–ø –∑–∞—è–≤–∫–∏</label>
                            <div id="filter-type-buttons" class="flex p-1 bg-slate-200 rounded-lg">
                                <button data-type="all" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600 active">–í—Å–µ</button>
                                <button data-type="ride" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
                                <button data-type="parcel" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600">–ü–æ—Å—ã–ª–∫–∏</button>
                            </div>
                        </div>
                        <div class="flex gap-3 pt-2">
                            <button id="reset-filters-btn" class="flex-1 text-sm btn border border-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-100">–°–±—Ä–æ—Å–∏—Ç—å</button>
                            <button id="apply-filters-btn" class="flex-1 text-sm btn bg-slate-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="list-container" class="space-y-3"></div>
            <div id="no-results" class="text-center text-slate-500 py-10 hidden"><h3 id="no-results-title" class="text-base font-semibold"></h3><p id="no-results-text" class="text-xs"></p></div>
        </div>
    </template>
    <template id="success-screen-template">
        <div class="p-5 flex flex-col items-center justify-center h-full text-center">
            <div class="mb-4"><svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
            <h2 id="success-title" class="text-xl font-bold mt-4 mb-1"></h2>
            <p id="success-text" class="text-slate-600 mb-8 text-sm"></p>
            <button id="back-to-hub-btn" class="text-sm btn w-full max-w-xs bg-slate-800 text-white font-bold py-3 px-4 rounded-lg"></button>
        </div>
    </template>
    <template id="my-trips-screen-template">
         <div class="flex-1 flex flex-col">
            <div id="my-trips-container" class="p-5 space-y-4 flex-1"></div>
        </div>
    </template>
    <template id="profile-screen-template">
         <div class="p-5">
            <h2 class="text-lg font-bold mb-4">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <p class="text-xs text-slate-600 mb-4">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤–∞—à–µ –∏–º—è. –ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –±—ã—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è.</p>
            <form id="profile-form" class="space-y-4">
                <div>
                    <label for="profile-name" class="block text-xs font-medium text-slate-600 mb-2">–í–∞—à–µ –∏–º—è</label>
                    <input type="text" name="fullName" id="profile-name" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–ê–ª–µ–∫—Å–µ–π" required>
                </div>
                <div>
                    <label for="profile-car" class="block text-xs font-medium text-slate-600 mb-2">–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω—ã (–¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π)</label>
                    <input type="text" name="driverCar" id="profile-car" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="Kia Rio">
                </div>
                <button type="submit" class="text-sm btn w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </template>
    <template id="offer-screen-template">
        <div class="p-5">
            <h2 class="text-lg font-bold mb-4">–î–∞–Ω–Ω—ã–µ –æ –ø–æ–µ–∑–¥–∫–µ</h2>
            <form id="offer-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                        <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                        <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                </div>
                <input type="hidden" name="from" required><input type="hidden" name="to" required>
                <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                <div id="ferry-toggle-container" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                    <label for="via-ferry-toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º</label>
                    <div class="flex items-center space-x-3">
                        <span id="ferry-price-increase" class="text-sm text-slate-800 font-semibold hidden"></span>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-ferry-toggle" name="via_ferry" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label>
                    </div>
                </div>
                <div id="cheboksary-detour-container" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                    <label for="via-cheboksary-detour-toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ó–∞–µ–∑–∂–∞—é –≤ –ß–µ–±–æ–∫—Å–∞—Ä—ã</label>
                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-cheboksary-detour-toggle" name="via_cheboksary_detour" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div></label>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞</label><input type="date" name="date" id="date-offer" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div>
                    <div><label class="block text-xs font-medium text-slate-600 mb-2">–í—Ä–µ–º—è</label><input type="time" name="time" id="time-offer" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label>
                    <input type="number" name="seats" min="1" max="8" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3" required>
                </div>
                <button type="submit" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (<span id="publish-price"></span> ‚ÇΩ)</button>
            </form>
        </div>
    </template>
    <template id="passenger-request-screen-template">
        <div class="p-5">
            <h2 class="text-lg font-bold mb-4">–í–∞—à–∞ –∑–∞—è–≤–∫–∞</h2>
            <form id="passenger-request-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                        <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                        <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                </div>
                <input type="hidden" name="from" required><input type="hidden" name="to" required>
                <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                <input type="date" name="date" id="date-request" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-2">–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è –≤—ã–µ–∑–¥–∞</label>
                    <div id="time-interval-buttons" class="grid grid-cols-2 sm:grid-cols-4 gap-2">
                        <button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">04-06</button>
                        <button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">06-08</button>
                        <button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">08-10</button>
                        <button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">10-12</button>
                        <button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">12-14</button>
                        <button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">14-16</button>
                        <button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">16-18</button>
                        <button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">18-20</button>
                    </div>
                    <input type="hidden" name="timeInterval" id="timeIntervalInput" required>
                    <div class="form-error-time text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div>
                </div>
                <button type="submit" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            </form>
        </div>
    </template>
    <template id="parcel-request-screen-template">
        <div class="p-5">
            <h2 class="text-lg font-bold mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É</h2>
            <form id="parcel-request-form" class="space-y-4">
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                        <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                        <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                </div>
                <input type="hidden" name="from" required><input type="hidden" name="to" required>
                <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                <div><label for="date-parcel" class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label><input type="date" name="date" id="date-parcel" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div>
                <div id="parcel-price-info" class="bg-slate-100 p-3 rounded-lg text-center text-slate-600 text-sm">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏: <span class="font-bold"></span> ‚ÇΩ</div>
                <button type="submit" class="text-sm btn w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ—Å—ã–ª–∫—É</button>
            </form>
        </div>
    </template>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const App = {
            config: {
                supabaseUrl: 'https://scqkpvmmoaolahpxinja.supabase.co',
                supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjcWtwdm1tb2FvbGFocHhpbmphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDIwNDksImV4cCI6MjA3MTE3ODA0OX0.Uz5L2SF8O1EGf_efkq5FLi6g1yl7LlmnTZi_eLnISMw',
                botToken: '8202443902:AAEMonQpK3FmOAh5Up4GPBmI89q1mHz8LpY',
                prices: { base: 600, parcel: 300, cheboksary: 400, ferrySurcharge: 100 },
                cities: ['–ô–æ—à–∫–∞—Ä-–û–ª–∞', '–ß–µ–±–æ–∫—Å–∞—Ä—ã', '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫'],
            },
            state: {
                currentUser: null,
                userProfile: null,
                userRole: 'passenger',
                navigationHistory: ['passenger-home-screen'],
                allRequests: [],
                currentFilters: { from: '', to: '', date: '', type: 'all' },
            },
            supabaseClient: null,
            
            async init() {
                const initScreen = document.getElementById('init-screen');
                const appContainer = document.getElementById('app-container');
                const loadingHtml = `<div class="p-5 text-center"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-800 mx-auto mt-10"></div><p class="text-slate-500 mt-4">–ó–∞–≥—Ä—É–∑–∫–∞...</p></div>`;
                const errorHtml = `<div class="p-5 text-center"><h3 class="font-bold text-red-600">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è</h3><p class="text-slate-500 mt-2 text-sm">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p><button id="retry-init-btn" class="mt-4 text-sm btn bg-slate-800 text-white font-bold py-2 px-4 rounded-lg">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button></div>`;

                initScreen.innerHTML = loadingHtml;
                appContainer.style.display = 'none';
                initScreen.style.display = 'flex';
                
                this.supabaseClient = supabase.createClient(this.config.supabaseUrl, this.config.supabaseAnonKey);
                
                try {
                    if (window.Telegram && window.Telegram.WebApp) {
                        Telegram.WebApp.ready();
                        Telegram.WebApp.expand();
                        this.state.currentUser = Telegram.WebApp.initDataUnsafe?.user;
                        if (!this.state.currentUser) throw new Error("Telegram user data is not available.");
                    } else {
                       throw new Error("Telegram WebApp script not loaded.");
                    }
                } catch (e) {
                    console.warn("Running in test mode:", e.message);
                    this.state.currentUser = { id: 12345678, first_name: '–¢–µ—Å—Ç', username: 'testuser', photo_url: null };
                }
                
                await this.ensureUserProfile();

                if (this.state.userProfile) {
                    appContainer.style.display = 'flex';
                    initScreen.style.display = 'none';
                    this.render.allScreens(); 
                    this.bindEvents();
                    this.render.updateRoleSwitcherUI();
                    this.render.updateAvatar();
                } else {
                    initScreen.innerHTML = errorHtml;
                    document.getElementById('retry-init-btn')?.addEventListener('click', () => this.init());
                }
            },

            async ensureUserProfile() {
                if (!this.state.currentUser || !this.state.currentUser.id) {
                    console.error("Current user or user ID is missing.");
                    return;
                }

                try {
                    let { data: profile, error } = await this.supabaseClient
                        .from('profiles')
                        .select('*')
                        .eq('id', this.state.currentUser.id)
                        .single();

                    if (error && error.code === 'PGRST116') { // Profile not found, create it
                        const { data: newProfile, error: insertError } = await this.supabaseClient
                            .from('profiles')
                            .insert({ 
                                id: this.state.currentUser.id, 
                                username: this.state.currentUser.username, 
                                full_name: this.state.currentUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' 
                            })
                            .select()
                            .single();
                        
                        if (insertError) {
                            console.error('Supabase insert error:', insertError);
                            if (window.Telegram && window.Telegram.WebApp) {
                                Telegram.WebApp.showAlert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å: ${insertError.message}`);
                            }
                            return;
                        }
                        profile = newProfile;
                    } else if (error) {
                        // For any other select error
                        throw error;
                    }
                    this.state.userProfile = profile;
                } catch (error) {
                     console.error('Supabase fetch/create error:', error);
                     if (window.Telegram && window.Telegram.WebApp) {
                        Telegram.WebApp.showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: ${error.message}`);
                     }
                     this.state.userProfile = null;
                }
            },
            
            // –í–∞–º –Ω—É–∂–Ω–æ –±—É–¥–µ—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å –ø–æ–ª–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –¥–ª—è —ç—Ç–∏—Ö –º–µ—Ç–æ–¥–æ–≤,
            // —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∏ –≤ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–º –∫–æ–¥–µ.
            // –≠—Ç–∏ "–∑–∞–≥–ª—É—à–∫–∏" –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—Ç—è—Ç —Å–±–æ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.
            bindEvents() {
                console.log("bindEvents: Full implementation is needed here.");
            },
            render: {
                allScreens() { console.log("render.allScreens: Full implementation is needed here."); },
                updateRoleSwitcherUI() { console.log("render.updateRoleSwitcherUI: Full implementation is needed here."); },
                updateAvatar() { console.log("render.updateAvatar: Full implementation is needed here."); },
            },
            handlers: {
                 // all event handlers should be here
            },
            navigation: {
                 // all navigation logic should be here
            },
            utils: {
                 // all utility functions should be here
            }
        };

        App.init();
    });
    </script>
</body>
</html>
