<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Попутка 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent; 
            overscroll-behavior-y: contain; 
        }
        .screen { 
            display: none; 
            animation: fadeIn 0.3s ease-in-out; 
        }
        .screen.active { 
            display: block; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(5px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        .toast {
            transform: translateY(150%);
            transition: transform 0.3s ease-out;
            pointer-events: none;
        }
        .toast.show {
            transform: translateY(0);
            pointer-events: auto;
        }
        .notification-badge {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #ef4444; /* red-500 */
            border: 2px solid white;
        }
        .modal-container {
            transition: opacity 0.3s ease;
        }
        .modal-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .modal-container .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal-container.hidden .modal-content {
            transform: scale(0.95);
            opacity: 0;
        }
        .form-error {
            transition: opacity 0.3s;
            opacity: 1;
        }
        .form-error.hidden {
            opacity: 0;
        }
        /* Стиль для активной кнопки в переключателях */
        .role-btn.active {
            background-color: white;
            color: #1e293b; /* slate-800 */
            box-shadow: 0 4px 14px 0 rgb(0 0 0 / 0.05);
        }
        /* Общие стили для кнопок */
        .btn {
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, transform 0.1s ease-in-out;
        }
        .btn:active {
            transform: scale(0.98);
        }
        /* Стиль для отключенных чекбоксов */
        input[type="checkbox"]:disabled + label {
            color: #94a3b8; /* slate-400 */
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">

    <div id="app-container" class="h-screen w-screen max-w-md mx-auto bg-white flex flex-col">
        <!-- Верхний бар -->
        <header id="app-header" class="p-4 flex items-center justify-between bg-white border-b border-slate-200 flex-shrink-0">
            <button id="backButton" class="text-slate-500 hover:text-slate-800 transition-colors invisible">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
            </button>
            <h1 id="headerTitle" class="text-lg font-semibold text-slate-800 text-center flex-grow">Попутка 12</h1>
            <button id="chat-nav-btn" class="text-slate-500 hover:text-slate-800 transition-colors relative">
                <span id="chat-nav-badge" class="notification-badge hidden"></span>
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </button>
        </header>

        <main id="main-content" class="flex-grow overflow-y-auto p-5 relative">
            <!-- Главный экран выбора роли -->
            <div id="main-screen" class="screen active">
                <div class="text-center mb-8">
                    <h2 class="text-2xl font-bold mb-1">Добро пожаловать!</h2>
                    <p class="text-slate-500">Выберите вашу роль</p>
                </div>
                <div id="role-selector" class="mb-6 p-1 bg-slate-100 rounded-xl flex">
                    <button data-role="passenger" class="role-btn btn flex-1 py-3 px-4 rounded-lg font-semibold text-slate-500 transition-colors">Пассажир</button>
                    <button data-role="driver" class="role-btn btn flex-1 py-3 px-4 rounded-lg font-semibold text-slate-500 transition-colors">Водитель</button>
                </div>
                <button id="continue-btn" class="btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700 transition-all disabled:bg-slate-300 disabled:shadow-none disabled:cursor-not-allowed" disabled>Продолжить</button>
            </div>

            <!-- Экран выбора маршрута -->
            <div id="route-selection-screen" class="screen"></div>

            <!-- Экран пассажира -->
            <div id="passenger-home-screen" class="screen"></div>
            
            <!-- Экран водителя (Дашборд) -->
            <div id="driver-dashboard-screen" class="screen"></div>

            <!-- Экран Мои Пассажиры/Посылки (Водитель) -->
            <div id="my-items-screen" class="screen"></div>

            <!-- Экран формы: Предложение поездки (Водитель) -->
            <div id="offer-screen" class="screen"></div>
            
            <!-- Экран формы: Заявка на поездку (Пассажир) -->
            <div id="passenger-request-screen" class="screen"></div>
            
            <!-- Экран формы: Заявка на посылку (Пассажир) -->
            <div id="parcel-request-screen" class="screen"></div>

            <!-- Экран списка -->
            <div id="list-screen" class="screen"></div>
            
             <!-- Экран списка чатов -->
            <div id="chat-list-screen" class="screen"></div>

            <!-- Экран успеха -->
            <div id="success-screen" class="screen"></div>
        </main>
        
        <!-- Отдельный контейнер для чата -->
        <div id="chat-room-screen" class="screen flex-col h-full"></div>

        <!-- Модальное окно "Добавить на главный экран" -->
        <div id="a2hs-modal" class="modal-container fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50 hidden">
            <div class="modal-content bg-white rounded-2xl p-6 shadow-xl max-w-sm w-full text-center relative">
                <div id="modal-initial-view">
                    <div class="mx-auto bg-slate-100 h-16 w-16 flex items-center justify-center rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-600"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    </div>
                    <h3 class="text-lg font-bold mb-2">Быстрый доступ</h3>
                    <p class="text-slate-600 text-sm mb-6">Добавьте иконку приложения на главный экран для быстрого запуска.</p>
                    <button id="a2hs-show-instructions-btn" class="btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700 transition-colors mb-4">Показать как</button>
                    <div class="flex items-center justify-center">
                        <input type="checkbox" id="a2hs-dont-show-again" class="h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500">
                        <label for="a2hs-dont-show-again" class="ml-2 block text-sm text-slate-700">Больше не показывать</label>
                    </div>
                </div>
                <div id="modal-instruction-view" class="hidden text-left">
                     <h3 class="text-lg font-bold mb-4 text-center">Как добавить на экран</h3>
                     <p class="text-sm text-slate-700 mb-2"><b>Для iOS (Safari):</b></p>
                     <p class="text-sm text-slate-600 mb-4">Нажмите "Поделиться" <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block -mt-1"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>, затем "На экран 'Домой'".</p>
                     <p class="text-sm text-slate-700 mb-2"><b>Для Android (Chrome):</b></p>
                     <p class="text-sm text-slate-600 mb-4">Нажмите три точки <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="inline-block -mt-1"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>, затем "Добавить на главный экран".</p>
                     <button id="a2hs-got-it-btn" class="btn w-full bg-slate-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition-colors">Понятно</button>
                </div>
            </div>
        </div>

        <div id="toast" class="toast fixed bottom-6 left-1/2 -translate-x-1/2 w-11/12 max-w-sm p-4 rounded-lg shadow-lg text-white text-center z-50"><p id="toast-message"></p></div>
    </div>
    
    <script>
    const App = {
        state: {
            rideOffers: [ 
                { id: 1, from: 'Козьмодемьянск', to: 'Йошкар-Ола', date: '2025-08-18', time: '08:30', seats: 2, price: 600, driver: { name: 'Алексей', car: 'Kia Rio' }, toCheboksary: true, passengers: [], parcels: [], viaFerry: false, takesParcel: true }, 
                { id: 2, from: 'Йошкар-Ола', to: 'Козьмодемьянск', date: '2025-08-18', time: '12:30', seats: 3, price: 700, driver: { name: 'Елена', car: 'Hyundai Solaris' }, toCheboksary: false, passengers: [], parcels: [], viaFerry: true, takesParcel: false }, 
            ],
            rideRequests: [ 
                { id: 1, from: 'Козьмодемьянск', to: 'Йошкар-Ола', date: '2025-08-19', timeInterval: '06:00-08:00', passenger: { name: 'Мария' }, toCheboksary: true, price: 400, viaFerry: false }, 
            ],
            parcelRequests: [
                { id: 1, from: 'Козьмодемьянск', to: 'Йошкар-Ола', date: '2025-08-20', senderName: 'Отправитель', price: 300 },
            ],
            chats: {}, 
            unreadChats: {}, 
            navigationHistory: [], 
            userRole: null, 
            currentUser: null,
            currentChatPartner: null, 
            selectedRoute: null, 
            toastTimeout: null,
        },

        init() {
            try { 
                Telegram.WebApp.ready(); 
                Telegram.WebApp.expand(); 
                this.state.currentUser = Telegram.WebApp.initDataUnsafe?.user;
            } catch(e) { 
                console.warn("Telegram WebApp script not found or running in browser."); 
                this.state.currentUser = { id: 12345, first_name: 'Тест', username: 'testuser' };
            }
            
            this.render.allScreens();
            this.bindEvents();
            this.setDefaultDates();
            this.a2hsModal.init();
        },

        setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            ['date-offer', 'date-request', 'date-parcel'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.setAttribute('min', today);
                    input.value = today;
                }
            });
        },
        
        bindEvents() {
            document.getElementById('role-selector').addEventListener('click', (e) => {
                const target = e.target.closest('.role-btn');
                if (!target) return;

                document.querySelectorAll('#role-selector .role-btn').forEach(btn => btn.classList.remove('active'));
                target.classList.add('active');
                this.state.userRole = target.dataset.role;
                document.getElementById('continue-btn').disabled = false;
            });

            document.getElementById('continue-btn').addEventListener('click', () => {
                if (this.state.userRole) {
                    this.navigation.to('route-selection-screen', 'Выберите маршрут');
                }
            });

            document.getElementById('backButton').addEventListener('click', () => this.navigation.back());
            
            document.body.addEventListener('click', (e) => {
                const target = e.target;
                const handlers = {
                    'select-route-koz-yo': this.handlers.onRouteSelect,
                    'view-driver-offers-btn': this.handlers.onViewDriverOffers,
                    'create-passenger-request-btn': () => this.navigation.to('passenger-request-screen', 'Заявка на поездку'),
                    'send-parcel-btn': () => this.navigation.to('parcel-request-screen', 'Отправить посылку'),
                    'view-passenger-requests-btn': this.handlers.onViewPassengerRequests,
                    'publish-ride-btn': () => this.navigation.to('offer-screen', 'Новая поездка'),
                    'view-my-items-btn': this.handlers.onViewMyItems,
                    'back-to-hub-btn': () => {
                        const screen = this.state.userRole === 'driver' ? 'driver-dashboard-screen' : 'passenger-home-screen';
                        const title = this.state.userRole === 'driver' ? 'Кабинет водителя' : 'Пассажир';
                        this.navigation.to(screen, title);
                    },
                    'agreement-btn': this.handlers.onAgreementClick,
                };
                if (handlers[target.id]) handlers[target.id].call(this, e);
                
                if (target.closest('.delete-passenger-btn')) this.handlers.onDeletePassenger(e);
                if (target.closest('.delete-parcel-btn')) this.handlers.onDeleteParcel(e);
                if (target.closest('#chat-nav-btn')) this.navigation.to('chat-list-screen', 'Чаты');
                if (target.closest('#time-interval-buttons')) this.handlers.onTimeIntervalSelect.call(this, e);
                if (target.closest('.direction-buttons')) this.handlers.onDirectionSelect.call(this, e);
                if (target.closest('#list-container')) this.handlers.onContactClick.call(this, e);
                if (target.closest('#chat-list-container')) this.handlers.onChatSelect.call(this, e);
            });

            document.body.addEventListener('submit', (e) => {
                e.preventDefault();
                const targetId = e.target.id;
                const handlers = {
                    'passenger-request-form': this.handlers.onPassengerRequestSubmit,
                    'parcel-request-form': this.handlers.onParcelRequestSubmit,
                    'offer-form': this.handlers.onOfferSubmit,
                    'chat-form': this.handlers.onSendMessage
                };
                if (handlers[targetId]) handlers[targetId].call(this, e);
            });

            document.body.addEventListener('change', (e) => {
                if (e.target.classList.contains('route-option-checkbox')) {
                    this.handlers.onRouteOptionToggle(e);
                }
            });
        },

        handlers: {
            onRouteSelect(e) {
                const button = e.target.closest('button');
                if (!button) return;
                this.state.selectedRoute = {
                    from: button.dataset.from,
                    to: button.dataset.to
                };
                if (this.state.userRole === 'passenger') {
                    this.navigation.to('passenger-home-screen', 'Пассажир');
                } else {
                    this.navigation.to('driver-dashboard-screen', 'Кабинет водителя');
                }
            },
            onRouteOptionToggle(e) {
                const checkbox = e.target;
                const form = checkbox.closest('form');
                const cheboksaryCheckbox = form.querySelector('input[name="toCheboksary"]');
                const ferryCheckbox = form.querySelector('input[name="viaFerry"]');
                const parcelCheckbox = form.querySelector('input[name="takesParcel"]');

                if (checkbox === cheboksaryCheckbox || checkbox === ferryCheckbox) {
                    if (checkbox.checked) {
                        if (checkbox === cheboksaryCheckbox) ferryCheckbox.disabled = true;
                        if (checkbox === ferryCheckbox) cheboksaryCheckbox.disabled = true;
                    } else {
                        cheboksaryCheckbox.disabled = false;
                        ferryCheckbox.disabled = false;
                    }
                }
                
                if (form.id === 'offer-form') {
                    const ferryPriceLabel = form.querySelector('#ferry-price-label');
                    const parcelPriceLabel = form.querySelector('#parcel-price-label');
                    const submitButton = form.querySelector('button[type="submit"]');

                    ferryPriceLabel.textContent = ferryCheckbox.checked ? '(+100 ₽)' : '';
                    parcelPriceLabel.textContent = parcelCheckbox.checked ? '(+300 ₽)' : '';

                    let basePrice = 600;
                    if (ferryCheckbox.checked) {
                        basePrice = 700;
                    }
                    submitButton.textContent = `Опубликовать (${basePrice} ₽)`;
                }
            },
            onDirectionSelect(e) { 
                const button = e.target.closest('button'); 
                if (!button) return; 
                const form = button.closest('form'); 
                const errorEl = form.querySelector('.form-error-direction'); 
                if (errorEl) errorEl.classList.add('hidden'); 
                const container = button.parentElement; 
                container.querySelectorAll('button').forEach(btn => btn.classList.remove('active')); 
                button.classList.add('active'); 
                form.querySelector('input[name="from"]').value = button.dataset.from; 
                form.querySelector('input[name="to"]').value = button.dataset.to; 
            },
            onTimeIntervalSelect(e) { if (e.target.tagName === 'BUTTON') { const form = e.target.closest('form'); const errorEl = form.querySelector('.form-error-time'); if (errorEl) errorEl.classList.add('hidden'); document.querySelectorAll('#time-interval-buttons button').forEach(btn => btn.classList.remove('bg-slate-800', 'text-white')); e.target.classList.add('bg-slate-800', 'text-white'); document.getElementById('timeIntervalInput').value = e.target.textContent; } },
            onViewDriverOffers() { this.render.list(this.state.rideOffers, 'driverOffer'); this.navigation.to('list-screen', 'Поездки водителей'); },
            onViewPassengerRequests() { 
                const allRequests = [...this.state.rideRequests, ...this.state.parcelRequests];
                allRequests.sort((a,b) => new Date(a.date) - new Date(b.date));
                this.render.list(allRequests, 'passengerRequest'); 
                this.navigation.to('list-screen', 'Заявки от пассажиров'); 
            },
            onPassengerRequestSubmit(e) { const form = e.target; const formData = new FormData(form); let valid = true; if (!formData.get('from')) { form.querySelector('.form-error-direction').classList.remove('hidden'); valid = false; } if (!formData.get('timeInterval')) { form.querySelector('.form-error-time').classList.remove('hidden'); valid = false; } if (!formData.get('passengerName').trim()) { valid = false; this.showToast('Пожалуйста, укажите ваше имя', 'error'); } if (!valid) return; const toCheboksary = form.querySelector('input[name="toCheboksary"]').checked; const viaFerry = form.querySelector('input[name="viaFerry"]').checked; let price = 600; if (toCheboksary) { price = 400; } else if (viaFerry) { price = 700; } const newRequest = { id: this.state.rideRequests.length + 1, from: formData.get('from'), to: formData.get('to'), date: formData.get('date'), timeInterval: formData.get('timeInterval'), passenger: { name: formData.get('passengerName') }, toCheboksary, viaFerry, price }; this.state.rideRequests.push(newRequest); this.resetForm(form); this.render.success('Заявка создана', 'Водители скоро увидят вашу заявку.', 'Отлично'); },
            onParcelRequestSubmit(e) { const form = e.target; const formData = new FormData(form); if (!formData.get('from')) { form.querySelector('.form-error-direction').classList.remove('hidden'); return; } const newRequest = { id: this.state.parcelRequests.length + 1, from: formData.get('from'), to: formData.get('to'), date: formData.get('date'), senderName: 'Отправитель', price: 300 }; this.state.parcelRequests.push(newRequest); this.resetForm(form); this.render.success('Заявка на посылку создана', 'Водители увидят вашу заявку.', 'Отлично'); },
            onOfferSubmit(e) { const form = e.target; const formData = new FormData(form); if (!formData.get('from')) { form.querySelector('.form-error-direction').classList.remove('hidden'); return; } if (!formData.get('driverName').trim() || !formData.get('driverCar').trim()) { this.showToast('Укажите имя и машину', 'error'); return; } const toCheboksary = form.querySelector('input[name="toCheboksary"]').checked; const viaFerry = form.querySelector('input[name="viaFerry"]').checked; const takesParcel = form.querySelector('input[name="takesParcel"]').checked; let price = 600; if (viaFerry) { price = 700; } const newOffer = { id: this.state.rideOffers.length + 1, from: formData.get('from'), to: formData.get('to'), date: formData.get('date'), time: formData.get('time'), seats: parseInt(formData.get('seats')), price, driver: { name: formData.get('driverName'), car: formData.get('driverCar') }, toCheboksary, viaFerry, takesParcel, passengers: [], parcels: [] }; this.state.rideOffers.push(newOffer); this.resetForm(form); this.render.success('Поездка опубликована', 'Пассажиры теперь видят ваше предложение.', 'В кабинет'); },
            onContactClick(e) { 
                const contactButton = e.target.closest('.contact-btn'); 
                if (!contactButton) return; 
                const partnerName = contactButton.dataset.driverName || contactButton.dataset.passengerName; 
                if (!partnerName) return; 
                
                const isParcel = contactButton.dataset.type === 'parcel';
                let chatTitle = `Чат с ${partnerName}`;
                if (isParcel) {
                    chatTitle = 'Чат с отправителем';
                }

                if (!this.state.chats[partnerName]) { 
                    this.state.chats[partnerName] = { 
                        messages: [], 
                        agreement: { me: false, other: false },
                        timerId: null,
                        timerEndTime: null,
                        timerExpired: false,
                        isParcelChat: isParcel
                    };
                } 
                this.state.currentChatPartner = partnerName; 
                this.navigation.to('chat-room-screen', chatTitle); 
            },
            onChatSelect(e) { 
                const chatItem = e.target.closest('.chat-item'); 
                if (!chatItem) return; 
                const partnerName = chatItem.dataset.partnerName; 
                
                let chatTitle = `Чат с ${partnerName}`;
                if (this.state.chats[partnerName] && this.state.chats[partnerName].isParcelChat) {
                    chatTitle = 'Чат с отправителем';
                }

                this.state.currentChatPartner = partnerName; 
                this.navigation.to('chat-room-screen', chatTitle); 
            },
            onSendMessage(e) { 
                const input = document.getElementById('chat-input'); 
                const text = input.value.trim(); 
                const partnerName = this.state.currentChatPartner; 
                if (text && partnerName) { 
                    this.state.chats[partnerName].messages.push({ sender: 'me', text }); 
                    input.value = ''; 
                    this.render.chatRoom(partnerName); 
                    this.chat.checkAndStartTimer(partnerName);
                    setTimeout(() => { this.receiveMessage(partnerName, "Да, конечно. Во сколько?"); }, 2000); 
                } 
            },
            onAgreementClick() {
                const partnerName = this.state.currentChatPartner;
                if (!partnerName) return;
                const chat = this.state.chats[partnerName];
                chat.agreement.me = true;

                // Имитация подтверждения от другого пользователя
                setTimeout(() => {
                    chat.agreement.other = true;
                    this.chat.finalizeAgreement(partnerName);
                    this.render.chatRoom(partnerName);
                }, 2000);

                this.render.chatRoom(partnerName);
            },
            onViewMyItems() {
                this.render.myPassengersAndParcelsList();
                this.navigation.to('my-items-screen', 'Мои пассажиры/посылки');
            },
            onDeletePassenger(e) {
                const button = e.target.closest('.delete-passenger-btn');
                const { offerId, passengerId } = button.dataset;
                const offer = this.state.rideOffers.find(o => o.id == offerId);
                if (offer) {
                    offer.passengers = offer.passengers.filter(p => p.id != passengerId);
                    offer.seats++;
                    this.render.myPassengersAndParcelsList(); 
                }
            },
            onDeleteParcel(e) {
                const button = e.target.closest('.delete-parcel-btn');
                const { offerId, parcelId } = button.dataset;
                const offer = this.state.rideOffers.find(o => o.id == offerId);
                if (offer) {
                    offer.parcels = offer.parcels.filter(p => p.id != parcelId);
                    this.render.myPassengersAndParcelsList();
                }
            }
        },
        
        receiveMessage(partnerName, text) { 
            if (!this.state.chats[partnerName]) {
                this.state.chats[partnerName] = { 
                    messages: [], 
                    agreement: { me: false, other: false },
                    timerId: null,
                    timerEndTime: null,
                    timerExpired: false
                };
            }
            this.state.chats[partnerName].messages.push({ sender: 'other', text }); 
            const currentScreen = document.querySelector('.screen.active'); 
            if (currentScreen.id === 'chat-room-screen' && this.state.currentChatPartner === partnerName) { 
                this.render.chatRoom(partnerName); 
            } else { 
                this.state.unreadChats[partnerName] = true; 
                this.render.updateNavBadge(); 
            }
            this.chat.checkAndStartTimer(partnerName);
        },

        chat: {
            finalizeAgreement(partnerName) {
                const chat = App.state.chats[partnerName];
                const offer = App.state.rideOffers.find(o => (chat.isParcelChat ? o.takesParcel : o.seats > 0));
                
                if (offer) {
                    let agreementText = '';

                    if (chat.isParcelChat) {
                        agreementText = `Вы договорились о доставке посылки ${offer.from} - ${offer.to} на ${new Date(offer.date).toLocaleDateString('ru-RU')}.`;
                        if (!offer.parcels) offer.parcels = [];
                        offer.parcels.push({ id: Date.now(), name: partnerName });
                    } else {
                        offer.passengers.push({ id: Date.now(), name: partnerName });
                        offer.seats--;
                        agreementText = `Вы договорились о поездке ${offer.from} - ${offer.to} на ${new Date(offer.date).toLocaleDateString('ru-RU')}.`;
                    }
                    
                    chat.messages.push({
                        sender: 'system',
                        text: agreementText
                    });

                } else {
                     chat.messages.push({
                        sender: 'system',
                        text: `Не удалось найти подходящую поездку.`
                    });
                }
            },
            checkAndStartTimer(partnerName) {
                const chat = App.state.chats[partnerName];
                if (chat.timerId || chat.timerExpired) return;

                const hasMyMessage = chat.messages.some(m => m.sender === 'me');
                const hasOtherMessage = chat.messages.some(m => m.sender === 'other');

                if (hasMyMessage && hasOtherMessage) {
                    chat.timerEndTime = Date.now() + 15 * 60 * 1000;
                    chat.messages.push({
                        sender: 'system',
                        text: 'У вас есть 15 минут, чтобы договориться о поездке.'
                    });

                    chat.timerId = setInterval(() => {
                        App.chat.updateTimer(partnerName);
                    }, 1000);

                    if (document.querySelector('#chat-room-screen.active') && App.state.currentChatPartner === partnerName) {
                        App.render.chatRoom(partnerName);
                    }
                }
            },
            updateTimer(partnerName) {
                const chat = App.state.chats[partnerName];
                if (!chat || !chat.timerEndTime || chat.timerExpired) {
                    if(chat && chat.timerId) clearInterval(chat.timerId);
                    return;
                }

                const remaining = chat.timerEndTime - Date.now();
                const timerEl = document.getElementById('agreement-timer');

                if (remaining <= 0) {
                    clearInterval(chat.timerId);
                    chat.timerId = null;
                    chat.timerExpired = true;
                    chat.messages.push({
                        sender: 'system',
                        text: 'Время вышло! Поездка считается отмененной.'
                    });
                    
                    if (document.querySelector('#chat-room-screen.active') && App.state.currentChatPartner === partnerName) {
                        App.render.chatRoom(partnerName);
                    }
                } else {
                    if (timerEl) {
                        const minutes = Math.floor((remaining / 1000) / 60);
                        const seconds = Math.floor((remaining / 1000) % 60);
                        timerEl.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    }
                }
            }
        },

        navigation: {
            to(screenId, title) {
                const currentScreenEl = document.querySelector('.screen.active');
                if (currentScreenEl) {
                    this.history.push({ id: currentScreenEl.id, title: document.getElementById('headerTitle').textContent });
                }

                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                document.getElementById('headerTitle').textContent = title;
                document.getElementById('backButton').classList.toggle('invisible', this.history.length === 0);
                
                if (screenId === 'passenger-request-screen' || screenId === 'offer-screen') {
                    App.render.populateUserData(screenId);
                }
                if (screenId === 'driver-dashboard-screen') App.render.driverDashboard();
            },
            back() {
                const lastScreen = this.history.pop();
                if (lastScreen) {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(lastScreen.id).classList.add('active');
                    document.getElementById('headerTitle').textContent = lastScreen.title;
                }
                document.getElementById('backButton').classList.toggle('invisible', this.history.length === 0);
            },
            history: []
        },

        render: {
            allScreens() {
                const templates = {
                    'route-selection-screen': `<div class="text-center mb-8"><h2 class="text-2xl font-bold mb-1">Выберите маршрут</h2></div><div class="space-y-4"><button id="select-route-koz-yo" data-from="Козьмодемьянск" data-to="Йошкар-Ола" class="btn w-full bg-slate-800 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">Козьмодемьянск &lt;—&gt; Йошкар-Ола</button></div>`,
                    'passenger-home-screen': `<div class="text-center mb-6"><h2 class="text-2xl font-bold mb-1">Что вы хотите сделать?</h2></div><div class="space-y-3"><button id="view-driver-offers-btn" class="btn w-full bg-slate-800 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">Смотреть поездки водителей</button><button id="create-passenger-request-btn" class="btn w-full bg-slate-100 text-slate-800 font-bold py-4 px-4 rounded-xl hover:bg-slate-200">Оставить заявку на поездку</button><button id="send-parcel-btn" class="btn w-full bg-purple-100 text-purple-800 font-bold py-4 px-4 rounded-xl hover:bg-purple-200">Отправить посылку</button></div>`,
                    'driver-dashboard-screen': `<div class="text-center mb-6"><h2 class="text-2xl font-bold mb-1">Кабинет водителя</h2></div><div id="driver-dashboard-buttons" class="space-y-3"></div>`,
                    'my-items-screen': `<div id="my-items-list" class="space-y-4"></div>`,
                    'offer-screen': `<h2 class="text-xl font-bold mb-4">Данные о поездке</h2><form id="offer-form" class="space-y-4"><div><label class="block text-sm font-medium text-slate-600 mb-2">Направление</label><div class="direction-buttons p-1 bg-slate-100 rounded-xl flex"><button type="button" data-from="Козьмодемьянск" data-to="Йошкар-Ола" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">КЗМ → ЙО</button><button type="button" data-from="Йошкар-Ола" data-to="Козьмодемьянск" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">ЙО → КЗМ</button></div><input type="hidden" name="from" required><input type="hidden" name="to" required></div><div class="space-y-2"> <div class="flex items-center"><input id="offer-cheboksary" name="toCheboksary" type="checkbox" class="route-option-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500"><label for="offer-cheboksary" class="ml-2 block text-sm text-slate-700">До Чебоксар (400 ₽)</label></div><div class="flex items-center"><input id="offer-ferry" name="viaFerry" type="checkbox" class="route-option-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500"><label for="offer-ferry" class="ml-2 block text-sm text-slate-700">Через паром <span id="ferry-price-label" class="font-semibold text-blue-600"></span></label></div><div class="flex items-center"><input id="offer-parcel" name="takesParcel" type="checkbox" class="route-option-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500"><label for="offer-parcel" class="ml-2 block text-sm text-slate-700">Возьму посылку <span id="parcel-price-label" class="font-semibold text-purple-600"></span></label></div></div><div class="grid grid-cols-2 gap-4"><div><label for="date-offer" class="block text-sm font-medium text-slate-600 mb-2">Дата</label><input type="date" name="date" id="date-offer" class="w-full p-3 border border-slate-200 rounded-lg" required></div><div><label for="time-offer" class="block text-sm font-medium text-slate-600 mb-2">Время</label><input type="time" name="time" id="time-offer" class="w-full p-3 border border-slate-200 rounded-lg" required></div></div><div class="grid grid-cols-2 gap-4"><div><label for="driver-name" class="block text-sm font-medium text-slate-600 mb-2">Ваше имя</label><input type="text" name="driverName" id="driver-name" class="w-full p-3 border border-slate-200 rounded-lg" placeholder="Алексей" required></div><div><label for="driver-car" class="block text-sm font-medium text-slate-600 mb-2">Марка машины</label><input type="text" name="driverCar" id="driver-car" class="w-full p-3 border border-slate-200 rounded-lg" placeholder="Kia Rio" required></div></div><div><label class="block text-sm font-medium text-slate-600 mb-2">Количество мест</label><input type="number" name="seats" min="1" max="8" class="w-full p-3 border border-slate-200 rounded-lg" placeholder="Например: 3" required></div><div class="form-error-direction text-red-500 text-sm text-center mb-2 hidden">Пожалуйста, выберите направление</div><button type="submit" class="btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">Опубликовать (600 ₽)</button></form>`,
                    'passenger-request-screen': `<h2 class="text-xl font-bold mb-4">Ваша заявка</h2><form id="passenger-request-form" class="space-y-4"><div><label class="block text-sm font-medium text-slate-600 mb-2">Направление</label><div class="direction-buttons p-1 bg-slate-100 rounded-xl flex"><button type="button" data-from="Козьмодемьянск" data-to="Йошкар-Ола" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">КЗМ → ЙО</button><button type="button" data-from="Йошкар-Ола" data-to="Козьмодемьянск" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">ЙО → КЗМ</button></div><input type="hidden" name="from" required><input type="hidden" name="to" required></div><div class="form-error-direction text-red-500 text-sm text-center -mt-2 mb-2 hidden">Пожалуйста, выберите направление</div><div class="space-y-2"><div class="flex items-center"><input id="request-cheboksary" name="toCheboksary" type="checkbox" class="route-option-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500"><label for="request-cheboksary" class="ml-2 block text-sm text-slate-700">Нужно до/из Чебоксар</label></div><div class="flex items-center"><input id="request-ferry" name="viaFerry" type="checkbox" class="route-option-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500"><label for="request-ferry" class="ml-2 block text-sm text-slate-700">Нужно через паром</label></div></div><input type="date" name="date" id="date-request" class="w-full p-3 border border-slate-200 rounded-lg" required><div><label for="passenger-name" class="block text-sm font-medium text-slate-600 mb-2">Ваше имя</label><input type="text" name="passengerName" id="passenger-name" class="w-full p-3 border border-slate-200 rounded-lg" placeholder="Мария" required></div><div><label class="block text-sm font-medium text-slate-600 mb-2">Желаемое время выезда</label><div id="time-interval-buttons" class="grid grid-cols-2 sm:grid-cols-4 gap-2"><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">04-06</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">06-08</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">08-10</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">10-12</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">12-14</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">14-16</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">16-18</button><button type="button" class="btn p-2 border border-slate-200 rounded-lg text-sm">18-20</button></div><input type="hidden" name="timeInterval" id="timeIntervalInput" required></div><div class="form-error-time text-red-500 text-sm text-center -mt-2 mb-2 hidden">Пожалуйста, выберите время</div><button type="submit" class="btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">Оставить заявку</button></form>`,
                    'parcel-request-screen': `<h2 class="text-xl font-bold mb-4">Отправить посылку</h2><form id="parcel-request-form" class="space-y-4"><div><label class="block text-sm font-medium text-slate-600 mb-2">Направление</label><div class="direction-buttons p-1 bg-slate-100 rounded-xl flex"><button type="button" data-from="Козьмодемьянск" data-to="Йошкар-Ола" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">КЗМ → ЙО</button><button type="button" data-from="Йошкар-Ола" data-to="Козьмодемьянск" class="role-btn btn flex-1 py-3 px-2 rounded-lg font-semibold text-slate-500 transition-colors text-center text-sm">ЙО → КЗМ</button></div><input type="hidden" name="from" required><input type="hidden" name="to" required></div><div class="form-error-direction text-red-500 text-sm text-center -mt-2 mb-2 hidden">Пожалуйста, выберите направление</div><div><label for="date-parcel" class="block text-sm font-medium text-slate-600 mb-2">Дата отправки</label><input type="date" name="date" id="date-parcel" class="w-full p-3 border border-slate-200 rounded-lg" required></div><div class="bg-slate-100 p-3 rounded-lg text-center text-slate-600">Стоимость отправки: <span class="font-bold">300 ₽</span></div><button type="submit" class="btn w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">Создать заявку на посылку</button></form>`,
                    'list-screen': `<div id="list-container" class="space-y-3"></div><div id="no-results" class="text-center text-slate-500 py-10 hidden"><h3 id="no-results-title" class="text-lg font-semibold"></h3><p id="no-results-text" class="text-sm"></p></div>`,
                    'chat-list-screen': `<div id="chat-list-container" class="space-y-2"></div><div id="no-chats" class="text-center text-slate-500 py-10 hidden"><h3 class="text-lg font-semibold">У вас пока нет чатов</h3><p class="text-sm">Начните диалог со страницы поездки.</p></div>`,
                    'success-screen': `<div class="flex flex-col items-center justify-center h-full text-center"><div class="mb-4"><svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><h2 id="success-title" class="text-2xl font-bold mt-4 mb-1"></h2><p id="success-text" class="text-slate-600 mb-8"></p><button id="back-to-hub-btn" class="btn w-full max-w-xs bg-slate-800 text-white font-bold py-3 px-4 rounded-lg"></button></div>`,
                    'chat-room-screen': `<div id="chat-messages" class="flex-grow p-4 space-y-4 overflow-y-auto"></div><div id="agreement-container" class="p-4 border-t border-slate-200"></div><form id="chat-form" class="flex-shrink-0 p-4 border-t border-slate-200 flex items-center space-x-2"><input type="text" id="chat-input" class="w-full p-3 border border-slate-200 rounded-lg focus:ring-2 focus:ring-slate-400 focus:border-slate-400 outline-none" placeholder="Напишите сообщение..." required autocomplete="off"><button type="submit" class="btn p-3 bg-slate-800 text-white rounded-lg hover:bg-slate-700 flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button></form>`,
                };
                for (const [id, html] of Object.entries(templates)) {
                    const el = document.getElementById(id);
                    if (el) el.innerHTML = html;
                }
            },
            driverDashboard() {
                const container = document.getElementById('driver-dashboard-buttons');
                const hasItems = App.state.rideOffers.some(o => o.passengers.length > 0 || (o.parcels && o.parcels.length > 0));
                
                let buttonsHTML = `
                    <button id="view-passenger-requests-btn" class="btn w-full bg-slate-800 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">Смотреть заявки</button>
                    <button id="publish-ride-btn" class="btn w-full bg-slate-100 text-slate-800 font-bold py-4 px-4 rounded-xl hover:bg-slate-200">Опубликовать свою поездку</button>
                `;

                if (hasItems) {
                    buttonsHTML += `<button id="view-my-items-btn" class="btn w-full bg-green-600 text-white font-bold py-4 px-4 rounded-xl shadow-lg shadow-green-600/10 hover:bg-green-700">Мои пассажиры/посылки</button>`;
                }
                container.innerHTML = buttonsHTML;
            },
            myPassengersAndParcelsList() {
                const container = document.getElementById('my-items-list');
                const offersWithItems = App.state.rideOffers.filter(o => o.passengers.length > 0 || (o.parcels && o.parcels.length > 0));

                if (offersWithItems.length === 0) {
                    container.innerHTML = `<div class="text-center text-slate-500 py-10"><h3 class="text-lg font-semibold">У вас пока нет пассажиров или посылок</h3><p class="text-sm">Договоритесь о поездке в чате, чтобы они появились здесь.</p></div>`;
                    return;
                }

                container.innerHTML = offersWithItems.map(offer => {
                    const passengersHTML = offer.passengers.length > 0 ? `
                        <div class="pt-3 space-y-2">
                           ${offer.passengers.map(p => `
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-slate-400"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>${p.name}</span>
                                    <button class="delete-passenger-btn btn text-red-500 hover:text-red-700 text-sm font-semibold" data-offer-id="${offer.id}" data-passenger-id="${p.id}">Удалить</button>
                                </div>
                           `).join('')}
                        </div>
                    ` : '';

                    const parcelsHTML = offer.parcels && offer.parcels.length > 0 ? `
                        <div class="pt-3 space-y-2">
                           ${offer.parcels.map(p => `
                                <div class="flex items-center justify-between">
                                    <span class="text-slate-700 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 text-slate-400"><path d="M21 10V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16v-2" /><polyline points="3.27 6.96 12 12.01 20.73 6.96" /><line x1="12" y1="22.08" x2="12" y2="12" /></svg>Посылка от: ${p.name}</span>
                                    <button class="delete-parcel-btn btn text-red-500 hover:text-red-700 text-sm font-semibold" data-offer-id="${offer.id}" data-parcel-id="${p.id}">Удалить</button>
                                </div>
                           `).join('')}
                        </div>
                    ` : '';

                    return `
                    <div class="bg-white border border-slate-200 rounded-xl p-4">
                        <div class="pb-3 border-b border-slate-100">
                           <p class="font-semibold text-lg">${offer.from} → ${offer.to}</p>
                           <p class="text-sm text-slate-500">${new Date(offer.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })} в ${offer.time}</p>
                        </div>
                        ${passengersHTML}
                        ${parcelsHTML}
                    </div>
                `}).join('');
            },
            list(items, type) { const container = document.getElementById('list-container'); const noResultsEl = document.getElementById('no-results'); container.innerHTML = ''; const route = App.state.selectedRoute; if (!route) return; const filteredItems = items.filter(item => { const from = item.from.toLowerCase(); const to = item.to.toLowerCase(); const routeFrom = route.from.toLowerCase(); const routeTo = route.to.toLowerCase(); const cheboksary = 'чебоксары'; return (from.includes(routeFrom) || from.includes(routeTo) || from.includes(cheboksary)) && (to.includes(routeFrom) || to.includes(routeTo) || to.includes(cheboksary)); }); filteredItems.sort((a, b) => { const timeA = a.time || a.timeInterval?.split('-')[0] || '00:00'; const timeB = b.time || b.timeInterval?.split('-')[0] || '00:00'; return new Date(`${a.date}T${timeA}`) - new Date(`${b.date}T${timeB}`); }); noResultsEl.classList.toggle('hidden', filteredItems.length > 0); if (type === 'driverOffer') { document.getElementById('no-results-title').textContent = 'Свободных поездок нет'; document.getElementById('no-results-text').textContent = 'Оставьте заявку, и водители вас найдут.'; } else if (type === 'passengerRequest') { document.getElementById('no-results-title').textContent = 'Заявок от пассажиров нет'; document.getElementById('no-results-text').textContent = 'Как только появятся заявки, вы увидите их здесь.'; } filteredItems.forEach(item => { let cardHTML = ''; if (type === 'driverOffer') { let rideDetails = ''; if (item.toCheboksary) { rideDetails += '<p class="text-xs text-green-600 font-medium">До Чебоксар (400 ₽)</p>'; } if (item.viaFerry) { rideDetails += '<p class="text-xs text-blue-600 font-medium">Через паром</p>'; } if (item.takesParcel) { rideDetails += '<p class="text-xs text-purple-600 font-medium">Возьму посылку (+300 ₽)</p>'; } cardHTML = `<div class="bg-white border border-slate-200 rounded-xl p-4"><div class="flex justify-between items-start mb-3"><div><p class="font-semibold text-lg">${item.from} → ${item.to}</p>${rideDetails}<p class="text-sm text-slate-500 mt-1">${new Date(item.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })} в ${item.time}</p></div><p class="font-bold text-lg text-slate-800">${item.price} ₽</p></div><div class="flex justify-between items-center text-sm text-slate-600 pt-3 border-t border-slate-100"><span>${item.driver.name} на ${item.driver.car}</span><span class="bg-slate-100 text-slate-800 font-medium px-3 py-1 rounded-full">Мест: ${item.seats}</span></div><button class="contact-btn btn w-full mt-4 bg-slate-800 text-white font-semibold py-2 rounded-lg hover:bg-slate-700" data-driver-name="${item.driver.name}">Связаться</button></div>`; } else if (type === 'passengerRequest') { if (item.passenger) { cardHTML = `<div class="bg-white border border-slate-200 rounded-xl p-4"><div class="flex justify-between items-start mb-3"><div><p class="font-semibold text-lg">${item.from} → ${item.to}</p>${item.toCheboksary ? '<p class="text-xs text-green-600 font-medium">до/из Чебоксар</p>' : ''}${item.viaFerry ? '<p class="text-xs text-blue-600 font-medium">нужно через паром</p>' : ''}<p class="text-sm text-slate-500 mt-1">${new Date(item.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}, <span class="font-semibold">${item.timeInterval}</span></p></div><div><p class="font-bold text-lg text-slate-800">${item.price} ₽</p><span class="bg-green-100 text-green-800 font-medium px-3 py-1 rounded-full text-sm">${item.passenger.name}</span></div></div><button class="contact-btn btn w-full mt-4 bg-slate-800 text-white font-semibold py-2 rounded-lg hover:bg-slate-700" data-passenger-name="${item.passenger.name}">Связаться</button></div>`; } else if (item.senderName) { cardHTML = `<div class="bg-white border border-slate-200 rounded-xl p-4"><div class="flex justify-between items-start mb-3"><div><p class="font-semibold text-lg text-purple-700">Отправлю посылку</p><p class="font-medium">${item.from} → ${item.to}</p><p class="text-sm text-slate-500 mt-1">${new Date(item.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' })}</p></div><div><p class="font-bold text-lg text-slate-800">${item.price} ₽</p><span class="bg-purple-100 text-purple-800 font-medium px-3 py-1 rounded-full text-sm">${item.senderName}</span></div></div><button class="contact-btn btn w-full mt-4 bg-slate-800 text-white font-semibold py-2 rounded-lg hover:bg-slate-700" data-passenger-name="${item.senderName}" data-type="parcel">Связаться</button></div>`; } } container.insertAdjacentHTML('beforeend', cardHTML); }); },
            chatList() { const container = document.getElementById('chat-list-container'); const noChatsEl = document.getElementById('no-chats'); const chatPartners = Object.keys(App.state.chats); container.innerHTML = ''; noChatsEl.classList.toggle('hidden', chatPartners.length > 0); chatPartners.forEach(partner => { const chat = App.state.chats[partner]; const lastMessage = chat.messages.slice(-1)[0] || { text: 'Нет сообщений' }; const isUnread = App.state.unreadChats[partner]; const isAgreed = chat.agreement.me && chat.agreement.other; container.insertAdjacentHTML('beforeend', `<div class="chat-item p-4 border-b border-slate-200 flex items-center space-x-4 cursor-pointer hover:bg-slate-50" data-partner-name="${partner}"><div class="flex-grow"><p class="font-semibold flex items-center">${partner} ${isAgreed ? '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="ml-2 text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>' : ''}</p><p class="text-sm text-slate-500 truncate">${lastMessage.text}</p></div>${isUnread ? '<div class="w-3 h-3 bg-red-500 rounded-full"></div>' : ''}</div>`); }); },
            chatRoom(partnerName) { 
                const container = document.getElementById('chat-messages'); 
                const agreementContainer = document.getElementById('agreement-container');
                const chat = App.state.chats[partnerName]; 
                if (!chat) return; 
                
                container.innerHTML = ''; 
                chat.messages.forEach(msg => { 
                    const isMe = msg.sender === 'me'; 
                    const isSystem = msg.sender === 'system'; 
                    let msgClass = isMe ? 'bg-slate-800 text-white' : 'bg-slate-100 text-slate-800'; 
                    if (isSystem) msgClass = 'bg-transparent text-slate-400 text-center text-xs'; 
                    container.insertAdjacentHTML('beforeend', `<div class="flex ${isMe ? 'justify-end' : isSystem ? 'justify-center' : 'justify-start'}"><div class="max-w-xs lg:max-w-md px-4 py-2 rounded-2xl ${msgClass}">${msg.text}</div></div>`); 
                }); 
                container.scrollTop = container.scrollHeight; 

                agreementContainer.innerHTML = ''; 
                const hasMyMessage = chat.messages.some(m => m.sender === 'me');
                const hasOtherMessage = chat.messages.some(m => m.sender === 'other');

                if (chat.agreement.me && chat.agreement.other) {
                    agreementContainer.innerHTML = `<button class="btn w-full font-bold py-3 px-4 rounded-lg bg-green-500 text-white cursor-not-allowed" disabled>Договоренность достигнута</button>`;
                    if(chat.timerId) {
                        clearInterval(chat.timerId);
                        chat.timerId = null;
                    }
                } else if (chat.timerExpired) {
                    agreementContainer.innerHTML = `<button class="btn w-full font-bold py-3 px-4 rounded-lg bg-slate-300 text-slate-500 cursor-not-allowed" disabled>Время вышло</button>`;
                } else if (hasMyMessage && hasOtherMessage) {
                    const remaining = chat.timerEndTime ? chat.timerEndTime - Date.now() : 15 * 60 * 1000;
                    const minutes = Math.floor((remaining / 1000) / 60);
                    const seconds = Math.floor((remaining / 1000) % 60);
                    const timeString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

                    let buttonHTML;
                    if (chat.agreement.me) {
                        buttonHTML = `<button class="btn w-2/3 font-bold py-2 px-4 rounded-lg bg-green-200 text-green-800 cursor-not-allowed text-sm" disabled>Ожидание...</button>`;
                    } else {
                        buttonHTML = `<button id="agreement-btn" class="btn w-2/3 font-bold py-2 px-4 rounded-lg bg-red-500 text-white hover:bg-red-600 transition-colors text-sm">Подтвердить</button>`;
                    }

                    agreementContainer.innerHTML = `
                        <div class="flex items-center justify-between space-x-4">
                            ${buttonHTML}
                            <div class="flex-1 text-center">
                                <p id="agreement-timer" class="text-xl font-mono font-semibold text-slate-500">${timeString}</p>
                            </div>
                        </div>
                    `;
                }
                agreementContainer.style.display = agreementContainer.innerHTML === '' ? 'none' : 'block';
            },
            updateNavBadge() { const badge = document.getElementById('chat-nav-badge'); const hasUnread = Object.keys(App.state.unreadChats).length > 0; badge.classList.toggle('hidden', !hasUnread); },
            success(title, text, buttonText) { document.getElementById('success-title').textContent = title; document.getElementById('success-text').textContent = text; document.getElementById('back-to-hub-btn').textContent = buttonText; App.navigation.to('success-screen', 'Успех'); },
            populateUserData(screenId) {
                if (!this.state.currentUser) return;
                
                if (screenId === 'passenger-request-screen') {
                    const nameInput = document.getElementById('passenger-name');
                    if (nameInput) nameInput.value = this.state.currentUser.first_name || '';
                } else if (screenId === 'offer-screen') {
                    const nameInput = document.getElementById('driver-name');
                    if (nameInput) nameInput.value = this.state.currentUser.first_name || '';
                }
            }
        },

        a2hsModal: {
            elements: { modal: document.getElementById('a2hs-modal'), showInstructionsBtn: document.getElementById('a2hs-show-instructions-btn'), gotItBtn: document.getElementById('a2hs-got-it-btn'), dontShowAgain: document.getElementById('a2hs-dont-show-again'), initialView: document.getElementById('modal-initial-view'), instructionView: document.getElementById('modal-instruction-view'), },
            init() { if (!localStorage.getItem('hideA2HSModal')) { setTimeout(() => this.show(), 3000); } this.elements.showInstructionsBtn.addEventListener('click', () => { this.elements.initialView.classList.add('hidden'); this.elements.instructionView.classList.remove('hidden'); }); this.elements.gotItBtn.addEventListener('click', () => this.hide()); this.elements.modal.addEventListener('click', (e) => { if (e.target === this.elements.modal) { this.hide(); } }); },
            show() { this.elements.modal.classList.remove('hidden'); },
            hide() { if (this.elements.dontShowAgain.checked) { localStorage.setItem('hideA2HSModal', 'true'); } this.elements.modal.classList.add('hidden'); }
        },

        showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-message');
            const colors = { info: 'bg-slate-800', success: 'bg-green-600', error: 'bg-red-600' };
            
            clearTimeout(this.state.toastTimeout);
            
            toast.className = `toast fixed bottom-6 left-1/2 -translate-x-1/2 w-11/12 max-w-sm p-4 rounded-lg shadow-lg text-white text-center z-50 ${colors[type]}`;
            msg.textContent = message;
            
            toast.offsetHeight;

            toast.classList.add('show');
            this.state.toastTimeout = setTimeout(() => {
                this.hideToast();
            }, 3000);
        },
        hideToast() {
            const toast = document.getElementById('toast');
            clearTimeout(this.state.toastTimeout);
            toast.classList.remove('show');
        },
        resetForm(form) { 
            form.reset(); 
            this.setDefaultDates(); 
            form.querySelectorAll('.direction-buttons button').forEach(btn => btn.classList.remove('active'));
            form.querySelectorAll('#time-interval-buttons button').forEach(btn => { 
                btn.classList.remove('bg-slate-800', 'text-white'); 
            }); 
            
            if (form.id === 'offer-form') { 
                form.querySelector('button[type="submit"]').textContent = 'Опубликовать (600 ₽)';
                form.querySelector('#ferry-price-label').textContent = '';
                form.querySelector('#parcel-price-label').textContent = '';
                form.querySelector('input[name="toCheboksary"]').disabled = false;
                form.querySelector('input[name="viaFerry"]').disabled = false;
            } 
        }
    };

    document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
