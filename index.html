<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ü–æ–ø—É—Ç–∫–∞ 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }
        .screen { display: none; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: block; }
        #chat-screen.active, #my-trips-screen.active { display: flex; flex-direction: column; height: 100%; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .role-btn.active, .direction-buttons button.active, #time-interval-buttons button.active {
            background-color: #1e293b; /* slate-800 */
            color: white;
        }
        .message { max-width: 75%; word-wrap: break-word; }
        .message.sent { align-self: flex-end; background-color: #3b82f6; color: white; } /* blue-500 */
        .message.received { align-self: flex-start; background-color: #e5e7eb; color: #1f2937; } /* gray-200 */
        
        /* Role Switcher Styles */
        #role-switcher {
            position: relative;
        }
        #role-bg {
            position: absolute;
            width: 36px; height: 36px;
            top: 2px;
            left: 2px;
            background-color: white;
            border-radius: 9999px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transform: translateX(0px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #role-switcher.driver #role-bg {
            transform: translateX(36px);
        }
        #role-passenger-icon, #role-driver-icon {
            transition: opacity 0.3s ease-in-out;
        }
        #role-passenger-icon span, #role-driver-icon span {
            display: inline-block;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #role-switcher.passenger #role-passenger-icon span,
        #role-switcher.driver #role-driver-icon span {
            transform: scale(1.15) rotate(-8deg);
        }
        #role-switcher.passenger #role-driver-icon,
        #role-switcher.driver #role-passenger-icon {
            opacity: 0.5;
        }
        #profile-avatar-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modal Styles */
        .modal-overlay {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-overlay.show {
            opacity: 1;
        }
        .modal.show {
            transform: translateY(0);
        }

        /* Filter Button Styles */
        .filter-type-btn.active {
            background-color: white;
            color: #1e293b;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        /* Collapsible Filter Styles */
        #filter-toggle-icon {
            transition: transform 0.3s ease-in-out;
        }
        #filter-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1;
        }
        #filter-content.collapsed {
            max-height: 0;
            opacity: 0;
        }
        #filter-toggle-btn.collapsed #filter-toggle-icon {
            transform: rotate(-180deg);
        }

        /* Custom scrollbar for better look */
        #main-content::-webkit-scrollbar { width: 4px; }
        #main-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        #main-content::-webkit-scrollbar-track { background: transparent; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">

    <div id="app-container" class="h-screen w-screen max-w-md mx-auto bg-white flex flex-col">
        <header id="app-header" class="p-4 flex items-center justify-between bg-white border-b border-slate-200 flex-shrink-0 sticky top-0 z-10">
            <!-- Left item -->
            <div class="flex-1 flex justify-start relative">
                 <button id="add-banner-btn" class="text-slate-500 hover:text-slate-800 transition-colors hidden">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                 </button>
                 <button id="backButton" class="text-slate-500 hover:text-slate-800 transition-colors invisible">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                 </button>
            </div>
            <!-- Center item -->
            <div class="flex-shrink-0">
                <div id="role-switcher" class="flex items-center p-1 bg-slate-100 rounded-full cursor-pointer">
                    <div id="role-bg"></div>
                    <div id="role-passenger-icon" class="relative z-10 w-9 h-9 flex items-center justify-center text-xl">
                        <span>üßç</span>
                    </div>
                    <div id="role-driver-icon" class="relative z-10 w-9 h-9 flex items-center justify-center text-xl">
                        <span>üöó</span>
                    </div>
                </div>
            </div>
            <!-- Right item -->
            <div class="flex-1 flex justify-end">
                 <button id="profile-avatar-btn" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 font-semibold flex items-center justify-center overflow-hidden shrink-0">
                     <!-- Avatar will be rendered here by JS -->
                 </button>
            </div>
        </header>

        <main id="main-content" class="flex-grow overflow-y-auto relative">
            <!-- Screens will be rendered here by JS -->
            <div id="passenger-home-screen" class="screen active"></div>
            <div id="driver-dashboard-screen" class="screen"></div>
            <div id="offer-screen" class="screen"></div>
            <div id="passenger-request-screen" class="screen"></div>
            <div id="parcel-request-screen" class="screen"></div>
            <div id="list-screen" class="screen"></div>
            <div id="success-screen" class="screen"></div>
            <div id="chat-screen" class="screen"></div>
            <div id="my-trips-screen" class="screen"></div>
            <div id="profile-screen" class="screen"></div>
        </main>
        
        <!-- App Footer -->
        <footer id="app-footer" class="p-5 border-t border-slate-200 bg-white flex-shrink-0">
            <div id="banner-container" class="space-y-3 my-4"></div>
            <a href="https://t.me/poputka12rus" target="_blank" class="text-sm btn w-full bg-sky-100 text-sky-800 font-bold py-3 px-4 rounded-xl hover:bg-sky-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                <span>–ù–∞—à–∞ –≥—Ä—É–ø–ø–∞ –≤ Telegram</span>
            </a>
            <a href="https://devtol.ru" target="_blank" class="block text-center text-xs text-slate-400 mt-2 hover:underline">
                powered by devtol
            </a>
        </footer>
    </div>

    <!-- Booking Options Modal -->
    <div id="booking-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
    <div id="booking-modal" class="modal fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto bg-transparent z-50 transform translate-y-full transition-transform duration-300">
        <div class="p-4">
            <div id="booking-options-container" class="space-y-2 bg-slate-100 rounded-xl">
                <!-- Booking options will be rendered here by JS -->
            </div>
            <button id="booking-modal-cancel-btn" class="w-full p-3 mt-2 bg-white rounded-xl text-blue-500 text-lg font-semibold">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- Seats Offer Modal -->
    <div id="seats-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
    <div id="seats-modal" class="modal fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto bg-transparent z-50 transform translate-y-full transition-transform duration-300">
        <div class="p-4">
            <form id="seats-offer-form" class="bg-white rounded-xl p-4 space-y-3">
                <h3 class="text-lg font-semibold text-center">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</h3>
                <p id="seats-modal-text" class="text-sm text-slate-600 text-center"></p>
                <div>
                    <label for="seats-offer-input" class="block text-xs font-medium text-slate-600 mb-2">–û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç</label>
                    <input type="number" id="seats-offer-input" name="seats" min="1" max="8" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                </div>
                <input type="hidden" name="requestId">
                <div class="form-error-seats text-red-500 text-xs text-center mt-2 hidden"></div>
                <button type="submit" class="w-full p-3 bg-green-500 text-white rounded-xl text-base font-semibold">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
            </form>
            <button id="seats-modal-cancel-btn" class="w-full p-3 mt-2 bg-white rounded-xl text-blue-500 text-lg font-semibold">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <!-- Banner Modal -->
    <div id="banner-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
    <div id="banner-modal" class="modal fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto z-50 transform translate-y-full transition-transform duration-300" style="height: 80%;">
        <div class="bg-white h-full rounded-t-xl flex flex-col">
            <h3 class="text-lg font-semibold text-center p-4 border-b flex-shrink-0">–î–æ–±–∞–≤–∏—Ç—å –±–∞–Ω–Ω–µ—Ä</h3>
            <form id="banner-form" class="p-4 space-y-4 overflow-y-auto flex-1">
                <div>
                    <label for="banner-title" class="block text-xs font-medium text-slate-600 mb-2">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
                    <input type="text" id="banner-title" name="title" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                </div>
                <div>
                    <label for="banner-description" class="block text-xs font-medium text-slate-600 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                    <textarea id="banner-description" name="description" rows="3" class="w-full p-3 border border-slate-200 rounded-lg text-sm"></textarea>
                </div>
                <div>
                    <label for="banner-link" class="block text-xs font-medium text-slate-600 mb-2">URL-—Å—Å—ã–ª–∫–∞</label>
                    <input type="url" id="banner-link" name="link_url" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="https://example.com" required>
                </div>
                <div>
                    <label for="banner-image" class="block text-xs font-medium text-slate-600 mb-2">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</label>
                    <input type="file" id="banner-image" name="image" class="w-full text-sm text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" accept="image/*" required>
                </div>
                <div class="form-error-banner text-red-500 text-xs text-center mt-2 hidden"></div>
            </form>
            <div class="p-4 border-t flex-shrink-0">
                <button type="submit" form="banner-form" id="save-banner-btn" class="w-full p-3 bg-blue-600 text-white rounded-xl text-base font-semibold hover:bg-blue-700">
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button id="banner-modal-cancel-btn" class="w-full p-3 mt-2 bg-slate-100 text-slate-700 rounded-xl text-base font-semibold">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    // --- SUPABASE CLIENT INITIALIZATION ---
    const SUPABASE_URL = 'https://scqkpvmmoaolahpxinja.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjcWtwdm1tb2FvbGFocHhpbmphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDIwNDksImV4cCI6MjA3MTE3ODA0OX0.Uz5L2SF8O1EGf_efkq5FLi6g1yl7LlmnTZi_eLnISMw';
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // --- APPLICATION LOGIC ---
    const App = {
        // --- STATE MANAGEMENT ---
        state: {
            currentUser: null,
            userProfile: null,
            userRole: 'passenger', // Default role
            selectedRoute: null,
            navigationHistory: ['passenger-home-screen'], // New default screen
            allRequests: [], // To store the fetched requests
            currentFilters: { // To store the current filter values
                from: '',
                to: '',
                date: '',
                type: 'all' // 'all', 'ride', 'parcel'
            },
            currentConversation: {
                id: null,
                subscription: null
            }
        },

        // --- CONFIGURATION ---
        config: {
            botToken: '8202443902:AAEMonQpK3FmOAh5Up4GPBmI89q1mHz8LpY',
            prices: {
                base: 600,
                parcel: 300,
                cheboksary: 400,
                ferrySurcharge: 100
            },
            routes: {
                koz_yo: { from: '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫', to: '–ô–æ—à–∫–∞—Ä-–û–ª–∞' }
            },
            cities: ['–ô–æ—à–∫–∞—Ä-–û–ª–∞', '–ß–µ–±–æ–∫—Å–∞—Ä—ã', '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫'],
            adminId: 5017229451,
        },

        // --- INITIALIZATION ---
        async init() {
            try {
                // --- Telegram Web App Setup ---
                try {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    Telegram.WebApp.setHeaderColor('#ffffff');
                    Telegram.WebApp.setBackgroundColor('#f8fafc');
                    this.state.currentUser = Telegram.WebApp.initDataUnsafe?.user;
                } catch (e) {
                    console.warn("Telegram WebApp script not found or running in browser.");
                    // Use a mock user for local testing
                    this.state.currentUser = { id: 12345678, first_name: '–¢–µ—Å—Ç', username: 'testuser', photo_url: null };
                }

                if (!this.state.currentUser) {
                    console.error("Could not retrieve user data from Telegram.");
                    document.getElementById('main-content').innerHTML = `<div class="p-5 text-center text-red-500"><h2 class="font-bold">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2><p class="text-sm">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω–æ—Å—Ç–∏ –≤ Telegram.</p></div>`;
                    return;
                }

                // --- Supabase Authentication ---
                const { data, error } = await supabaseClient.auth.signInAnonymously();
                if (error) {
                    console.error('Error signing in to Supabase anonymously:', error);
                    document.getElementById('main-content').innerHTML = `<div class="p-5 text-center text-red-500"><h2 class="font-bold">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö</h2></div>`;
                    return;
                }

                // [–ò–ó–ú–ï–ù–ï–ù–û] –í—ã–∑—ã–≤–∞–µ–º —Ñ—É–Ω–∫—Ü–∏—é –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö, —á—Ç–æ–±—ã —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å ID —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —ç—Ç–æ–π —Å–µ—Å—Å–∏–∏
                // –≠—Ç–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã –ø–æ–ª–∏—Ç–∏–∫ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (RLS).
                const { error: rpcError } = await supabaseClient.rpc('set_current_telegram_id', { telegram_id: this.state.currentUser.id });
                if (rpcError) {
                    console.error('Error setting session telegram_id:', rpcError);
                    document.getElementById('main-content').innerHTML = `<div class="p-5 text-center text-red-500"><h2 class="font-bold">–û—à–∏–±–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Å—Å–∏–∏</h2></div>`;
                    return;
                }

                // --- User Profile and UI Rendering ---
                await this.ensureUserProfile();
                if (this.state.currentUser.id === this.config.adminId) {
                    document.getElementById('add-banner-btn').classList.remove('hidden');
                }
                
                this.bindHandlers();
                this.render.allScreens();
                this.render.updateRoleSwitcherUI();
                this.bindEvents();
                this.setDefaultDates();
                this.render.updateAvatar();
                
                await this.render.banners();

            } catch (error) {
                console.error("An error occurred during app initialization:", error);
                document.getElementById('main-content').innerHTML = `
                    <div class="p-5 text-center text-red-500">
                        <h2 class="font-bold">–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</h2>
                        <p class="text-sm">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≤ –∫–æ–Ω—Å–æ–ª–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞.</p>
                    </div>
                `;
            }
        },

        // --- USER PROFILE ---
        async ensureUserProfile() {
            if (!this.state.currentUser) return;

            let { data: profile, error: fetchError } = await supabaseClient
                .from('profiles')
                .select('*')
                .eq('id', this.state.currentUser.id)
                .single();

            if (fetchError && fetchError.code === 'PGRST116') {
                const { data: newProfile, error: insertError } = await supabaseClient
                    .from('profiles')
                    .insert({
                        id: this.state.currentUser.id,
                        username: this.state.currentUser.username,
                        full_name: this.state.currentUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                    })
                    .select()
                    .single();

                if (insertError) {
                    console.error('Error creating user profile:', insertError);
                    return;
                }
                profile = newProfile;
            } else if (fetchError) {
                console.error('Error fetching user profile:', fetchError);
                return;
            }
            
            this.state.userProfile = profile;
        },

        // --- HANDLER BINDING ---
        bindHandlers() {
            for (const key in this.handlers) {
                if (typeof this.handlers[key] === 'function') {
                    this.handlers[key] = this.handlers[key].bind(this);
                }
            }
        },

        // --- EVENT BINDING ---
        bindEvents() {
            document.body.addEventListener('click', (e) => {
                const button = e.target.closest('button, #role-switcher, #booking-modal-overlay, #seats-modal-overlay, #banner-modal-overlay');
                if (!button) return;

                const { id, classList, dataset } = button;

                if (id === 'role-switcher') {
                    this.handlers.onRoleSwitch();
                    return;
                }
                
                if (button.closest('#time-interval-buttons')) {
                    this.handlers.onTimeSelect(button);
                    return;
                }

                if (button.classList.contains('filter-type-btn')) {
                    this.handlers.onFilterTypeSelect(button);
                    return;
                }

                const clickHandlers = {
                    'backButton': () => this.navigation.back(),
                    'view-driver-offers-btn': this.handlers.onViewDriverOffers,
                    'create-passenger-request-btn': () => this.navigation.to('passenger-request-screen'),
                    'send-parcel-btn': () => this.navigation.to('parcel-request-screen'),
                    'view-passenger-requests-btn': this.handlers.onViewPassengerRequests,
                    'publish-ride-btn': this.handlers.onPublishRideClick,
                    'my-trips-btn': this.handlers.onMyTripsClick,
                    'back-to-hub-btn': this.handlers.onBackToHub,
                    'profile-avatar-btn': () => this.navigation.to('profile-screen'),
                    'booking-modal-cancel-btn': this.handlers.onBookingModalCancel,
                    'booking-modal-overlay': this.handlers.onBookingModalCancel,
                    'seats-modal-cancel-btn': this.handlers.onSeatsModalCancel,
                    'seats-modal-overlay': this.handlers.onSeatsModalCancel,
                    'banner-modal-cancel-btn': this.handlers.onBannerModalCancel,
                    'banner-modal-overlay': this.handlers.onBannerModalCancel,
                    'add-banner-btn': this.handlers.onAddBannerClick,
                    'apply-filters-btn': this.handlers.onApplyFilters,
                    'reset-filters-btn': this.handlers.onResetFilters,
                    'filter-toggle-btn': this.handlers.onToggleFilter,
                };

                if (clickHandlers[id]) {
                    clickHandlers[id]();
                    return;
                }

                if (classList.contains('offer-ride-btn')) this.handlers.onOfferRideToRequest(dataset.requestId);
                if (classList.contains('request-booking-btn')) this.handlers.onRequestBooking(dataset.offerId);
                if (classList.contains('detour-booking-btn')) this.handlers.onDetourBookingClick(dataset.offer);
                if (classList.contains('confirm-booking-segment-btn')) this.handlers.onConfirmBookingSegment(dataset);
                if (classList.contains('cancel-booking-btn')) this.handlers.onCancelBooking(dataset.bookingId);
                if (classList.contains('accept-booking-btn')) this.handlers.onUpdateBookingStatus(dataset.bookingId, 'confirmed');
                if (classList.contains('reject-booking-btn')) this.handlers.onUpdateBookingStatus(dataset.bookingId, 'rejected');
                if (classList.contains('delete-offer-btn')) this.handlers.onDeleteOffer(dataset.offerId);
                if (classList.contains('cancel-request-btn')) this.handlers.onCancelRequest(dataset.requestId);
                if (classList.contains('cancel-parcel-request-btn')) this.handlers.onCancelParcelRequest(dataset.requestId);
                if (classList.contains('offer-parcel-delivery-btn')) this.handlers.onOfferParcelDelivery(dataset.requestId);
                if (classList.contains('accept-parcel-offer-btn')) this.handlers.onUpdateParcelOffer(dataset.requestId, 'confirmed');
                if (classList.contains('reject-parcel-offer-btn')) this.handlers.onUpdateParcelOffer(dataset.requestId, 'rejected');
                if (classList.contains('mark-parcel-delivered-btn')) this.handlers.onMarkParcelDelivered(dataset.requestId);
            });

            document.body.addEventListener('submit', (e) => {
                e.preventDefault();
                const formHandlers = {
                    'passenger-request-form': () => this.handlers.onPassengerRequestSubmit(e.target),
                    'parcel-request-form': () => this.handlers.onParcelRequestSubmit(e.target),
                    'offer-form': () => this.handlers.onOfferSubmit(e.target),
                    'chat-form': () => this.handlers.onSendMessage(e.target),
                    'profile-form': () => this.handlers.onProfileSubmit(e.target),
                    'seats-offer-form': () => this.handlers.onConfirmSeatOffer(e.target),
                    'banner-form': () => this.handlers.onBannerSubmit(e.target),
                };
                if (formHandlers[e.target.id]) formHandlers[e.target.id]();
            });
            
            document.body.addEventListener('change', (e) => {
                if (e.target.id === 'via-ferry-toggle' || e.target.id === 'via-cheboksary-detour-toggle' || e.target.id === 'via-ferry-toggle-request') {
                    this.handlers.onRouteOptionChange(e.target);
                }
                if (e.target.name === 'from-select' || e.target.name === 'to-select') {
                    this.handlers.onRouteDropdownChange(e.target);
                }
            });
        },

        // --- ACTION HANDLERS ---
        handlers: {
            onRoleSwitch() {
                this.state.userRole = this.state.userRole === 'passenger' ? 'driver' : 'passenger';
                this.render.updateRoleSwitcherUI();
                
                const newScreen = this.state.userRole === 'passenger' ? 'passenger-home-screen' : 'driver-dashboard-screen';
                
                this.state.navigationHistory = [newScreen];
                this.navigation.to(newScreen);
            },

            onToggleFilter() {
                const content = document.getElementById('filter-content');
                const btn = document.getElementById('filter-toggle-btn');
                content.classList.toggle('collapsed');
                btn.classList.toggle('collapsed');
            },

            onRouteOptionChange(checkbox) {
                const form = checkbox.closest('form');
                if (form.id === 'offer-form') {
                    const ferryToggle = form.querySelector('#via-ferry-toggle');
                    const detourToggle = form.querySelector('#via-cheboksary-detour-toggle');

                    if (checkbox.id === 'via-ferry-toggle' && checkbox.checked) {
                        detourToggle.checked = false;
                        form.querySelector('#cheboksary-detour-container').classList.add('hidden');
                    }
                }
                this.handlers.onRouteDropdownChange(form.querySelector('select[name="from-select"]'));
            },

            onRouteDropdownChange(selectElement) {
                const form = selectElement.closest('form');
                const fromSelect = form.querySelector('select[name="from-select"]');
                const toSelect = form.querySelector('select[name="to-select"]');
                const fromValue = fromSelect.value;
                const toValue = toSelect.value;

                form.querySelector('input[name="from"]').value = fromValue;
                form.querySelector('input[name="to"]').value = toValue;

                Array.from(toSelect.options).forEach(opt => { opt.disabled = opt.value === fromValue; });
                Array.from(fromSelect.options).forEach(opt => { opt.disabled = opt.value === toValue; });

                const isKozYoRoute = (fromValue === '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫' && toValue === '–ô–æ—à–∫–∞—Ä-–û–ª–∞') || (fromValue === '–ô–æ—à–∫–∞—Ä-–û–ª–∞' && toValue === '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫');
                
                const ferryContainer = form.querySelector('#ferry-toggle-container, #ferry-toggle-container-request');
                const detourContainer = form.querySelector('#cheboksary-detour-container');
                const ferryToggle = form.querySelector('#via-ferry-toggle');

                if (isKozYoRoute) {
                    if(ferryContainer) ferryContainer.classList.remove('hidden');
                    if (form.id === 'offer-form' && detourContainer && ferryToggle && !ferryToggle.checked) {
                        detourContainer.classList.remove('hidden');
                    } else if (detourContainer) {
                        detourContainer.classList.add('hidden');
                    }
                } else {
                    if(ferryContainer) ferryContainer.classList.add('hidden');
                    const anyFerryToggle = form.querySelector('#via-ferry-toggle, #via-ferry-toggle-request');
                    if(anyFerryToggle) anyFerryToggle.checked = false;
                    
                    if (detourContainer) {
                        detourContainer.classList.add('hidden');
                        const detourCheckbox = detourContainer.querySelector('input');
                        if(detourCheckbox) detourCheckbox.checked = false;
                    }
                }

                if (form.id === 'offer-form') {
                    this.render.updateOfferOptionsUI(form);
                } else if (form.id === 'passenger-request-form') {
                    this.render.updateRequestPriceUI(form);
                }

                if (fromValue && toValue) {
                    form.querySelector('.form-error-direction').classList.add('hidden');
                }
            },
            
            onTimeSelect(button) {
                const form = button.closest('form');
                button.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                form.querySelector('#timeIntervalInput').value = button.textContent;
                form.querySelector('.form-error-time').classList.add('hidden');
            },
            
            onPublishRideClick() {
                if (!this.state.userProfile?.driver_car || !this.state.userProfile.driver_car.trim()) {
                    console.error('Driver car info missing, redirecting to profile screen.');
                    this.navigation.to('profile-screen');
                } else {
                    this.navigation.to('offer-screen');
                }
            },

            async onViewDriverOffers() {
                this.navigation.to('list-screen');
                document.getElementById('filter-section-container').classList.add('hidden');

                const { data: offers, error: offersError } = await supabaseClient.from('ride_offers_with_seats')
                    .select('*')
                    .gte('ride_date', new Date().toISOString().split('T')[0])
                    .gt('seats_left', 0)
                    .order('ride_date', { ascending: true })
                    .order('ride_time', { ascending: true });

                if (offersError) { console.error(offersError); return; }

                const { data: userBookings, error: userBookingsError } = await supabaseClient.from('bookings')
                    .select('id, offer_id')
                    .eq('passenger_id', this.state.currentUser.id);

                if (userBookingsError) { console.error("Error fetching user bookings:", userBookingsError); }
                
                const userBookingsMap = new Map();
                if (userBookings) {
                    userBookings.forEach(b => userBookingsMap.set(b.offer_id, b.id));
                }

                const augmentedOffers = offers.map(offer => ({
                    ...offer,
                    currentUserBookingId: userBookingsMap.get(offer.id) || null
                }));

                this.render.list(augmentedOffers, 'driverOffer');
            },

            async onViewPassengerRequests() {
                this.navigation.to('list-screen');
                document.getElementById('filter-section-container').classList.remove('hidden');
                if (this.state.userRole === 'driver') {
                    document.getElementById('filter-type-container').classList.remove('hidden');
                } else {
                    document.getElementById('filter-type-container').classList.add('hidden');
                }

                const listContainer = document.getElementById('list-container');
                listContainer.innerHTML = `<div class="text-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-800 mx-auto"></div></div>`;
                
                const today = new Date().toISOString().split('T')[0];
                const dateFilterInput = document.getElementById('filter-date');
                if (dateFilterInput) {
                    dateFilterInput.setAttribute('min', today);
                }

                const { data: rides, error: ridesError } = await supabaseClient.from('ride_requests')
                    .select('*')
                    .gte('ride_date', today)
                    .eq('status', 'open') 
                    .order('ride_date', { ascending: true });
                
                const { data: parcels, error: parcelsError } = await supabaseClient.from('parcel_requests')
                    .select('*').gte('ride_date', today).eq('status', 'open').order('ride_date', { ascending: true });

                if (ridesError || parcelsError) { console.error(ridesError || parcelsError); return; }
                
                const allRequests = [
                    ...rides.map(r => ({...r, type: 'ride'})), 
                    ...parcels.map(p => ({...p, type: 'parcel'}))
                ];
                allRequests.sort((a, b) => new Date(a.ride_date) - new Date(b.ride_date));
                
                this.state.allRequests = allRequests;
                this.handlers.onResetFilters();
            },

            onFilterTypeSelect(button) {
                button.parentElement.querySelectorAll('.filter-type-btn').forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
            },

            onApplyFilters() {
                const from = document.getElementById('filter-from').value;
                const to = document.getElementById('filter-to').value;
                const date = document.getElementById('filter-date').value;
                const type = document.querySelector('#filter-type-buttons .active').dataset.type;

                this.state.currentFilters = { from, to, date, type };
                this.renderFilteredList();
            },

            onResetFilters() {
                this.state.currentFilters = { from: '', to: '', date: '', type: 'all' };

                document.getElementById('filter-from').value = '';
                document.getElementById('filter-to').value = '';
                document.getElementById('filter-date').value = '';
                document.querySelectorAll('#filter-type-buttons .filter-type-btn').forEach(btn => {
                    btn.classList.toggle('active', btn.dataset.type === 'all');
                });

                this.renderFilteredList();
            },
            
            async onMyTripsClick() {
                this.navigation.to('my-trips-screen');
                const container = document.getElementById('my-trips-container');
                container.innerHTML = `<div class="text-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-800 mx-auto"></div></div>`;

                if (this.state.userRole === 'driver') {
                    const { data: offers, error: offersError } = await supabaseClient.from('ride_offers')
                        .select(`*, bookings(id, status, seats, price, from_city, to_city, profiles(full_name, username))`)
                        .eq('driver_id', this.state.currentUser.id)
                        .gte('ride_date', new Date().toISOString().split('T')[0])
                        .order('ride_date', { ascending: true });
                    
                    const { data: parcels, error: parcelsError } = await supabaseClient.from('parcel_requests')
                        .select(`*`)
                        .eq('assigned_driver_id', this.state.currentUser.id)
                        .in('status', ['pending_confirmation', 'confirmed', 'delivered'])
                        .order('ride_date', { ascending: false });

                    if (offersError || parcelsError) { console.error(offersError || parcelsError); return; }
                    this.render.myTrips({ offers, parcels }, 'driver');

                } else { // Passenger
                    const { data: bookings, error: bookingsError } = await supabaseClient.from('bookings')
                        .select(`*, ride_offers(*)`)
                        .eq('passenger_id', this.state.currentUser.id)
                        .gte('ride_offers.ride_date', new Date().toISOString().split('T')[0])
                        .order('created_at', { ascending: false });

                    const { data: requests, error: requestsError } = await supabaseClient.from('ride_requests')
                        .select(`*`)
                        .eq('passenger_id', this.state.currentUser.id)
                        .in('status', ['open', 'pending_confirmation']) 
                        .gte('ride_date', new Date().toISOString().split('T')[0])
                        .order('created_at', { ascending: false });

                    const { data: parcels, error: parcelsError } = await supabaseClient.from('parcel_requests')
                        .select(`*`)
                        .eq('sender_id', this.state.currentUser.id)
                        .order('ride_date', { ascending: false });

                    if (bookingsError || requestsError || parcelsError) { 
                        console.error(bookingsError || requestsError || parcelsError); 
                        return; 
                    }
                    this.render.myTrips({ bookings, requests, parcels }, 'passenger');
                }
            },
            
            async onOfferSubmit(form) {
                if (!this.state.userProfile) {
                    console.error("Profile not loaded, cannot submit offer.");
                    return;
                }
                if (!this.state.userProfile.full_name || !this.state.userProfile.driver_car) { 
                    console.error('Profile info missing, redirecting to profile screen.'); 
                    this.navigation.to('profile-screen');
                    return; 
                }
                
                const formData = new FormData(form);
                const from = formData.get('from');
                const to = formData.get('to');

                if (!from || !to) { 
                    form.querySelector('.form-error-direction').classList.remove('hidden'); 
                    return; 
                }
                
                const viaFerry = form.querySelector('#via-ferry-toggle').checked;
                const viaCheboksaryDetour = form.querySelector('#via-cheboksary-detour-toggle').checked;
                const isCheboksaryRoute = from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';
                
                let finalPrice = this.config.prices.base;
                if (isCheboksaryRoute) {
                    finalPrice = this.config.prices.cheboksary;
                } else if (viaFerry) {
                    finalPrice += this.config.prices.ferrySurcharge;
                }

                const { error } = await supabaseClient.from('ride_offers').insert({
                    driver_id: this.state.currentUser.id, driver_username: this.state.currentUser.username,
                    "from": from, "to": to, ride_date: formData.get('date'),
                    ride_time: formData.get('time'), seats: parseInt(formData.get('seats')),
                    price: finalPrice, driver_name: this.state.userProfile.full_name, driver_car: this.state.userProfile.driver_car,
                    via_cheboksary: isCheboksaryRoute, 
                    via_ferry: !isCheboksaryRoute && viaFerry,
                    via_cheboksary_detour: !isCheboksaryRoute && !viaFerry && viaCheboksaryDetour
                });
                if (error) { console.error(error); return; }
                this.resetForm(form);
                this.render.success('–ü–æ–µ–∑–¥–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞', '–ü–∞—Å—Å–∞–∂–∏—Ä—ã —Ç–µ–ø–µ—Ä—å –≤–∏–¥—è—Ç –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.', '–í –∫–∞–±–∏–Ω–µ—Ç');
            },

            async onPassengerRequestSubmit(form) {
                if (!this.state.userProfile) {
                    console.error("Profile not loaded, cannot submit request.");
                    return;
                }
                const formData = new FormData(form);
                const from = formData.get('from');
                const to = formData.get('to');
                let valid = true;

                if (!from || !to) { 
                    form.querySelector('.form-error-direction').classList.remove('hidden'); 
                    valid = false; 
                }
                if (!formData.get('time')) { 
                    form.querySelector('.form-error-time').classList.remove('hidden'); 
                    valid = false; 
                }
                if (!valid) return;
                
                const isCheboksaryRoute = from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';
                const viaFerry = form.querySelector('#via-ferry-toggle-request')?.checked || false;
                
                let pricePerSeat = this.config.prices.base;
                if (isCheboksaryRoute) {
                    pricePerSeat = this.config.prices.cheboksary;
                } else if (viaFerry) {
                    pricePerSeat += this.config.prices.ferrySurcharge;
                }

                const { error } = await supabaseClient.from('ride_requests').insert({
                    passenger_id: this.state.currentUser.id, passenger_username: this.state.currentUser.username,
                    "from": from, "to": to, ride_date: formData.get('date'),
                    ride_time: formData.get('time'), 
                    seats: parseInt(formData.get('seats')),
                    via_ferry: viaFerry,
                    passenger_name: this.state.userProfile.full_name, 
                    price: pricePerSeat,
                    status: 'open'
                });
                if (error) { console.error(error); return; }
                this.resetForm(form);
                this.render.success('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª–∏ —Å–∫–æ—Ä–æ —É–≤–∏–¥—è—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É.', '–û—Ç–ª–∏—á–Ω–æ');
            },
            
            async onParcelRequestSubmit(form) {
                if (!this.state.userProfile) {
                    console.error("Profile not loaded, cannot submit parcel request.");
                    return;
                }
                const formData = new FormData(form);
                const from = formData.get('from');
                const to = formData.get('to');
                if (!from || !to) { 
                    form.querySelector('.form-error-direction').classList.remove('hidden'); 
                    return; 
                }
                
                const { error } = await supabaseClient.from('parcel_requests').insert({
                    sender_id: this.state.currentUser.id, sender_username: this.state.currentUser.username,
                    "from": from, "to": to, ride_date: formData.get('date'),
                    sender_name: this.state.userProfile.full_name, price: this.config.prices.parcel,
                    status: 'open'
                });
                if (error) { console.error(error); return; }
                this.resetForm(form);
                this.render.success('–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—ã–ª–∫—É —Å–æ–∑–¥–∞–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É.', '–û—Ç–ª–∏—á–Ω–æ');
            },
            
            async onProfileSubmit(form) {
                const formData = new FormData(form);
                const fullName = formData.get('fullName').trim();
                const driverCar = formData.get('driverCar').trim();
                if (!fullName) { 
                    console.error('Full name is required'); 
                    return; 
                }

                const { data, error } = await supabaseClient.from('profiles')
                    .update({
                        full_name: fullName,
                        driver_car: driverCar
                    })
                    .eq('id', this.state.currentUser.id)
                    .select()
                    .single();

                if (error) {
                    console.error('Profile save error:', error);
                    return;
                }
                this.state.userProfile = data;
                this.navigation.back();
            },
            
            async onRequestBooking(offerId, bookingDetails = null) {
                if (!this.state.userProfile) {
                    console.error('Profile not loaded');
                    return;
                }
                const { data: existingBooking } = await supabaseClient.from('bookings')
                    .select('id').eq('offer_id', offerId).eq('passenger_id', this.state.currentUser.id);
                if (existingBooking && existingBooking.length > 0) {
                    console.warn('Booking already exists'); return;
                }

                const { data: offer, error: offerError } = await supabaseClient.from('ride_offers').select('*').eq('id', offerId).single();
                if(offerError || !offer) { console.error("Offer not found"); return; }
                
                const bookingData = {
                    offer_id: offerId,
                    passenger_id: this.state.currentUser.id,
                    status: 'pending',
                    booking_segment: bookingDetails ? bookingDetails.segment : 'full',
                    price: bookingDetails ? bookingDetails.price : offer.price,
                    from_city: bookingDetails ? bookingDetails.from : offer.from,
                    to_city: bookingDetails ? bookingDetails.to : offer.to,
                    seats: 1 // Default to 1 seat for direct booking
                };
                
                const { error: insertError } = await supabaseClient.from('bookings').insert(bookingData);

                if (insertError) { console.error('Booking insert error:', insertError); return; }
                
                if (offer) {
                    const passengerName = this.state.userProfile.full_name || '–ù–æ–≤—ã–π –ø–∞—Å—Å–∞–∂–∏—Ä';
                    const message = `
*–ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ!* üöó

–ü–∞—Å—Å–∞–∂–∏—Ä *${passengerName}* —Ö–æ—á–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –≤–∞—à—É –ø–æ–µ–∑–¥–∫—É:
*–ú–∞—Ä—à—Ä—É—Ç:* ${offer.from} ‚Üí ${offer.to}
*–î–∞—Ç–∞:* ${this.utils.formatDate(offer.ride_date)}

–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–π–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ —Ä–∞–∑–¥–µ–ª "–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏", —á—Ç–æ–±—ã *–ø—Ä–∏–Ω—è—Ç—å* –∏–ª–∏ *–æ—Ç–∫–ª–æ–Ω–∏—Ç—å* –∑–∞—è–≤–∫—É.
                    `.trim();
                    this.utils.sendTelegramNotification(offer.driver_id, message);
                }

                this.render.success('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª—å —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –µ–µ —Å—Ç–∞—Ç—É—Å –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏".', '–û—Ç–ª–∏—á–Ω–æ');
            },

            onDetourBookingClick(offerData) {
                const offer = JSON.parse(decodeURIComponent(offerData));
                this.render.bookingOptionsModal(offer);
            },

            onConfirmBookingSegment(dataset) {
                this.handlers.onBookingModalCancel();
                const bookingDetails = {
                    segment: dataset.segment,
                    price: parseInt(dataset.price),
                    from: dataset.from,
                    to: dataset.to,
                };
                this.handlers.onRequestBooking(dataset.offerId, bookingDetails);
            },

            onBookingModalCancel() {
                const overlay = document.getElementById('booking-modal-overlay');
                const modal = document.getElementById('booking-modal');
                overlay.classList.remove('show');
                modal.classList.remove('show');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            },
            
            async onUpdateBookingStatus(bookingId, status) {
                const { data: booking, error: bookingFetchError } = await supabaseClient
                    .from('bookings')
                    .select('*, ride_offers(*)')
                    .eq('id', bookingId)
                    .single();

                if (bookingFetchError || !booking) {
                    console.error('Booking not found for status update:', bookingFetchError);
                    return;
                }

                const offer = booking.ride_offers;
                const passengerId = booking.passenger_id;
                const isPassengerAction = this.state.currentUser.id === passengerId;
                const isLinkedToRequest = offer && offer.linked_request_id;

                // SCENARIO 1: Passenger REJECTS an offer made by a driver
                if (isPassengerAction && isLinkedToRequest && status === 'rejected') {
                    await supabaseClient.from('ride_requests').update({ status: 'open' }).eq('id', offer.linked_request_id);
                    await supabaseClient.from('bookings').delete().eq('id', bookingId);
                    await supabaseClient.from('ride_offers').delete().eq('id', offer.id);
                    const message = `–ü–∞—Å—Å–∞–∂–∏—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª(–∞) –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –ø–æ–µ–∑–¥–∫–µ (${offer.from} ‚Üí ${offer.to}).`;
                    await this.utils.sendTelegramNotification(offer.driver_id, message);
                } 
                // SCENARIO 2: Passenger ACCEPTS an offer made by a driver
                else if (isPassengerAction && isLinkedToRequest && status === 'confirmed') {
                    await supabaseClient.from('bookings').update({ status: 'confirmed' }).eq('id', bookingId);
                    await supabaseClient.from('ride_requests').update({ status: 'closed' }).eq('id', offer.linked_request_id);
                    const message = `–ü–∞—Å—Å–∞–∂–∏—Ä –ø—Ä–∏–Ω—è–ª(–∞) –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ –ø–æ–µ–∑–¥–∫–µ (${offer.from} ‚Üí ${offer.to})! –ü–æ–µ–∑–¥–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞.`;
                    await this.utils.sendTelegramNotification(offer.driver_id, message);
                }
                // SCENARIO 3: Default driver action (accepting/rejecting a standard booking)
                else {
                    await supabaseClient.from('bookings').update({ status }).eq('id', bookingId);
                    const passengerName = this.state.userProfile?.full_name;
                    let message = '';
                    if (status === 'confirmed') {
                        message = `*–í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ!* ‚úÖ\n\n–í–æ–¥–∏—Ç–µ–ª—å *${offer.driver_name}* –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–∞—à—É –ø–æ–µ–∑–¥–∫—É:\n*–ú–∞—Ä—à—Ä—É—Ç:* ${offer.from} ‚Üí ${offer.to}\n*–î–∞—Ç–∞:* ${this.utils.formatDate(offer.ride_date)} –≤ *${offer.ride_time}*`;
                    } else if (status === 'rejected') {
                        message = `*–í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ* ‚ùå\n\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à—É –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–µ–∑–¥–∫—É:\n*–ú–∞—Ä—à—Ä—É—Ç:* ${offer.from} ‚Üí ${offer.to}\n*–î–∞—Ç–∞:* ${this.utils.formatDate(offer.ride_date)}`;
                    }
                    if (message) await this.utils.sendTelegramNotification(passengerId, message);
                }

                this.handlers.onMyTripsClick();
            },
            
            async onCancelBooking(bookingId) {
                const { data: booking, error: bookingError } = await supabaseClient
                    .from('bookings')
                    .select('*, ride_offers(*)')
                    .eq('id', bookingId)
                    .single();

                if (bookingError || !booking) { console.error('Error fetching booking to cancel:', bookingError); return; }
                
                const offer = booking.ride_offers;
                const passengerName = this.state.userProfile?.full_name || '–ü–∞—Å—Å–∞–∂–∏—Ä';
                const message = `*–ü–∞—Å—Å–∞–∂–∏—Ä –æ—Ç–º–µ–Ω–∏–ª –±—Ä–æ–Ω—å* üßç‚Äç‚ôÇÔ∏è\n\n–ü–∞—Å—Å–∞–∂–∏—Ä *${passengerName}* –æ—Ç–º–µ–Ω–∏–ª –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≤–∞—à—É –ø–æ–µ–∑–¥–∫—É:\n*–ú–∞—Ä—à—Ä—É—Ç:* ${offer.from} ‚Üí ${offer.to}\n*–î–∞—Ç–∞:* ${this.utils.formatDate(offer.ride_date)}`;
                await this.utils.sendTelegramNotification(offer.driver_id, message);
                
                const { error } = await supabaseClient.from('bookings').delete().eq('id', bookingId);
                if (error) { console.error('Failed to cancel booking'); return; }
                
                const currentScreen = this.state.navigationHistory[this.state.navigationHistory.length - 1];
                if (currentScreen === 'list-screen') {
                    this.handlers.onViewDriverOffers();
                } else {
                    this.handlers.onMyTripsClick();
                }
            },
            
            async onDeleteOffer(offerId) {
                const { data: bookings, error: bookingsError } = await supabaseClient
                    .from('bookings')
                    .select('passenger_id, ride_offers(from, to, ride_date)')
                    .eq('offer_id', offerId);

                if (bookingsError) { console.error('Failed to fetch bookings for notification:', bookingsError); }

                if (bookings && bookings.length > 0) {
                    const offerDetails = bookings[0].ride_offers;
                    const message = `*–ü–æ–µ–∑–¥–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º* ‚ùå\n\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –ø–æ–µ–∑–¥–∫—É:\n*–ú–∞—Ä—à—Ä—É—Ç:* ${offerDetails.from} ‚Üí ${offerDetails.to}\n*–î–∞—Ç–∞:* ${this.utils.formatDate(offerDetails.ride_date)}\n\n–í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã–ª–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–æ.`;
                    const notificationPromises = bookings.map(b => this.utils.sendTelegramNotification(b.passenger_id, message));
                    await Promise.all(notificationPromises);
                }

                const { error } = await supabaseClient.from('ride_offers').delete().eq('id', offerId);
                if (error) { console.error('Failed to delete offer'); return; }
                this.handlers.onMyTripsClick();
            },
            
            async onCancelRequest(requestId) {
                const { error } = await supabaseClient.from('ride_requests').delete().eq('id', requestId);
                 if (error) { console.error('Failed to cancel request'); return; }
                this.handlers.onMyTripsClick();
            },

            async onCancelParcelRequest(requestId) {
                const { error } = await supabaseClient.from('parcel_requests').delete().eq('id', requestId);
                 if (error) { console.error('Failed to cancel parcel request'); return; }
                this.handlers.onMyTripsClick();
            },

            onBackToHub() {
                const screen = this.state.userRole === 'driver' ? 'driver-dashboard-screen' : 'passenger-home-screen';
                this.state.navigationHistory = [screen];
                this.navigation.to(screen);
            },

            async onOfferRideToRequest(requestId) {
                if (!this.state.userProfile?.driver_car || !this.state.userProfile.driver_car.trim()) {
                    this.navigation.to('profile-screen');
                    return;
                }

                const { data: request, error: requestError } = await supabaseClient
                    .from('ride_requests')
                    .select('seats')
                    .eq('id', requestId)
                    .single();

                if (requestError || !request) {
                    console.error("Request not found:", requestError);
                    return;
                }

                const overlay = document.getElementById('seats-modal-overlay');
                const modal = document.getElementById('seats-modal');
                const form = document.getElementById('seats-offer-form');
                const input = document.getElementById('seats-offer-input');
                
                form.querySelector('input[name="requestId"]').value = requestId;
                document.getElementById('seats-modal-text').textContent = `–ü–∞—Å—Å–∞–∂–∏—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç ${request.seats} ${request.seats > 1 ? '–º–µ—Å—Ç–∞' : '–º–µ—Å—Ç–æ'}. –£–∫–∞–∂–∏—Ç–µ –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –º–µ—Å—Ç –¥–ª—è —ç—Ç–æ–π –ø–æ–µ–∑–¥–∫–∏.`;
                input.min = request.seats;
                input.value = request.seats;
                form.querySelector('.form-error-seats').classList.add('hidden');

                overlay.classList.remove('hidden');
                requestAnimationFrame(() => {
                    overlay.classList.add('show');
                    modal.classList.add('show');
                });
            },

            async onConfirmSeatOffer(form) {
                if (!this.state.userProfile) {
                    console.error("Profile not loaded, cannot confirm seat offer.");
                    return;
                }
                const formData = new FormData(form);
                const requestId = formData.get('requestId');
                const totalSeatsOffered = parseInt(formData.get('seats'));
                const errorDiv = form.querySelector('.form-error-seats');
                
                const { data: request, error: requestError } = await supabaseClient
                    .from('ride_requests')
                    .select('*')
                    .eq('id', requestId)
                    .single();

                if (requestError || !request) { 
                    console.error("Request not found:", requestError); 
                    this.handlers.onSeatsModalCancel();
                    return; 
                }

                const seatsRequestedByPassenger = request.seats;

                if (!totalSeatsOffered || totalSeatsOffered < seatsRequestedByPassenger) {
                    errorDiv.textContent = `–£–∫–∞–∂–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç (–Ω–µ –º–µ–Ω–µ–µ ${seatsRequestedByPassenger}).`;
                    errorDiv.classList.remove('hidden');
                    return;
                }
                errorDiv.classList.add('hidden');

                this.handlers.onSeatsModalCancel();

                const { data: newOffer, error: offerError } = await supabaseClient
                    .from('ride_offers')
                    .insert({
                        driver_id: this.state.currentUser.id,
                        driver_username: this.state.currentUser.username,
                        driver_name: this.state.userProfile.full_name,
                        driver_car: this.state.userProfile.driver_car,
                        from: request.from,
                        to: request.to,
                        ride_date: request.ride_date,
                        ride_time: request.ride_time,
                        seats: totalSeatsOffered,
                        price: request.price, // Price is per seat
                        via_ferry: request.via_ferry,
                        linked_request_id: requestId
                    })
                    .select()
                    .single();
                
                if (offerError) { console.error("Failed to create offer:", offerError); return; }

                const { error: bookingError } = await supabaseClient.from('bookings').insert({
                    offer_id: newOffer.id,
                    passenger_id: request.passenger_id,
                    status: 'pending',
                    price: request.price * seatsRequestedByPassenger, // Total price for this booking
                    from_city: newOffer.from,
                    to_city: newOffer.to,
                    seats: seatsRequestedByPassenger
                });

                if (bookingError) { console.error("Failed to create booking:", bookingError); return; }

                await supabaseClient.from('ride_requests').update({ status: 'pending_confirmation' }).eq('id', requestId);

                const message = `*–í–∞–º –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ –ø–æ–µ–∑–¥–∫—É!* üöó\n\n–í–æ–¥–∏—Ç–µ–ª—å *${newOffer.driver_name}* –Ω–∞ *${newOffer.driver_car}* –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –Ω–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É:\n*–ú–∞—Ä—à—Ä—É—Ç:* ${newOffer.from} ‚Üí ${newOffer.to}\n*–î–∞—Ç–∞:* ${this.utils.formatDate(newOffer.ride_date)}\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏".`;
                await this.utils.sendTelegramNotification(request.passenger_id, message);

                const button = document.querySelector(`.offer-ride-btn[data-request-id="${requestId}"]`);
                if (button) {
                    button.textContent = '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                    button.disabled = true;
                    button.classList.remove('bg-green-500', 'hover:bg-green-600');
                    button.classList.add('bg-slate-400', 'cursor-not-allowed');
                }
            },

            onSeatsModalCancel() {
                const overlay = document.getElementById('seats-modal-overlay');
                const modal = document.getElementById('seats-modal');
                overlay.classList.remove('show');
                modal.classList.remove('show');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            },

            async onOfferParcelDelivery(requestId) {
                if (!this.state.userProfile?.driver_car || !this.state.userProfile.driver_car.trim()) {
                    this.navigation.to('profile-screen');
                    return;
                }

                const { data: request, error: requestError } = await supabaseClient
                    .from('parcel_requests')
                    .select('sender_id')
                    .eq('id', requestId)
                    .single();

                if (requestError || !request) { console.error("Parcel request not found:", requestError); return; }

                const { error } = await supabaseClient
                    .from('parcel_requests')
                    .update({
                        status: 'pending_confirmation',
                        assigned_driver_id: this.state.currentUser.id,
                        assigned_driver_username: this.state.currentUser.username,
                        assigned_driver_name: this.state.userProfile.full_name,
                        assigned_driver_car: this.state.userProfile.driver_car
                    })
                    .eq('id', requestId);

                if (error) { console.error("Failed to offer parcel delivery:", error); return; }

                const message = `*–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –Ω–∞ –≤–∞—à—É –ø–æ—Å—ã–ª–∫—É!* üì¶\n\n–í–æ–¥–∏—Ç–µ–ª—å *${this.state.userProfile.full_name}* –Ω–∞ *${this.state.userProfile.driver_car}* –≥–æ—Ç–æ–≤ –¥–æ—Å—Ç–∞–≤–∏—Ç—å –≤–∞—à—É –ø–æ—Å—ã–ª–∫—É.\n\n–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –∏–ª–∏ –æ—Ç–∫–ª–æ–Ω–∏—Ç–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏ –∏ –∑–∞—è–≤–∫–∏".`;
                await this.utils.sendTelegramNotification(request.sender_id, message);

                const button = document.querySelector(`.offer-parcel-delivery-btn[data-request-id="${requestId}"]`);
                if (button) {
                    button.textContent = '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                    button.disabled = true;
                    button.classList.remove('bg-green-500', 'hover:bg-green-600');
                    button.classList.add('bg-slate-400', 'cursor-not-allowed');
                }
            },

            async onUpdateParcelOffer(requestId, decision) {
                const { data: request, error: requestError } = await supabaseClient
                    .from('parcel_requests')
                    .select('assigned_driver_id')
                    .eq('id', requestId)
                    .single();

                if (requestError || !request) { console.error("Parcel request not found for update:", requestError); return; }

                if (decision === 'confirmed') {
                    const { error } = await supabaseClient.from('parcel_requests').update({ status: 'confirmed' }).eq('id', requestId);
                    if (error) { console.error(error); return; }
                    const message = `*–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ –ø–æ—Å—ã–ª–∫–∏ –ø—Ä–∏–Ω—è—Ç–æ!* ‚úÖ\n\n–í—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º —á–µ—Ä–µ–∑ Telegram.`;
                    await this.utils.sendTelegramNotification(request.assigned_driver_id, message);
                } else { // rejected
                    const { error } = await supabaseClient.from('parcel_requests').update({
                        status: 'open',
                        assigned_driver_id: null,
                        assigned_driver_username: null,
                        assigned_driver_name: null,
                        assigned_driver_car: null
                    }).eq('id', requestId);
                    if (error) { console.error(error); return; }
                    const message = `*–í–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–æ –¥–æ—Å—Ç–∞–≤–∫–µ –ø–æ—Å—ã–ª–∫–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–æ.* ‚ùå`;
                    await this.utils.sendTelegramNotification(request.assigned_driver_id, message);
                }

                this.handlers.onMyTripsClick();
            },

            async onMarkParcelDelivered(requestId) {
                const { data: request, error: fetchError } = await supabaseClient
                    .from('parcel_requests')
                    .select('sender_id, from, to')
                    .eq('id', requestId)
                    .single();

                if (fetchError || !request) {
                    console.error('Failed to fetch parcel for notification:', fetchError);
                    return;
                }

                const { error: updateError } = await supabaseClient
                    .from('parcel_requests')
                    .update({ status: 'delivered', delivered_at: new Date().toISOString() })
                    .eq('id', requestId);

                if (updateError) {
                    console.error('Failed to mark parcel as delivered:', updateError);
                    return;
                }

                const message = `*–í–∞—à–∞ –ø–æ—Å—ã–ª–∫–∞ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∞!* ‚úÖ\n\n–í–æ–¥–∏—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –¥–æ—Å—Ç–∞–≤–∫—É –≤–∞—à–µ–π –ø–æ—Å—ã–ª–∫–∏ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É *${request.from} ‚Üí ${request.to}*.`;
                await this.utils.sendTelegramNotification(request.sender_id, message);

                this.handlers.onMyTripsClick();
            },
            
            onAddBannerClick() {
                const overlay = document.getElementById('banner-modal-overlay');
                const modal = document.getElementById('banner-modal');
                overlay.classList.remove('hidden');
                requestAnimationFrame(() => {
                    overlay.classList.add('show');
                    modal.classList.add('show');
                });
            },

            onBannerModalCancel() {
                const overlay = document.getElementById('banner-modal-overlay');
                const modal = document.getElementById('banner-modal');
                overlay.classList.remove('show');
                modal.classList.remove('show');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                }, 300);
            },

            async onBannerSubmit(form) {
                const saveBtn = document.getElementById('save-banner-btn');
                saveBtn.disabled = true;
                saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

                const formData = new FormData(form);
                const file = formData.get('image');
                const errorDiv = form.querySelector('.form-error-banner');
                errorDiv.classList.add('hidden');

                try {
                    const filePath = `public/${Date.now()}-${file.name}`;
                    const { error: uploadError } = await supabaseClient.storage.from('images').upload(filePath, file);

                    if (uploadError) {
                        throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: ' + uploadError.message);
                    }

                    const { data: urlData } = supabaseClient.storage.from('images').getPublicUrl(filePath);

                    const { error: insertError } = await supabaseClient.from('banners').insert({
                        title: formData.get('title'),
                        description: formData.get('description'),
                        link_url: formData.get('link_url'),
                        image_url: urlData.publicUrl,
                    });

                    if (insertError) {
                        throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±–∞–Ω–Ω–µ—Ä–∞: ' + insertError.message);
                    }

                    form.reset();
                    this.handlers.onBannerModalCancel();
                    this.render.banners();

                } catch (error) {
                    console.error(error);
                    errorDiv.textContent = error.message;
                    errorDiv.classList.remove('hidden');
                } finally {
                    saveBtn.disabled = false;
                    saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
                }
            }
        },
        
        // --- NAVIGATION ---
        navigation: {
            to(screenId) {
                if (App.state.currentConversation.subscription) {
                    supabaseClient.removeChannel(App.state.currentConversation.subscription);
                    App.state.currentConversation.subscription = null;
                }

                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(screenId).classList.add('active');
                
                if (App.state.navigationHistory[App.state.navigationHistory.length - 1] !== screenId) {
                    App.state.navigationHistory.push(screenId);
                }
                
                const isAtRoot = App.state.navigationHistory.length <= 1;
                document.getElementById('backButton').classList.toggle('invisible', isAtRoot);
                if (App.state.currentUser.id === App.config.adminId) {
                    document.getElementById('add-banner-btn').classList.toggle('hidden', !isAtRoot);
                }
                
                if (screenId === 'offer-screen') App.render.populateOfferForm();
                if (screenId === 'profile-screen') App.render.populateProfileForm();
                
                document.getElementById('main-content').scrollTop = 0;
            },
            back() {
                if (App.state.navigationHistory.length <= 1) return;
                App.state.navigationHistory.pop();
                const lastScreen = App.state.navigationHistory[App.state.navigationHistory.length - 1];
                
                document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                document.getElementById(lastScreen).classList.add('active');
                
                const isAtRoot = App.state.navigationHistory.length <= 1;
                document.getElementById('backButton').classList.toggle('invisible', isAtRoot);
                if (App.state.currentUser.id === App.config.adminId) {
                    document.getElementById('add-banner-btn').classList.toggle('hidden', !isAtRoot);
                }
            }
        },

        // --- UI RENDERING & TEMPLATES ---
        render: {
            allScreens() {
                const screenTemplates = {
                    'passenger-home-screen': `
                        <div class="p-5">
                            <div class="text-center mb-6">
                                <h2 class="text-xl font-bold mb-1">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?</h2>
                            </div>
                            <div class="space-y-3">
                                <button id="view-driver-offers-btn" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">–°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–µ–∑–¥–∫–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π</button>
                                <button id="create-passenger-request-btn" class="text-sm btn w-full bg-slate-100 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-200">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–µ–∑–¥–∫—É</button>
                                <button id="send-parcel-btn" class="text-sm btn w-full bg-purple-100 text-purple-800 font-bold py-3 px-4 rounded-xl hover:bg-purple-200">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É</button>
                                <button id="my-trips-btn" class="text-sm mt-4 btn w-full border border-slate-300 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-100">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏ –∏ –∑–∞—è–≤–∫–∏</button>
                            </div>
                        </div>
                    `,
                    'driver-dashboard-screen': `
                        <div class="p-5">
                            <div class="text-center mb-6">
                                <h2 class="text-xl font-bold mb-1">–ö–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è</h2>
                            </div>
                            <div class="space-y-3">
                                <button id="view-passenger-requests-btn" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">–°–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏</button>
                                <button id="publish-ride-btn" class="text-sm btn w-full bg-slate-100 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-200">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–≤–æ—é –ø–æ–µ–∑–¥–∫—É</button>
                                <button id="my-trips-btn" class="text-sm mt-4 btn w-full border border-slate-300 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-100">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</button>
                            </div>
                        </div>
                    `,
                    'offer-screen': this.getOfferFormTemplate(),
                    'passenger-request-screen': this.getPassengerRequestFormTemplate(),
                    'parcel-request-screen': this.getParcelRequestFormTemplate(),
                    'list-screen': `
                            <div class="p-4 space-y-4">
                                <div id="filter-section-container" class="hidden">
                                    <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                                        <button id="filter-toggle-btn" class="flex justify-between items-center w-full mb-3">
                                            <h3 class="text-base font-semibold text-slate-800">–§–∏–ª—å—Ç—Ä—ã</h3>
                                            <svg id="filter-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="m18 15-6-6-6 6"/></svg>
                                        </button>
                                        <div id="filter-content" class="space-y-3">
                                            <div class="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label for="filter-from" class="block text-xs font-medium text-slate-600 mb-1">–û—Ç–∫—É–¥–∞</label>
                                                    <select id="filter-from" name="from" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white">
                                                        <option value="">–õ—é–±–æ–π</option>
                                                        ${App.config.cities.map(c => `<option value="${c}">${c}</option>`).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label for="filter-to" class="block text-xs font-medium text-slate-600 mb-1">–ö—É–¥–∞</label>
                                                    <select id="filter-to" name="to" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white">
                                                        <option value="">–õ—é–±–æ–π</option>
                                                        ${App.config.cities.map(c => `<option value="${c}">${c}</option>`).join('')}
                                                    </select>
                                                </div>
                                            </div>
                                            <div>
                                                <label for="filter-date" class="block text-xs font-medium text-slate-600 mb-1">–î–∞—Ç–∞</label>
                                                <input type="date" id="filter-date" name="date" class="w-full p-2 border border-slate-200 rounded-lg text-sm">
                                            </div>
                                            <div id="filter-type-container">
                                                <label class="block text-xs font-medium text-slate-600 mb-1">–¢–∏–ø –∑–∞—è–≤–∫–∏</label>
                                                <div id="filter-type-buttons" class="flex p-1 bg-slate-200 rounded-lg">
                                                    <button data-type="all" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600 active">–í—Å–µ</button>
                                                    <button data-type="ride" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
                                                    <button data-type="parcel" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600">–ü–æ—Å—ã–ª–∫–∏</button>
                                                </div>
                                            </div>
                                            <div class="flex gap-3 pt-2">
                                                <button id="reset-filters-btn" class="flex-1 text-sm btn border border-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-100">–°–±—Ä–æ—Å–∏—Ç—å</button>
                                                <button id="apply-filters-btn" class="flex-1 text-sm btn bg-slate-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="list-container" class="space-y-3"></div>
                                <div id="no-results" class="text-center text-slate-500 py-10 hidden"><h3 id="no-results-title" class="text-base font-semibold"></h3><p id="no-results-text" class="text-xs"></p></div>
                            </div>
                        `,
                    'success-screen': `<div class="p-5 flex flex-col items-center justify-center h-full text-center"><div class="mb-4"><svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><h2 id="success-title" class="text-xl font-bold mt-4 mb-1"></h2><p id="success-text" class="text-slate-600 mb-8 text-sm"></p><button id="back-to-hub-btn" class="text-sm btn w-full max-w-xs bg-slate-800 text-white font-bold py-3 px-4 rounded-lg"></button></div>`,
                    'chat-screen': `<div class="flex-1 flex flex-col h-full"><div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col"></div><div id="chat-footer" class="p-3 border-t border-slate-200 flex-shrink-0"><form id="chat-form" class="flex items-center space-x-2"><input id="chat-message-input" type="text" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." required><button type="submit" class="p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></form></div></div>`,
                    'my-trips-screen': `<div class="flex-1 flex flex-col"><div id="my-trips-container" class="p-5 space-y-4 flex-1"></div></div>`,
                    'profile-screen': this.getProfileFormTemplate(),
                };
                for (const [id, html] of Object.entries(screenTemplates)) {
                    document.getElementById(id).innerHTML = html;
                }
            },
            
            async banners() {
                const bannerContainer = document.getElementById('banner-container');
                if (!bannerContainer) return;

                const { data: banners, error } = await supabaseClient
                    .from('banners')
                    .select('*')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Error fetching banners:', error);
                    bannerContainer.innerHTML = ''; // Clear in case of error
                    return;
                }

                if (!banners || banners.length === 0) {
                    bannerContainer.innerHTML = ''; // Clear if no banners
                    return;
                }

                const bannerHtml = banners.map(banner => `
                    <a href="${banner.link_url}" target="_blank" class="block rounded-xl overflow-hidden shadow-lg hover:shadow-xl transition-shadow duration-300">
                        <img src="${banner.image_url}" alt="${banner.title}" class="w-full h-auto object-cover">
                        <div class="p-3 bg-white">
                            <h4 class="font-bold text-sm text-slate-800">${banner.title}</h4>
                            <p class="text-xs text-slate-600">${banner.description || ''}</p>
                        </div>
                    </a>
                `).join('');

                bannerContainer.innerHTML = bannerHtml;
            },
            
            updateRoleSwitcherUI() {
                const switcher = document.getElementById('role-switcher');
                if (App.state.userRole === 'driver') {
                    switcher.classList.add('driver');
                    switcher.classList.remove('passenger');
                } else {
                    switcher.classList.add('passenger');
                    switcher.classList.remove('driver');
                }
            },
            
            updateAvatar() {
                const avatarBtn = document.getElementById('profile-avatar-btn');
                if (!avatarBtn) return;

                const user = App.state.currentUser;
                if (user?.photo_url) {
                    avatarBtn.innerHTML = `<img src="${user.photo_url}" alt="Avatar">`;
                } else {
                    const initial = user?.first_name ? user.first_name.charAt(0).toUpperCase() : '?';
                    avatarBtn.innerHTML = `<span>${initial}</span>`;
                }
            },
            
            list(items, type) {
                const container = document.getElementById('list-container');
                const noResults = document.getElementById('no-results');
                container.innerHTML = '';
                if (!items || items.length === 0) {
                    noResults.classList.remove('hidden');
                    document.getElementById('no-results-title').textContent = type === 'driverOffer' ? '–ü–æ–µ–∑–¥–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ó–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                    document.getElementById('no-results-text').textContent = type === 'driverOffer' ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ—é –∑–∞—è–≤–∫—É.' : '–ü–æ –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
                    return;
                }
                noResults.classList.add('hidden');
                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white border border-slate-200 rounded-xl p-4 space-y-3';
                    card.innerHTML = type === 'driverOffer' ? this.getDriverOfferCard(item) : this.getPassengerRequestCard(item);
                    container.appendChild(card);
                });
            },
            
            myTrips(data, role) {
                const container = document.getElementById('my-trips-container');
                container.innerHTML = '';
                if (role === 'driver') {
                    const { offers, parcels } = data;
                    if ((!offers || offers.length === 0) && (!parcels || parcels.length === 0)) {
                        container.innerHTML = `<div class="text-center text-slate-500 py-10"><h3 class="text-base font-semibold">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</h3><p class="text-xs">–û–ø—É–±–ª–∏–∫—É–π—Ç–µ –ø–æ–µ–∑–¥–∫—É –∏–ª–∏ –æ—Ç–∫–ª–∏–∫–Ω–∏—Ç–µ—Å—å –Ω–∞ –¥–æ—Å—Ç–∞–≤–∫—É –ø–æ—Å—ã–ª–∫–∏.</p></div>`;
                        return;
                    }
                    let content = '';
                    if (offers && offers.length > 0) {
                        content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-2">–ú–æ–∏ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–µ –ø–æ–µ–∑–¥–∫–∏</h3>`;
                        content += offers.map(offer => 
                            `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyDriverOfferCard(offer)}</div>`
                        ).join('');
                    }
                    if (parcels && parcels.length > 0) {
                        content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-4">–ú–æ–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –ø–æ—Å—ã–ª–æ–∫</h3>`;
                        content += parcels.map(parcel => 
                            `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyParcelDeliveryCard(parcel)}</div>`
                        ).join('');
                    }
                    container.innerHTML = content;

                } else { // Passenger
                    const { bookings, requests, parcels } = data;
                    if ((!bookings || bookings.length === 0) && 
                        (!requests || requests.length === 0) && 
                        (!parcels || parcels.length === 0)) {
                        container.innerHTML = `<div class="text-center text-slate-500 py-10"><h3 class="text-base font-semibold">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</h3><p class="text-xs">–ó–∞–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –ø–æ–µ–∑–¥–∫—É –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É.</p></div>`;
                        return;
                    }

                    let content = '';

                    if (bookings && bookings.length > 0) {
                        content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-2">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>`;
                        content += bookings.map(booking => 
                            `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyBookingCard(booking)}</div>`
                        ).join('');
                    }

                    if (requests && requests.length > 0) {
                        content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-4">–ú–æ–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–µ–∑–¥–∫–∏</h3>`;
                        content += requests.map(request => 
                            `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyRequestCard(request)}</div>`
                        ).join('');
                    }

                    if (parcels && parcels.length > 0) {
                        content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-4">–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</h3>`;
                        content += parcels.map(parcel => 
                            `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyParcelRequestCard(parcel)}</div>`
                        ).join('');
                    }

                    container.innerHTML = content;
                }
            },
            
            success(title, text, buttonText) {
                document.getElementById('success-title').textContent = title;
                document.getElementById('success-text').textContent = text;
                document.getElementById('back-to-hub-btn').textContent = buttonText;
                App.navigation.to('success-screen');
            },
            
            populateOfferForm() {
                const profile = App.state.userProfile;
                if (!profile) return;
                const form = document.getElementById('offer-form');
                form.querySelector('#driver-name').value = profile.full_name || '';
                form.querySelector('#driver-car').value = profile.driver_car || '';
            },

            populateProfileForm() {
                const profile = App.state.userProfile;
                const form = document.getElementById('profile-form');
                form.querySelector('#profile-name').value = profile?.full_name || App.state.currentUser.first_name || '';
                form.querySelector('#profile-car').value = profile?.driver_car || '';
            },
            
            updateOfferOptionsUI(form) {
                const from = form.querySelector('input[name="from"]').value;
                const to = form.querySelector('input[name="to"]').value;
                const ferryToggle = form.querySelector('#via-ferry-toggle');
                
                let price = App.config.prices.base;
                const isCheboksaryRoute = from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';

                if (isCheboksaryRoute) {
                    price = App.config.prices.cheboksary;
                    form.querySelector('#ferry-price-increase').classList.add('hidden');
                } else {
                    const isFerryChecked = ferryToggle && ferryToggle.checked;
                    form.querySelector('#ferry-price-increase').classList.toggle('hidden', !isFerryChecked);
                    if (isFerryChecked) {
                        price += App.config.prices.ferrySurcharge;
                    }
                }
                
                form.querySelector('#publish-price').textContent = price;
            },

            updateRequestPriceUI(form) {
                const from = form.querySelector('input[name="from"]').value;
                const to = form.querySelector('input[name="to"]').value;
                const ferryToggle = form.querySelector('#via-ferry-toggle-request');
                
                let price = App.config.prices.base;
                const isCheboksaryRoute = from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';

                if (isCheboksaryRoute) {
                    price = App.config.prices.cheboksary;
                    form.querySelector('#ferry-price-increase-request').classList.add('hidden');
                } else {
                    const isFerryChecked = ferryToggle && ferryToggle.checked;
                    form.querySelector('#ferry-price-increase-request').classList.toggle('hidden', !isFerryChecked);
                    if (isFerryChecked) {
                        price += App.config.prices.ferrySurcharge;
                    }
                }
                
                form.querySelector('#request-price').textContent = price;
            },

            bookingOptionsModal(offer) {
                const container = document.getElementById('booking-options-container');
                const priceFull = App.config.prices.base;
                const pricePart = App.config.prices.cheboksary;

                container.innerHTML = `
                    <button class="confirm-booking-segment-btn w-full flex justify-between items-center text-left p-3 text-blue-500 text-base"
                        data-offer-id="${offer.id}" data-segment="full" data-price="${priceFull}" data-from="${offer.from}" data-to="${offer.to}">
                        <span>${offer.from} ‚Üí ${offer.to}</span>
                        <span class="font-semibold">${priceFull} ‚ÇΩ</span>
                    </button>
                    <div class="h-px bg-slate-200"></div>
                    <button class="confirm-booking-segment-btn w-full flex justify-between items-center text-left p-3 text-blue-500 text-base"
                        data-offer-id="${offer.id}" data-segment="start_to_cheb" data-price="${pricePart}" data-from="${offer.from}" data-to="–ß–µ–±–æ–∫—Å–∞—Ä—ã">
                        <span>${offer.from} ‚Üí –ß–µ–±–æ–∫—Å–∞—Ä—ã</span>
                        <span class="font-semibold">${pricePart} ‚ÇΩ</span>
                    </button>
                    <div class="h-px bg-slate-200"></div>
                     <button class="confirm-booking-segment-btn w-full flex justify-between items-center text-left p-3 text-blue-500 text-base"
                        data-offer-id="${offer.id}" data-segment="cheb_to_end" data-price="${pricePart}" data-from="–ß–µ–±–æ–∫—Å–∞—Ä—ã" data-to="${offer.to}">
                        <span>–ß–µ–±–æ–∫—Å–∞—Ä—ã ‚Üí ${offer.to}</span>
                        <span class="font-semibold">${pricePart} ‚ÇΩ</span>
                    </button>
                `;

                const overlay = document.getElementById('booking-modal-overlay');
                const modal = document.getElementById('booking-modal');
                overlay.classList.remove('hidden');
                requestAnimationFrame(() => {
                    overlay.classList.add('show');
                    modal.classList.add('show');
                });
            },
            
            getDriverOfferCard(item) {
                const seatsLeft = item.seats_left;
                const seatsText = seatsLeft === 1 ? '1 –º–µ—Å—Ç–æ' : (seatsLeft > 1 && seatsLeft < 5 ? `${seatsLeft} –º–µ—Å—Ç–∞` : `${seatsLeft} –º–µ—Å—Ç`);
                
                let buttonHtml = '';
                if (item.currentUserBookingId) {
                    buttonHtml = `
                        <button class="cancel-booking-btn btn w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm"
                            data-booking-id="${item.currentUserBookingId}">
                            –û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å
                        </button>
                    `;
                } else {
                    const buttonDisabled = seatsLeft <= 0 ? 'disabled' : '';
                    const buttonClass = seatsLeft <= 0 ? 'bg-slate-300' : 'bg-blue-500 hover:bg-blue-600';
                    const buttonText = seatsLeft <= 0 ? '–ú–µ—Å—Ç –Ω–µ—Ç' : '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';

                    if (item.via_cheboksary_detour) {
                        const offerData = encodeURIComponent(JSON.stringify(item));
                        buttonHtml = `
                            <button class="detour-booking-btn btn w-full text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm ${buttonClass}"
                                data-offer='${offerData}' ${buttonDisabled}>
                                ${buttonText}
                            </button>
                        `;
                    } else {
                         buttonHtml = `
                            <button class="request-booking-btn btn w-full text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm ${buttonClass}"
                                data-offer-id="${item.id}" ${buttonDisabled}>
                                ${buttonText}
                            </button>
                        `;
                    }
                }

                return `
                    <div class="flex justify-between items-center">
                        <div class="font-bold text-base">${item.from} ‚Üí ${item.to}</div>
                        <div class="text-base font-semibold">${item.price} ‚ÇΩ</div>
                    </div>
                    <div class="text-slate-600 text-sm">
                        <p><strong>–î–∞—Ç–∞:</strong> ${App.utils.formatDate(item.ride_date)} –≤ <strong>${item.ride_time}</strong></p>
                        <p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> ${item.driver_name} –Ω–∞ ${item.driver_car}</p>
                        <p><strong>–°–≤–æ–±–æ–¥–Ω–æ:</strong> <span class="font-bold ${seatsLeft <= 1 ? 'text-red-500' : 'text-green-600'}">${seatsText}</span></p>
                    </div>
                    ${item.via_ferry ? `<div class="text-xs font-semibold text-blue-800 bg-blue-100 rounded-full px-3 py-1 text-center">‚õ¥Ô∏è –ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º</div>` : ''}
                    ${item.via_cheboksary_detour ? `<div class="text-xs font-semibold text-orange-800 bg-orange-100 rounded-full px-3 py-1 text-center"> detour via Cheboksary</div>` : ''}
                    ${item.via_cheboksary ? `<div class="text-xs font-semibold text-green-800 bg-green-100 rounded-full px-3 py-1 text-center">–î–æ/–ò–∑ –ß–µ–±–æ–∫—Å–∞—Ä</div>` : ''}
                    ${buttonHtml}
                `;
            },

            getPassengerRequestCard(item) {
                const isParcel = item.type === 'parcel';
                let buttonHtml = '';
                if (App.state.userRole === 'driver') {
                    if (isParcel) {
                        buttonHtml = `<button class="offer-parcel-delivery-btn btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm" data-request-id="${item.id}">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É</button>`;
                    } else {
                        buttonHtml = `<button class="offer-ride-btn btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm" data-request-id="${item.id}">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>`;
                    }
                }

                return `
                    <div class="flex justify-between items-center">
                        <div class="font-bold text-base">${item.from} ‚Üí ${item.to}</div>
                        <div class="text-base font-semibold">${item.price} ‚ÇΩ</div>
                    </div>
                    <div class="text-slate-600 text-sm">
                        <p><strong>–î–∞—Ç–∞:</strong> ${App.utils.formatDate(item.ride_date)}</p>
                        <p><strong>${isParcel ? '–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å' : '–ü–∞—Å—Å–∞–∂–∏—Ä'}:</strong> ${isParcel ? item.sender_name : item.passenger_name}</p>
                        ${!isParcel ? `<p><strong>–í—Ä–µ–º—è:</strong> ~ ${item.ride_time.substring(0, 5)}</p>` : ''}
                        ${!isParcel ? `<p><strong>–ú–µ—Å—Ç:</strong> ${item.seats}</p>` : ''}
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        ${isParcel ? `<div class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">–ü–æ—Å—ã–ª–∫–∞</div>` : `<div class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">–ü–∞—Å—Å–∞–∂–∏—Ä</div>`}
                        ${!isParcel && item.via_ferry ? `<div class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">‚õ¥Ô∏è –ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º</div>` : ''}
                    </div>
                    ${buttonHtml}
                `;
            },
            
            getMyDriverOfferCard(offer) {
                const confirmedBookings = offer.bookings.filter(b => b.status === 'confirmed');
                const pendingBookings = offer.bookings.filter(b => b.status === 'pending');
                const seatsLeft = offer.seats - confirmedBookings.reduce((sum, b) => sum + b.seats, 0);

                let bookingsHtml = '<div class="text-xs text-slate-500">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.</div>';
                if (offer.bookings.length > 0) {
                    bookingsHtml = `
                        ${pendingBookings.length > 0 ? `
                            <h4 class="font-semibold mt-2 text-sm">–ó–∞—è–≤–∫–∏ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</h4>
                            <div class="space-y-2">
                                ${pendingBookings.map(b => `
                                    <div class="bg-amber-50 p-2 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-semibold">${b.profiles?.full_name || '–ü–∞—Å—Å–∞–∂–∏—Ä'} (${b.seats} ${b.seats > 1 ? '–º–µ—Å—Ç–∞' : '–º–µ—Å—Ç–æ'})</span>
                                            <span class="text-sm font-bold">${b.price} ‚ÇΩ</span>
                                        </div>
                                        <div class="text-xs text-slate-600 mt-1">${b.from_city} ‚Üí ${b.to_city}</div>
                                        <div class="flex gap-2 mt-2">
                                            <button class="accept-booking-btn flex-1 bg-green-500 text-white text-xs font-bold py-1 px-2 rounded" data-booking-id="${b.id}">–ü—Ä–∏–Ω—è—Ç—å</button>
                                            <button class="reject-booking-btn flex-1 bg-red-500 text-white text-xs font-bold py-1 px-2 rounded" data-booking-id="${b.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                        ${confirmedBookings.length > 0 ? `
                            <h4 class="font-semibold mt-2 text-sm">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –ø–∞—Å—Å–∞–∂–∏—Ä—ã:</h4>
                            <div class="space-y-2">
                                ${confirmedBookings.map(b => `
                                    <div class="bg-slate-50 p-2 rounded-lg">
                                        <div class="flex justify-between items-center">
                                            <span class="text-sm font-semibold">${b.profiles?.full_name || '–ü–∞—Å—Å–∞–∂–∏—Ä'} (${b.seats} ${b.seats > 1 ? '–º–µ—Å—Ç–∞' : '–º–µ—Å—Ç–æ'})</span>
                                            <span class="text-sm font-bold">${b.price} ‚ÇΩ</span>
                                        </div>
                                        <div class="flex justify-between items-center mt-1">
                                            <span class="text-xs text-slate-600">${b.from_city} ‚Üí ${b.to_city}</span>
                                            ${b.profiles?.username ? `<a href="https://t.me/${b.profiles.username}" target="_blank" class="text-xs bg-blue-500 text-white font-semibold py-1 px-2 rounded-md hover:bg-blue-600">–ù–∞–ø–∏—Å–∞—Ç—å</a>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                }

                return `
                    <div class="flex justify-between items-center">
                        <div>
                            <div class="font-bold text-base">${offer.from} ‚Üí ${offer.to}</div>
                            <div class="text-xs text-slate-500">${App.utils.formatDate(offer.ride_date)} –≤ ${offer.ride_time}</div>
                        </div>
                        <div class="text-base font-semibold">${offer.price} ‚ÇΩ</div>
                    </div>
                    <div class="text-slate-600 text-sm">
                         <p><strong>–°–≤–æ–±–æ–¥–Ω–æ –º–µ—Å—Ç:</strong> <span class="font-bold ${seatsLeft <= 1 ? 'text-red-500' : 'text-green-600'}">${seatsLeft} –∏–∑ ${offer.seats}</span></p>
                    </div>
                    <div class="border-t border-slate-100 pt-2 mt-2">
                        ${bookingsHtml}
                    </div>
                    <button class="delete-offer-btn btn w-full bg-red-50 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-100 transition-colors mt-2 text-sm" data-offer-id="${offer.id}">–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
                `;
            },
            
            getMyBookingCard(booking) {
                const offer = booking.ride_offers;
                if (!offer) {
                    return `<div class="text-red-500 text-sm">–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–µ–∑–¥–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã. –í–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–∞ –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º.</div>`;
                }
                const statusClasses = {
                    pending: 'bg-amber-100 text-amber-800',
                    confirmed: 'bg-green-100 text-green-800',
                    rejected: 'bg-red-100 text-red-800'
                };
                const statusText = {
                    pending: '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è',
                    confirmed: '–í–æ–¥–∏—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª',
                    rejected: '–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª'
                };

                let actionButtons = '';
                if (booking.status === 'pending' && offer.linked_request_id) {
                    statusText[booking.status] = '–û–∂–∏–¥–∞–µ—Ç –≤–∞—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è';
                    actionButtons = `
                        <div class="flex items-center gap-3">
                           <button class="reject-booking-btn text-xs bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg" data-booking-id="${booking.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                           <button class="accept-booking-btn text-xs bg-green-100 text-green-700 font-semibold py-1 px-3 rounded-lg" data-booking-id="${booking.id}">–ü—Ä–∏–Ω—è—Ç—å</button>
                        </div>
                    `;
                } else {
                    actionButtons = `
                        <div class="flex items-center gap-3">
                            ${booking.status === 'confirmed' && offer.driver_username ? `<a href="https://t.me/${offer.driver_username}" target="_blank" class="text-xs text-blue-600 hover:underline font-semibold">–ù–∞–ø–∏—Å–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª—é</a>` : ''}
                            ${booking.status !== 'rejected' ? `<button class="cancel-booking-btn text-xs text-red-600 hover:underline" data-booking-id="${booking.id}">–û—Ç–º–µ–Ω–∏—Ç—å</button>` : ''}
                        </div>
                    `;
                }


                return `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-base">${booking.from_city} ‚Üí ${booking.to_city}</div>
                            <div class="text-xs text-slate-500">${App.utils.formatDate(offer.ride_date)} –≤ ${offer.ride_time}</div>
                            <div class="text-xs text-slate-500">–í–æ–¥–∏—Ç–µ–ª—å: ${offer.driver_name} (${offer.driver_car})</div>
                        </div>
                        <div class="text-base font-semibold">${booking.price} ‚ÇΩ</div>
                    </div>
                     <div class="flex justify-between items-center mt-2">
                        <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${statusClasses[booking.status]}">${statusText[booking.status]}</span>
                        ${actionButtons}
                    </div>
                `;
            },
            
            getMyRequestCard(request) {
                if (request.status === 'pending_confirmation') {
                    return `
                        <div class="flex justify-between items-start opacity-60">
                            <div>
                                <div class="font-bold text-base">${request.from} ‚Üí ${request.to}</div>
                                <div class="text-xs text-slate-500">${App.utils.formatDate(request.ride_date)} –≤ ~ ${request.ride_time.substring(0, 5)}</div>
                            </div>
                            <div class="text-base font-semibold">${request.price} ‚ÇΩ</div>
                        </div>
                        <div class="text-center text-sm text-amber-700 font-semibold bg-amber-50 p-2 rounded-lg mt-2">
                            –û–∂–∏–¥–∞–µ—Ç –≤–∞—à–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ "–ú–æ–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö"
                        </div>
                    `;
                }

                return `
                     <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold text-base">${request.from} ‚Üí ${request.to}</div>
                            <div class="text-xs text-slate-500">${App.utils.formatDate(request.ride_date)} –≤ ~ ${request.ride_time.substring(0, 5)}</div>
                        </div>
                        <div class="text-base font-semibold">${request.price} ‚ÇΩ</div>
                    </div>
                    <div class="flex justify-end items-center mt-2">
                        <button class="cancel-request-btn text-xs text-red-600 hover:underline" data-request-id="${request.id}">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                    </div>
                `;
            },

            getMyParcelRequestCard(parcel) {
                // Passenger's view of their own parcel request
                if (parcel.status === 'open') {
                    return `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-base">${parcel.from} ‚Üí ${parcel.to}</div>
                                <div class="text-xs text-slate-500">${App.utils.formatDate(parcel.ride_date)}</div>
                            </div>
                            <div class="text-base font-semibold">${parcel.price} ‚ÇΩ</div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full bg-slate-100 text-slate-800">–ò—â–µ–º –≤–æ–¥–∏—Ç–µ–ª—è</span>
                            <button class="cancel-parcel-request-btn text-xs text-red-600 hover:underline" data-request-id="${parcel.id}">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                        </div>
                    `;
                }

                if (parcel.status === 'pending_confirmation') {
                    return `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-base">${parcel.from} ‚Üí ${parcel.to}</div>
                                <div class="text-xs text-slate-500">${App.utils.formatDate(parcel.ride_date)}</div>
                            </div>
                            <div class="text-base font-semibold">${parcel.price} ‚ÇΩ</div>
                        </div>
                        <div class="border-t border-slate-100 pt-3 mt-3">
                            <h4 class="text-sm font-semibold mb-2">–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è:</h4>
                            <p class="text-sm text-slate-600"><strong>${parcel.assigned_driver_name}</strong> –Ω–∞ ${parcel.assigned_driver_car}</p>
                            <div class="flex gap-3 mt-3">
                                <button class="reject-parcel-offer-btn flex-1 text-sm btn bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200" data-request-id="${parcel.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
                                <button class="accept-parcel-offer-btn flex-1 text-sm btn bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600" data-request-id="${parcel.id}">–ü—Ä–∏–Ω—è—Ç—å</button>
                            </div>
                        </div>
                    `;
                }

                if (parcel.status === 'confirmed') {
                     return `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-base">${parcel.from} ‚Üí ${parcel.to}</div>
                                <div class="text-xs text-slate-500">${App.utils.formatDate(parcel.ride_date)}</div>
                            </div>
                            <div class="text-base font-semibold">${parcel.price} ‚ÇΩ</div>
                        </div>
                        <div class="border-t border-slate-100 pt-3 mt-3">
                             <p class="text-sm text-slate-600 mb-2"><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> ${parcel.assigned_driver_name} –Ω–∞ ${parcel.assigned_driver_car}</p>
                             <div class="flex justify-between items-center">
                                 <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full bg-green-100 text-green-800">–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞</span>
                                 <a href="https://t.me/${parcel.assigned_driver_username}" target="_blank" class="text-sm bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">–ù–∞–ø–∏—Å–∞—Ç—å</a>
                             </div>
                        </div>
                    `;
                }

                if (parcel.status === 'delivered') {
                     return `
                        <div class="flex justify-between items-start opacity-70">
                            <div>
                                <div class="font-bold text-base">${parcel.from} ‚Üí ${parcel.to}</div>
                                <div class="text-xs text-slate-500">${App.utils.formatDate(parcel.ride_date)}</div>
                            </div>
                            <div class="text-base font-semibold">${parcel.price} ‚ÇΩ</div>
                        </div>
                        <div class="border-t border-slate-100 pt-3 mt-3">
                             <p class="text-sm text-slate-600 mb-2"><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> ${parcel.assigned_driver_name} –Ω–∞ ${parcel.assigned_driver_car}</p>
                             <div class="flex justify-between items-center">
                                 <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full bg-slate-200 text-slate-800">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</span>
                                 <a href="https://t.me/${parcel.assigned_driver_username}" target="_blank" class="text-sm bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">–ù–∞–ø–∏—Å–∞—Ç—å</a>
                             </div>
                        </div>
                    `;
                }

                return ''; 
            },

            getMyParcelDeliveryCard(parcel) {
                // Driver's view of a parcel they offered to deliver
                 if (parcel.status === 'pending_confirmation') {
                    return `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-base">${parcel.from} ‚Üí ${parcel.to}</div>
                                <div class="text-xs text-slate-500">${App.utils.formatDate(parcel.ride_date)}</div>
                            </div>
                            <div class="text-base font-semibold">${parcel.price} ‚ÇΩ</div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full bg-amber-100 text-amber-800">–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</span>
                        </div>
                    `;
                }

                if (parcel.status === 'confirmed') {
                     return `
                        <div class="flex justify-between items-start">
                            <div>
                                <div class="font-bold text-base">${parcel.from} ‚Üí ${parcel.to}</div>
                                <div class="text-xs text-slate-500">${App.utils.formatDate(parcel.ride_date)}</div>
                            </div>
                            <div class="text-base font-semibold">${parcel.price} ‚ÇΩ</div>
                        </div>
                        <div class="border-t border-slate-100 pt-3 mt-3">
                             <p class="text-sm text-slate-600 mb-3"><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${parcel.sender_name}</p>
                             <div class="flex gap-3">
                                 <a href="https://t.me/${parcel.sender_username}" target="_blank" class="flex-1 text-center text-sm bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">–ù–∞–ø–∏—Å–∞—Ç—å</a>
                                 <button class="mark-parcel-delivered-btn flex-1 text-sm btn bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600" data-request-id="${parcel.id}">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</button>
                             </div>
                        </div>
                    `;
                }

                if (parcel.status === 'delivered') {
                    return `
                        <div class="flex justify-between items-start opacity-70">
                            <div>
                                <div class="font-bold text-base">${parcel.from} ‚Üí ${parcel.to}</div>
                                <div class="text-xs text-slate-500">${App.utils.formatDate(parcel.ride_date)}</div>
                            </div>
                            <div class="text-base font-semibold">${parcel.price} ‚ÇΩ</div>
                        </div>
                        <div class="flex justify-between items-center mt-2">
                            <span class="text-xs font-semibold px-2.5 py-0.5 rounded-full bg-slate-200 text-slate-800">–î–æ—Å—Ç–∞–≤–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</span>
                        </div>
                    `;
                }

                return '';
            },
            
            getOfferFormTemplate() {
                const optionsHtml = App.config.cities.map(city => `<option value="${city}">${city}</option>`).join('');
                return `<div class="p-5"><h2 class="text-lg font-bold mb-4">–î–∞–Ω–Ω—ã–µ –æ –ø–æ–µ–∑–¥–∫–µ</h2><form id="offer-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                            <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                ${optionsHtml}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                            <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                ${optionsHtml}
                            </select>
                        </div>
                    </div>
                    <input type="hidden" name="from" required><input type="hidden" name="to" required>
                    <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                    <div id="ferry-toggle-container" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                        <label for="via-ferry-toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º</label>
                        <div class="flex items-center space-x-3">
                            <span id="ferry-price-increase" class="text-sm text-slate-800 font-semibold hidden">(+${App.config.prices.ferrySurcharge} ‚ÇΩ)</span>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-ferry-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label>
                        </div>
                    </div>
                    <div id="cheboksary-detour-container" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                        <label for="via-cheboksary-detour-toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ó–∞–µ–∑–∂–∞—é –≤ –ß–µ–±–æ–∫—Å–∞—Ä—ã</label>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-cheboksary-detour-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div></label>
                    </div>
                    <div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞</label><input type="date" name="date" id="date-offer" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div><div><label class="block text-xs font-medium text-slate-600 mb-2">–í—Ä–µ–º—è</label><input type="time" name="time" id="time-offer" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div></div><input type="hidden" name="driverName" id="driver-name"><input type="hidden" name="driverCar" id="driver-car"><div><label class="block text-xs font-medium text-slate-600 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label><input type="number" name="seats" min="1" max="8" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3" required></div><button type="submit" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (<span id="publish-price">${App.config.prices.base}</span> ‚ÇΩ)</button></form></div>`;
            },
            
            getPassengerRequestFormTemplate() {
                 const optionsHtml = App.config.cities.map(city => `<option value="${city}">${city}</option>`).join('');
                return `<div class="p-5"><h2 class="text-lg font-bold mb-4">–í–∞—à–∞ –∑–∞—è–≤–∫–∞</h2><form id="passenger-request-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                            <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                ${optionsHtml}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                            <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                ${optionsHtml}
                            </select>
                        </div>
                    </div>
                    <input type="hidden" name="from" required><input type="hidden" name="to" required>
                    <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                    <div id="ferry-toggle-container-request" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                        <label for="via-ferry-toggle-request" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º</label>
                        <div class="flex items-center space-x-3">
                             <span id="ferry-price-increase-request" class="text-sm text-slate-800 font-semibold hidden">(+${App.config.prices.ferrySurcharge} ‚ÇΩ)</span>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="via-ferry-toggle-request" name="via_ferry" class="sr-only peer">
                                <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞</label>
                            <input type="date" name="date" id="date-request" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è</label>
                            <input type="time" name="time" id="time-request" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                        </div>
                    </div>
                    <div class="form-error-time text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div>
                     <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label>
                        <input type="number" name="seats" min="1" max="8" class="w-full p-3 border border-slate-200 rounded-lg text-sm" value="1" required>
                    </div>
                    <button type="submit" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É (<span id="request-price">${App.config.prices.base}</span> ‚ÇΩ)</button>
                    </form></div>`;
            },
            
            getParcelRequestFormTemplate() {
                const optionsHtml = App.config.cities.map(city => `<option value="${city}">${city}</option>`).join('');
                return `<div class="p-5"><h2 class="text-lg font-bold mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É</h2><form id="parcel-request-form" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                            <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                ${optionsHtml}
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                            <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required>
                                <option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>
                                ${optionsHtml}
                            </select>
                        </div>
                    </div>
                    <input type="hidden" name="from" required><input type="hidden" name="to" required>
                    <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                    <div><label for="date-parcel" class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label><input type="date" name="date" id="date-parcel" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div><div class="bg-slate-100 p-3 rounded-lg text-center text-slate-600 text-sm">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏: <span class="font-bold">${App.config.prices.parcel} ‚ÇΩ</span></div><button type="submit" class="text-sm btn w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ—Å—ã–ª–∫—É</button></form></div>`;
            },
            
            getProfileFormTemplate() {
                return `<div class="p-5"><h2 class="text-lg font-bold mb-4">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2><p class="text-xs text-slate-600 mb-4">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤–∞—à–µ –∏–º—è. –ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –±—ã—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è.</p><form id="profile-form" class="space-y-4"><div><label for="profile-name" class="block text-xs font-medium text-slate-600 mb-2">–í–∞—à–µ –∏–º—è</label><input type="text" name="fullName" id="profile-name" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–ê–ª–µ–∫—Å–µ–π" required></div><div><label for="profile-car" class="block text-xs font-medium text-slate-600 mb-2">–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω—ã (–¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π)</label><input type="text" name="driverCar" id="profile-car" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="Kia Rio"></div><button type="submit" class="text-sm btn w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></form></div>`;
            },
        },
        
        // --- UTILITY FUNCTIONS ---
        utils: {
            formatDate(dateString) {
                const date = new Date(dateString + 'T00:00:00'); // Ensure date is parsed as local
                const today = new Date();
                const tomorrow = new Date();
                tomorrow.setDate(tomorrow.getDate() + 1);
                today.setHours(0,0,0,0);
                tomorrow.setHours(0,0,0,0);

                if (date.getTime() === today.getTime()) return '–°–µ–≥–æ–¥–Ω—è';
                if (date.getTime() === tomorrow.getTime()) return '–ó–∞–≤—Ç—Ä–∞';
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            },

            async sendTelegramNotification(chatId, text) {
                const botToken = App.config.botToken;
                if (!botToken) {
                    console.warn('Telegram Bot Token is not configured. Skipping notification.');
                    return;
                }
                const url = `https://api.telegram.org/bot${botToken}/sendMessage`;
                const payload = {
                    chat_id: chatId,
                    text: text,
                    parse_mode: 'Markdown',
                    reply_markup: {
                        inline_keyboard: [
                            [
                                {
                                    text: '–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ', // –¢–µ–∫—Å—Ç –Ω–∞ –∫–Ω–æ–ø–∫–µ
                                    url: 'https://t.me/poputka12_bot?startapp='  // –°—Å—ã–ª–∫–∞, –∫–æ—Ç–æ—Ä—É—é –æ—Ç–∫—Ä–æ–µ—Ç –∫–Ω–æ–ø–∫–∞
                                }
                            ]
                        ]
                    }
                };

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error("Telegram API error:", errorBody);
                    }
                } catch (error) {
                    console.error("Failed to send Telegram message:", error);
                }
            }
        },

        setDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            ['date-offer', 'date-request', 'date-parcel'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.setAttribute('min', today);
                    input.value = today;
                }
            });
        },
        
        resetForm(form) {
            form.reset();
            this.setDefaultDates();
            form.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
            const ferryContainer = form.querySelector('#ferry-toggle-container');
            if(ferryContainer) {
                ferryContainer.classList.add('hidden');
            }
            const detourContainer = form.querySelector('#cheboksary-detour-container');
            if(detourContainer) {
                detourContainer.classList.add('hidden');
            }
        },

        renderFilteredList() {
            const { from, to, date, type } = this.state.currentFilters;
            let filtered = [...this.state.allRequests];

            if (from) {
                filtered = filtered.filter(item => item.from === from);
            }
            if (to) {
                filtered = filtered.filter(item => item.to === to);
            }
            if (date) {
                filtered = filtered.filter(item => item.ride_date === date);
            }
            if (type !== 'all' && this.state.userRole === 'driver') {
                filtered = filtered.filter(item => item.type === type);
            }

            this.render.list(filtered, 'passengerRequest');
        },
    };

    // --- APP START ---
    // [–ò–ó–ú–ï–ù–ï–ù–û] –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ Supabase –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.
    // –≠—Ç–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç "–±–µ–ª—ã–π —ç–∫—Ä–∞–Ω", –µ—Å–ª–∏ —Å–∫—Ä–∏–ø—Ç –Ω–µ —Å–º–æ–≥ –∑–∞–≥—Ä—É–∑–∏—Ç—å—Å—è.
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof supabase === 'undefined') {
            document.getElementById('main-content').innerHTML = `
                <div class="p-5 text-center text-red-500">
                    <h2 class="font-bold">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</h2>
                    <p class="text-sm">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–∞—à–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
                </div>
            `;
            return;
        }
        App.init();
    });
    </script>
</body>
</html>
