<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ü–æ–ø—É—Ç–∫–∞ 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }

        .screen {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .screen.active {
            display: block;
        }

        #chat-screen.active,
        #my-trips-screen.active {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .role-btn.active,
        .direction-buttons button.active,
        #time-interval-buttons button.active {
            background-color: #1e293b;
            /* slate-800 */
            color: white;
        }

        .message {
            max-width: 75%;
            word-wrap: break-word;
        }

        .message.sent {
            align-self: flex-end;
            background-color: #3b82f6;
            color: white;
        }

        /* blue-500 */
        .message.received {
            align-self: flex-start;
            background-color: #e5e7eb;
            color: #1f2937;
        }

        /* gray-200 */

        /* Role Switcher Styles */
        #role-switcher {
            position: relative;
        }

        #role-bg {
            position: absolute;
            width: 36px;
            height: 36px;
            top: 2px;
            left: 2px;
            background-color: white;
            border-radius: 9999px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transform: translateX(0px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        #role-switcher.driver #role-bg {
            transform: translateX(36px);
        }

        #role-passenger-icon,
        #role-driver-icon {
            transition: opacity 0.3s ease-in-out;
        }

        #role-passenger-icon span,
        #role-driver-icon span {
            display: inline-block;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #role-switcher.passenger #role-passenger-icon span,
        #role-switcher.driver #role-driver-icon span {
            transform: scale(1.15) rotate(-8deg);
        }

        #role-switcher.passenger #role-driver-icon,
        #role-switcher.driver #role-passenger-icon {
            opacity: 0.5;
        }

        #profile-avatar-btn img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Modal Styles */
        .modal-overlay {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
        }

        .modal-overlay.show {
            opacity: 1;
        }

        .modal.show {
            transform: translateY(0);
        }

        /* Filter Button Styles */
        .filter-type-btn.active {
            background-color: white;
            color: #1e293b;
            box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        }

        /* Collapsible Filter Styles */
        #filter-toggle-icon {
            transition: transform 0.3s ease-in-out;
        }

        #filter-content {
            max-height: 500px;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out;
            opacity: 1;
        }

        #filter-content.collapsed {
            max-height: 0;
            opacity: 0;
        }

        #filter-toggle-btn.collapsed #filter-toggle-icon {
            transform: rotate(-180deg);
        }

        /* Custom scrollbar for better look */
        #main-content::-webkit-scrollbar {
            width: 4px;
        }

        #main-content::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 20px;
        }

        #main-content::-webkit-scrollbar-track {
            background: transparent;
        }
    </style>
</head>

<body class="bg-slate-50 text-slate-800 overflow-hidden">

    <div id="app-container" class="h-screen w-screen max-w-md mx-auto bg-white flex flex-col">
        <header id="app-header" class="p-4 flex items-center justify-between bg-white border-b border-slate-200 flex-shrink-0 sticky top-0 z-10">
            <div class="w-10 h-10 flex items-center justify-center">
                <button id="backButton" class="text-slate-500 hover:text-slate-800 transition-colors invisible">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m15 18-6-6 6-6" />
                    </svg>
                </button>
            </div>
            <h1 id="headerTitle" class="text-base font-semibold text-slate-800 text-center flex-grow hidden">–ü–∞—Å—Å–∞–∂–∏—Ä</h1>
            <div class="flex items-center gap-3">
                <div id="role-switcher" class="flex items-center p-1 bg-slate-100 rounded-full cursor-pointer">
                    <div id="role-bg"></div>
                    <div id="role-passenger-icon" class="relative z-10 w-9 h-9 flex items-center justify-center text-xl">
                        <span>üßç</span>
                    </div>
                    <div id="role-driver-icon" class="relative z-10 w-9 h-9 flex items-center justify-center text-xl">
                        <span>üöó</span>
                    </div>
                </div>
                <button id="profile-avatar-btn" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 font-semibold flex items-center justify-center overflow-hidden shrink-0">
                    <!-- Avatar will be rendered here by JS -->
                </button>
            </div>
        </header>

        <main id="main-content" class="flex-grow overflow-y-auto relative">
            <div id="passenger-home-screen" class="screen active"></div>
            <div id="driver-dashboard-screen" class="screen"></div>
            <div id="offer-screen" class="screen"></div>
            <div id="passenger-request-screen" class="screen"></div>
            <div id="parcel-request-screen" class="screen"></div>
            <div id="list-screen" class="screen"></div>
            <div id="success-screen" class="screen"></div>
            <div id="chat-screen" class="screen"></div>
            <div id="my-trips-screen" class="screen"></div>
            <div id="profile-screen" class="screen"></div>
        </main>

        <footer id="app-footer" class="p-5 border-t border-slate-200 bg-white flex-shrink-0">
            <a href="https://t.me/poputka12rus" target="_blank" class="text-sm btn w-full bg-sky-100 text-sky-800 font-bold py-3 px-4 rounded-xl hover:bg-sky-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m22 2-7 20-4-9-9-4Z" />
                    <path d="M22 2 11 13" />
                </svg>
                <span>–ù–∞—à–∞ –≥—Ä—É–ø–ø–∞ –≤ Telegram</span>
            </a>
            <a href="https://devtol.ru" target="_blank" class="block text-center text-xs text-slate-400 mt-2 hover:underline">
                powered by devtol
            </a>
        </footer>
    </div>

    <div id="booking-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
    <div id="booking-modal" class="modal fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto bg-transparent z-50 transform translate-y-full transition-transform duration-300">
        <div class="p-4">
            <div id="booking-options-container" class="space-y-2 bg-slate-100 rounded-xl">
            </div>
            <button id="booking-modal-cancel-btn" class="w-full p-3 mt-2 bg-white rounded-xl text-blue-500 text-lg font-semibold">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // --- SUPABASE CLIENT INITIALIZATION ---
        const SUPABASE_URL = 'https://scqkpvmmoaolahpxinja.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjcWtwdm1tb2FvbGFocHhpbmphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDIwNDksImV4cCI6MjA3MTE3ODA0OX0.Uz5L2SF8O1EGf_efkq5FLi6g1yl7LlmnTZi_eLnISMw';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- APPLICATION LOGIC ---
        const App = {
            state: {
                currentUser: null,
                userProfile: null,
                userRole: 'passenger',
                selectedRoute: null,
                navigationHistory: ['passenger-home-screen'],
                allRequests: [],
                currentFilters: {
                    from: '',
                    to: '',
                    date: '',
                    type: 'all'
                },
                currentConversation: {
                    id: null,
                    subscription: null
                }
            },

            config: {
                botToken: '8202443902:AAEMonQpK3FmOAh5Up4GPBmI89q1mHz8LpY',
                prices: {
                    base: 600,
                    parcel: 300,
                    cheboksary: 400,
                    ferrySurcharge: 100
                },
                routes: {
                    koz_yo: {
                        from: '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫',
                        to: '–ô–æ—à–∫–∞—Ä-–û–ª–∞'
                    }
                },
                cities: ['–ô–æ—à–∫–∞—Ä-–û–ª–∞', '–ß–µ–±–æ–∫—Å–∞—Ä—ã', '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫'],
            },

            async init() {
                try {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    Telegram.WebApp.setHeaderColor('#ffffff');
                    Telegram.WebApp.setBackgroundColor('#f8fafc');
                    this.state.currentUser = Telegram.WebApp.initDataUnsafe?.user;
                } catch (e) {
                    console.warn("Telegram WebApp script not found or running in browser.");
                    this.state.currentUser = {
                        id: 12345678,
                        first_name: '–¢–µ—Å—Ç',
                        username: 'testuser'
                    };
                }

                if (this.state.currentUser) {
                    await this.ensureUserProfile();
                }

                this.bindHandlers();
                this.render.allScreens();
                this.render.updateRoleSwitcherUI();
                this.bindEvents();
                this.setDefaultDates();
                this.render.updateAvatar();
            },

            async ensureUserProfile() {
                if (!this.state.currentUser) return;

                let {
                    data: profile,
                    error: fetchError
                } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .eq('id', this.state.currentUser.id)
                    .single();

                if (fetchError && fetchError.code === 'PGRST116') {
                    const {
                        data: newProfile,
                        error: insertError
                    } = await supabaseClient
                        .from('profiles')
                        .insert({
                            id: this.state.currentUser.id,
                            username: this.state.currentUser.username,
                            full_name: this.state.currentUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'
                        })
                        .select()
                        .single();

                    if (insertError) {
                        console.error('Error creating user profile:', insertError);
                        return;
                    }
                    profile = newProfile;
                } else if (fetchError) {
                    console.error('Error fetching user profile:', fetchError);
                    return;
                }

                this.state.userProfile = profile;
            },

            bindHandlers() {
                for (const key in this.handlers) {
                    if (typeof this.handlers[key] === 'function') {
                        this.handlers[key] = this.handlers[key].bind(this);
                    }
                }
            },

            bindEvents() {
                document.body.addEventListener('click', (e) => {
                    const button = e.target.closest('button, #role-switcher, #booking-modal-overlay');
                    if (!button) return;

                    const {
                        id,
                        classList,
                        dataset
                    } = button;

                    if (id === 'role-switcher') {
                        this.handlers.onRoleSwitch();
                        return;
                    }

                    if (button.closest('#time-interval-buttons')) {
                        this.handlers.onTimeSelect(button);
                        return;
                    }

                    if (button.classList.contains('filter-type-btn')) {
                        this.handlers.onFilterTypeSelect(button);
                        return;
                    }

                    const clickHandlers = {
                        'backButton': () => this.navigation.back(),
                        'view-driver-offers-btn': this.handlers.onViewDriverOffers,
                        'create-passenger-request-btn': () => this.navigation.to('passenger-request-screen', '–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ–µ–∑–¥–∫—É'),
                        'send-parcel-btn': () => this.navigation.to('parcel-request-screen', '–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É'),
                        'view-passenger-requests-btn': this.handlers.onViewPassengerRequests,
                        'publish-ride-btn': this.handlers.onPublishRideClick,
                        'my-trips-btn': this.handlers.onMyTripsClick,
                        'back-to-hub-btn': this.handlers.onBackToHub,
                        'profile-avatar-btn': () => this.navigation.to('profile-screen', '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å'),
                        'booking-modal-cancel-btn': this.handlers.onBookingModalCancel,
                        'booking-modal-overlay': this.handlers.onBookingModalCancel,
                        'apply-filters-btn': this.handlers.onApplyFilters,
                        'reset-filters-btn': this.handlers.onResetFilters,
                        'filter-toggle-btn': this.handlers.onToggleFilter,
                    };

                    if (clickHandlers[id]) {
                        clickHandlers[id]();
                        return;
                    }

                    if (classList.contains('offer-ride-btn')) this.handlers.onOfferRideToRequest(dataset.requestId);
                    if (classList.contains('request-booking-btn')) this.handlers.onRequestBooking(dataset.offerId);
                    if (classList.contains('detour-booking-btn')) this.handlers.onDetourBookingClick(dataset.offer);
                    if (classList.contains('confirm-booking-segment-btn')) this.handlers.onConfirmBookingSegment(dataset);
                    if (classList.contains('cancel-booking-btn')) this.handlers.onCancelBooking(dataset.bookingId);
                    if (classList.contains('accept-booking-btn')) this.handlers.onUpdateBookingStatus(dataset.bookingId, 'confirmed');
                    if (classList.contains('reject-booking-btn')) this.handlers.onUpdateBookingStatus(dataset.bookingId, 'rejected');
                    if (classList.contains('delete-offer-btn')) this.handlers.onDeleteOffer(dataset.offerId);
                    if (classList.contains('cancel-request-btn')) this.handlers.onCancelRequest(dataset.requestId);
                    if (classList.contains('cancel-parcel-request-btn')) this.handlers.onCancelParcelRequest(dataset.requestId);
                });

                document.body.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formHandlers = {
                        'passenger-request-form': () => this.handlers.onPassengerRequestSubmit(e.target),
                        'parcel-request-form': () => this.handlers.onParcelRequestSubmit(e.target),
                        'offer-form': () => this.handlers.onOfferSubmit(e.target),
                        'chat-form': () => this.handlers.onSendMessage(e.target),
                        'profile-form': () => this.handlers.onProfileSubmit(e.target),
                    };
                    if (formHandlers[e.target.id]) formHandlers[e.target.id]();
                });

                document.body.addEventListener('change', (e) => {
                    if (e.target.id === 'via-ferry-toggle' || e.target.id === 'via-cheboksary-detour-toggle') {
                        this.handlers.onRouteOptionChange(e.target);
                    }
                    if (e.target.name === 'from-select' || e.target.name === 'to-select') {
                        this.handlers.onRouteDropdownChange(e.target);
                    }
                });
            },

            handlers: {
                onRoleSwitch() {
                    this.state.userRole = this.state.userRole === 'passenger' ? 'driver' : 'passenger';
                    this.render.updateRoleSwitcherUI();
                    const newScreen = this.state.userRole === 'passenger' ? 'passenger-home-screen' : 'driver-dashboard-screen';
                    const newTitle = this.state.userRole === 'passenger' ? '–ü–∞—Å—Å–∞–∂–∏—Ä' : '–ö–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è';
                    this.state.navigationHistory = [newScreen];
                    this.navigation.to(newScreen, newTitle);
                },

                onToggleFilter() {
                    const content = document.getElementById('filter-content');
                    const btn = document.getElementById('filter-toggle-btn');
                    content.classList.toggle('collapsed');
                    btn.classList.toggle('collapsed');
                },

                onRouteOptionChange(checkbox) {
                    const form = checkbox.closest('form');
                    const detourToggle = form.querySelector('#via-cheboksary-detour-toggle');
                    if (checkbox.id === 'via-ferry-toggle' && checkbox.checked) {
                        detourToggle.checked = false;
                        form.querySelector('#cheboksary-detour-container').classList.add('hidden');
                    }
                    this.handlers.onRouteDropdownChange(form.querySelector('select'));
                },

                onRouteDropdownChange(selectElement) {
                    const form = selectElement.closest('form');
                    const fromSelect = form.querySelector('select[name="from-select"]');
                    const toSelect = form.querySelector('select[name="to-select"]');
                    const fromValue = fromSelect.value;
                    const toValue = toSelect.value;

                    form.querySelector('input[name="from"]').value = fromValue;
                    form.querySelector('input[name="to"]').value = toValue;

                    Array.from(toSelect.options).forEach(opt => {
                        opt.disabled = opt.value === fromValue;
                    });
                    Array.from(fromSelect.options).forEach(opt => {
                        opt.disabled = opt.value === toValue;
                    });

                    const isKozYoRoute = (fromValue === '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫' && toValue === '–ô–æ—à–∫–∞—Ä-–û–ª–∞') || (fromValue === '–ô–æ—à–∫–∞—Ä-–û–ª–∞' && toValue === '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫');
                    const ferryContainer = form.querySelector('#ferry-toggle-container');
                    const detourContainer = form.querySelector('#cheboksary-detour-container');
                    const ferryToggle = form.querySelector('#via-ferry-toggle');

                    if (isKozYoRoute) {
                        ferryContainer.classList.remove('hidden');
                        detourContainer.classList.toggle('hidden', ferryToggle.checked);
                    } else {
                        ferryContainer.classList.add('hidden');
                        ferryToggle.checked = false;
                        detourContainer.classList.add('hidden');
                        form.querySelector('#via-cheboksary-detour-toggle').checked = false;
                    }

                    this.render.updateOfferOptionsUI(form);

                    if (fromValue && toValue) {
                        form.querySelector('.form-error-direction').classList.add('hidden');
                    }
                },

                onTimeSelect(button) {
                    const form = button.closest('form');
                    button.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    form.querySelector('#timeIntervalInput').value = button.textContent;
                    form.querySelector('.form-error-time').classList.add('hidden');
                },

                onPublishRideClick() {
                    if (!this.state.userProfile?.driver_car?.trim()) {
                        this.navigation.to('profile-screen', '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å');
                    } else {
                        this.navigation.to('offer-screen', '–ù–æ–≤–∞—è –ø–æ–µ–∑–¥–∫–∞');
                    }
                },

                async onViewDriverOffers() {
                    this.navigation.to('list-screen', '–ü–æ–µ–∑–¥–∫–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π');
                    document.getElementById('filter-section-container').classList.add('hidden');

                    // FIX: Replaced query to 'ride_offers_with_seats' view with manual calculation to avoid permission errors.
                    const today = new Date().toISOString().split('T')[0];

                    // 1. Fetch upcoming offers
                    const {
                        data: offers,
                        error: offersError
                    } = await supabaseClient
                        .from('ride_offers')
                        .select('*')
                        .gte('ride_date', today)
                        .order('ride_date', {
                            ascending: true
                        })
                        .order('ride_time', {
                            ascending: true
                        });

                    if (offersError) {
                        console.error("Error fetching offers:", offersError);
                        this.render.list([], 'driverOffer'); // Render empty list on error
                        return;
                    }

                    if (!offers || offers.length === 0) {
                        this.render.list([], 'driverOffer');
                        return;
                    }

                    const offerIds = offers.map(o => o.id);

                    // 2. Fetch confirmed bookings for these offers
                    const {
                        data: bookings,
                        error: bookingsError
                    } = await supabaseClient
                        .from('bookings')
                        .select('offer_id')
                        .in('offer_id', offerIds)
                        .eq('status', 'confirmed');

                    if (bookingsError) {
                        console.error("Error fetching bookings:", bookingsError);
                        // Proceeding without accurate seat count, but it's better than crashing.
                    }

                    // 3. Calculate remaining seats and filter out full rides
                    const bookingCounts = bookings ? bookings.reduce((acc, booking) => {
                        acc[booking.offer_id] = (acc[booking.offer_id] || 0) + 1;
                        return acc;
                    }, {}) : {};

                    const offersWithSeats = offers
                        .map(offer => ({
                            ...offer,
                            seats_left: offer.seats - (bookingCounts[offer.id] || 0)
                        }))
                        .filter(offer => offer.seats_left > 0);

                    // 4. Check current user's bookings to show correct button state
                    if (!this.state.currentUser) {
                        // Render without checking user's booking status if user is not loaded yet
                        this.render.list(offersWithSeats, 'driverOffer');
                        return;
                    }

                    const {
                        data: userBookings,
                        error: userBookingsError
                    } = await supabaseClient
                        .from('bookings')
                        .select('id, offer_id')
                        .eq('passenger_id', this.state.currentUser.id)
                        .in('offer_id', offersWithSeats.map(o => o.id));

                    if (userBookingsError) {
                        console.error("Error fetching user bookings:", userBookingsError);
                    }

                    const userBookingsMap = new Map(userBookings?.map(b => [b.offer_id, b.id]) || []);

                    const augmentedOffers = offersWithSeats.map(offer => ({
                        ...offer,
                        currentUserBookingId: userBookingsMap.get(offer.id) || null
                    }));

                    this.render.list(augmentedOffers, 'driverOffer');
                },


                async onViewPassengerRequests() {
                    this.navigation.to('list-screen', '–ó–∞—è–≤–∫–∏ –æ—Ç –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤');
                    document.getElementById('filter-section-container').classList.remove('hidden');
                    document.getElementById('filter-type-container').classList.toggle('hidden', this.state.userRole !== 'driver');
                    document.getElementById('list-container').innerHTML = `<div class="text-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-800 mx-auto"></div></div>`;

                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('filter-date')?.setAttribute('min', today);

                    const {
                        data: rides,
                        error: ridesError
                    } = await supabaseClient.from('ride_requests')
                        .select('*')
                        .gte('ride_date', today)
                        .eq('status', 'open')
                        .order('ride_date', {
                            ascending: true
                        });

                    const {
                        data: parcels,
                        error: parcelsError
                    } = await supabaseClient.from('parcel_requests')
                        .select('*').gte('ride_date', today).order('ride_date', {
                            ascending: true
                        });

                    if (ridesError || parcelsError) {
                        console.error(ridesError || parcelsError);
                        return;
                    }

                    const allRequests = [
                        ...rides.map(r => ({ ...r,
                            type: 'ride'
                        })),
                        ...parcels.map(p => ({ ...p,
                            type: 'parcel'
                        }))
                    ].sort((a, b) => new Date(a.ride_date) - new Date(b.ride_date));

                    this.state.allRequests = allRequests;
                    this.handlers.onResetFilters();
                },

                onFilterTypeSelect(button) {
                    button.parentElement.querySelectorAll('.filter-type-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                },

                onApplyFilters() {
                    this.state.currentFilters = {
                        from: document.getElementById('filter-from').value,
                        to: document.getElementById('filter-to').value,
                        date: document.getElementById('filter-date').value,
                        type: document.querySelector('#filter-type-buttons .active').dataset.type
                    };
                    this.renderFilteredList();
                },

                onResetFilters() {
                    this.state.currentFilters = {
                        from: '',
                        to: '',
                        date: '',
                        type: 'all'
                    };
                    document.getElementById('filter-from').value = '';
                    document.getElementById('filter-to').value = '';
                    document.getElementById('filter-date').value = '';
                    document.querySelectorAll('#filter-type-buttons .filter-type-btn').forEach(btn => {
                        btn.classList.toggle('active', btn.dataset.type === 'all');
                    });
                    this.renderFilteredList();
                },

                async onMyTripsClick() {
                    // FIX: Add a guard clause to prevent error if currentUser is not yet available.
                    if (!this.state.currentUser) {
                        console.error("User not initialized, cannot fetch trips.");
                        return;
                    }
                    this.navigation.to('my-trips-screen', '–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏');
                    const container = document.getElementById('my-trips-container');
                    container.innerHTML = `<div class="text-center p-8"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-slate-800 mx-auto"></div></div>`;

                    const today = new Date().toISOString().split('T')[0];

                    if (this.state.userRole === 'driver') {
                        const {
                            data,
                            error
                        } = await supabaseClient.from('ride_offers')
                            .select(`*, bookings(*, profiles(full_name, username))`)
                            .eq('driver_id', this.state.currentUser.id)
                            .gte('ride_date', today)
                            .order('ride_date', {
                                ascending: true
                            });
                        if (error) {
                            console.error(error);
                            return;
                        }
                        this.render.myTrips(data, 'driver');
                    } else {
                        const [bookingsRes, requestsRes, parcelsRes] = await Promise.all([
                            supabaseClient.from('bookings').select(`*, ride_offers(*)`).eq('passenger_id', this.state.currentUser.id).gte('ride_offers.ride_date', today).order('created_at', {
                                ascending: false
                            }),
                            supabaseClient.from('ride_requests').select(`*`).eq('passenger_id', this.state.currentUser.id).in('status', ['open', 'pending_confirmation']).gte('ride_date', today).order('created_at', {
                                ascending: false
                            }),
                            supabaseClient.from('parcel_requests').select(`*`).eq('sender_id', this.state.currentUser.id).gte('ride_date', today).order('created_at', {
                                ascending: false
                            })
                        ]);

                        if (bookingsRes.error || requestsRes.error || parcelsRes.error) {
                            console.error(bookingsRes.error || requestsRes.error || parcelsRes.error);
                            return;
                        }
                        this.render.myTrips({
                            bookings: bookingsRes.data,
                            requests: requestsRes.data,
                            parcels: parcelsRes.data
                        }, 'passenger');
                    }
                },

                async onOfferSubmit(form) {
                    const formData = new FormData(form);
                    const from = formData.get('from');
                    const to = formData.get('to');

                    if (!from || !to) {
                        form.querySelector('.form-error-direction').classList.remove('hidden');
                        return;
                    }
                    if (!this.state.userProfile.full_name || !this.state.userProfile.driver_car) {
                        console.error('Profile info missing');
                        return;
                    }

                    const viaFerry = form.querySelector('#via-ferry-toggle').checked;
                    const viaCheboksaryDetour = form.querySelector('#via-cheboksary-detour-toggle').checked;
                    const isCheboksaryRoute = from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';

                    let finalPrice = isCheboksaryRoute ? this.config.prices.cheboksary : this.config.prices.base;
                    if (!isCheboksaryRoute && viaFerry) {
                        finalPrice += this.config.prices.ferrySurcharge;
                    }

                    const {
                        error
                    } = await supabaseClient.from('ride_offers').insert({
                        driver_id: this.state.currentUser.id,
                        driver_username: this.state.currentUser.username,
                        "from": from,
                        "to": to,
                        ride_date: formData.get('date'),
                        ride_time: formData.get('time'),
                        seats: parseInt(formData.get('seats')),
                        price: finalPrice,
                        driver_name: this.state.userProfile.full_name,
                        driver_car: this.state.userProfile.driver_car,
                        via_cheboksary: isCheboksaryRoute,
                        via_ferry: !isCheboksaryRoute && viaFerry,
                        via_cheboksary_detour: !isCheboksaryRoute && !viaFerry && viaCheboksaryDetour
                    });

                    if (error) {
                        console.error(error);
                        return;
                    }
                    this.resetForm(form);
                    this.render.success('–ü–æ–µ–∑–¥–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞', '–ü–∞—Å—Å–∞–∂–∏—Ä—ã —Ç–µ–ø–µ—Ä—å –≤–∏–¥—è—Ç –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.', '–í –∫–∞–±–∏–Ω–µ—Ç');
                },

                async onPassengerRequestSubmit(form) {
                    const formData = new FormData(form);
                    const from = formData.get('from');
                    const to = formData.get('to');
                    const timeInterval = formData.get('timeInterval');

                    let valid = true;
                    if (!from || !to) {
                        form.querySelector('.form-error-direction').classList.remove('hidden');
                        valid = false;
                    }
                    if (!timeInterval) {
                        form.querySelector('.form-error-time').classList.remove('hidden');
                        valid = false;
                    }
                    if (!valid) return;

                    const isCheboksaryRoute = from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';
                    const price = isCheboksaryRoute ? this.config.prices.cheboksary : this.config.prices.base;

                    const {
                        error
                    } = await supabaseClient.from('ride_requests').insert({
                        passenger_id: this.state.currentUser.id,
                        passenger_username: this.state.currentUser.username,
                        "from": from,
                        "to": to,
                        ride_date: formData.get('date'),
                        time_interval: timeInterval,
                        passenger_name: this.state.userProfile.full_name,
                        price: price,
                        status: 'open'
                    });

                    if (error) {
                        console.error(error);
                        return;
                    }
                    this.resetForm(form);
                    this.render.success('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª–∏ —Å–∫–æ—Ä–æ —É–≤–∏–¥—è—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É.', '–û—Ç–ª–∏—á–Ω–æ');
                },

                async onParcelRequestSubmit(form) {
                    const formData = new FormData(form);
                    const from = formData.get('from');
                    const to = formData.get('to');
                    if (!from || !to) {
                        form.querySelector('.form-error-direction').classList.remove('hidden');
                        return;
                    }

                    const {
                        error
                    } = await supabaseClient.from('parcel_requests').insert({
                        sender_id: this.state.currentUser.id,
                        sender_username: this.state.currentUser.username,
                        "from": from,
                        "to": to,
                        ride_date: formData.get('date'),
                        sender_name: this.state.userProfile.full_name,
                        price: this.config.prices.parcel
                    });

                    if (error) {
                        console.error(error);
                        return;
                    }
                    this.resetForm(form);
                    this.render.success('–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—ã–ª–∫—É —Å–æ–∑–¥–∞–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É.', '–û—Ç–ª–∏—á–Ω–æ');
                },

                async onProfileSubmit(form) {
                    const formData = new FormData(form);
                    const fullName = formData.get('fullName').trim();
                    if (!fullName) {
                        console.error('Full name is required');
                        return;
                    }

                    const {
                        data,
                        error
                    } = await supabaseClient.from('profiles')
                        .update({
                            full_name: fullName,
                            driver_car: formData.get('driverCar').trim()
                        })
                        .eq('id', this.state.currentUser.id)
                        .select()
                        .single();

                    if (error) {
                        console.error('Profile save error:', error);
                        return;
                    }
                    this.state.userProfile = data;
                    this.navigation.back();
                },

                async onRequestBooking(offerId, bookingDetails = null) {
                    if (!this.state.userProfile) {
                        console.error('Profile not loaded');
                        return;
                    }

                    const {
                        data: existingBooking
                    } = await supabaseClient.from('bookings').select('id').eq('offer_id', offerId).eq('passenger_id', this.state.currentUser.id).limit(1);
                    if (existingBooking && existingBooking.length > 0) {
                        console.warn('Booking already exists');
                        return;
                    }

                    const {
                        data: offer,
                        error: offerError
                    } = await supabaseClient.from('ride_offers').select('*').eq('id', offerId).single();
                    if (offerError || !offer) {
                        console.error("Offer not found");
                        return;
                    }

                    const bookingData = {
                        offer_id: offerId,
                        passenger_id: this.state.currentUser.id,
                        status: 'pending',
                        booking_segment: bookingDetails?.segment || 'full',
                        price: bookingDetails?.price || offer.price,
                        from_city: bookingDetails?.from || offer.from,
                        to_city: bookingDetails?.to || offer.to,
                    };

                    const {
                        error: insertError
                    } = await supabaseClient.from('bookings').insert(bookingData);
                    if (insertError) {
                        console.error('Booking insert error:', insertError);
                        return;
                    }

                    const passengerName = this.state.userProfile.full_name || '–ù–æ–≤—ã–π –ø–∞—Å—Å–∞–∂–∏—Ä';
                    const message = `*–ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ!*\n\n–ü–∞—Å—Å–∞–∂–∏—Ä *${passengerName}* —Ö–æ—á–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –ø–æ–µ–∑–¥–∫—É: ${offer.from} ‚Üí ${offer.to} (${this.utils.formatDate(offer.ride_date)}).\n\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏.`;
                    this.utils.sendTelegramNotification(offer.driver_id, message);

                    this.render.success('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª—å —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É. –í—ã –º–æ–∂–µ—Ç–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –µ–µ —Å—Ç–∞—Ç—É—Å –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏".', '–û—Ç–ª–∏—á–Ω–æ');
                },

                onDetourBookingClick(offerData) {
                    this.render.bookingOptionsModal(JSON.parse(decodeURIComponent(offerData)));
                },

                onConfirmBookingSegment(dataset) {
                    this.handlers.onBookingModalCancel();
                    this.handlers.onRequestBooking(dataset.offerId, {
                        segment: dataset.segment,
                        price: parseInt(dataset.price),
                        from: dataset.from,
                        to: dataset.to,
                    });
                },

                onBookingModalCancel() {
                    const overlay = document.getElementById('booking-modal-overlay');
                    const modal = document.getElementById('booking-modal');
                    overlay.classList.remove('show');
                    modal.classList.remove('show');
                    setTimeout(() => {
                        overlay.classList.add('hidden');
                    }, 300);
                },

                async onUpdateBookingStatus(bookingId, status) {
                    const {
                        data: booking,
                        error
                    } = await supabaseClient.from('bookings').select('*, ride_offers(*)').eq('id', bookingId).single();
                    if (error || !booking) {
                        console.error('Booking not found:', error);
                        return;
                    }

                    const offer = booking.ride_offers;
                    const isPassengerAction = this.state.currentUser.id === booking.passenger_id;
                    const isLinkedToRequest = offer?.linked_request_id;

                    if (isPassengerAction && isLinkedToRequest) { // Passenger accepts/rejects a direct offer from driver
                        if (status === 'rejected') {
                            await Promise.all([
                                supabaseClient.from('ride_requests').update({
                                    status: 'open'
                                }).eq('id', offer.linked_request_id),
                                supabaseClient.from('bookings').delete().eq('id', bookingId),
                                supabaseClient.from('ride_offers').delete().eq('id', offer.id)
                            ]);
                            this.utils.sendTelegramNotification(offer.driver_id, `–ü–∞—Å—Å–∞–∂–∏—Ä –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (${offer.from} ‚Üí ${offer.to}).`);
                        } else if (status === 'confirmed') {
                            await Promise.all([
                                supabaseClient.from('bookings').update({
                                    status: 'confirmed'
                                }).eq('id', bookingId),
                                supabaseClient.from('ride_requests').update({
                                    status: 'closed'
                                }).eq('id', offer.linked_request_id)
                            ]);
                            this.utils.sendTelegramNotification(offer.driver_id, `–ü–∞—Å—Å–∞–∂–∏—Ä –ø—Ä–∏–Ω—è–ª –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ (${offer.from} ‚Üí ${offer.to})!`);
                        }
                    } else { // Standard driver action
                        await supabaseClient.from('bookings').update({
                            status
                        }).eq('id', bookingId);
                        let message = '';
                        if (status === 'confirmed') {
                            message = `*–ë—Ä–æ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!* ‚úÖ\n–í–æ–¥–∏—Ç–µ–ª—å *${offer.driver_name}* –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –≤–∞—à—É –ø–æ–µ–∑–¥–∫—É: ${offer.from} ‚Üí ${offer.to} –Ω–∞ ${this.utils.formatDate(offer.ride_date)}.`;
                        } else if (status === 'rejected') {
                            message = `*–ë—Ä–æ–Ω—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞* ‚ùå\n–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –≤–æ–¥–∏—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª –≤–∞—à—É –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–µ–∑–¥–∫—É: ${offer.from} ‚Üí ${offer.to}.`;
                        }
                        if (message) this.utils.sendTelegramNotification(booking.passenger_id, message);
                    }
                    this.handlers.onMyTripsClick();
                },

                async onCancelBooking(bookingId) {
                    const {
                        data: booking,
                        error
                    } = await supabaseClient.from('bookings').select('*, ride_offers(*)').eq('id', bookingId).single();
                    if (error || !booking) {
                        console.error('Error fetching booking to cancel:', error);
                        return;
                    }

                    const offer = booking.ride_offers;
                    const passengerName = this.state.userProfile.full_name || '–ü–∞—Å—Å–∞–∂–∏—Ä';
                    const message = `*–ü–∞—Å—Å–∞–∂–∏—Ä –æ—Ç–º–µ–Ω–∏–ª –±—Ä–æ–Ω—å* üßç‚Äç‚ôÇÔ∏è\n${passengerName} –æ—Ç–º–µ–Ω–∏–ª(–∞) –±—Ä–æ–Ω—å –Ω–∞ –≤–∞—à—É –ø–æ–µ–∑–¥–∫—É: ${offer.from} ‚Üí ${offer.to} –Ω–∞ ${this.utils.formatDate(offer.ride_date)}.`;
                    this.utils.sendTelegramNotification(offer.driver_id, message);

                    await supabaseClient.from('bookings').delete().eq('id', bookingId);

                    const currentScreen = this.state.navigationHistory.at(-1);
                    (currentScreen === 'list-screen') ? this.handlers.onViewDriverOffers(): this.handlers.onMyTripsClick();
                },

                async onDeleteOffer(offerId) {
                    const {
                        data: bookings,
                        error
                    } = await supabaseClient.from('bookings').select('passenger_id, ride_offers(from, to, ride_date)').eq('offer_id', offerId);
                    if (error) {
                        console.error('Failed to fetch bookings for notification:', error);
                    }

                    if (bookings?.length > 0) {
                        const offerDetails = bookings[0].ride_offers;
                        const message = `*–ü–æ–µ–∑–¥–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞* ‚ùå\n–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–º–µ–Ω–∏–ª –ø–æ–µ–∑–¥–∫—É ${offerDetails.from} ‚Üí ${offerDetails.to} –Ω–∞ ${this.utils.formatDate(offerDetails.ride_date)}. –í–∞—à–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.`;
                        await Promise.all(bookings.map(b => this.utils.sendTelegramNotification(b.passenger_id, message)));
                    }

                    await supabaseClient.from('ride_offers').delete().eq('id', offerId);
                    this.handlers.onMyTripsClick();
                },

                async onCancelRequest(requestId) {
                    await supabaseClient.from('ride_requests').delete().eq('id', requestId);
                    this.handlers.onMyTripsClick();
                },

                async onCancelParcelRequest(requestId) {
                    await supabaseClient.from('parcel_requests').delete().eq('id', requestId);
                    this.handlers.onMyTripsClick();
                },

                onBackToHub() {
                    const screen = this.state.userRole === 'driver' ? 'driver-dashboard-screen' : 'passenger-home-screen';
                    const title = this.state.userRole === 'driver' ? '–ö–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è' : '–ü–∞—Å—Å–∞–∂–∏—Ä';
                    this.state.navigationHistory = [screen];
                    this.navigation.to(screen, title);
                },

                async onOfferRideToRequest(requestId) {
                    if (!this.state.userProfile?.driver_car?.trim()) {
                        this.navigation.to('profile-screen', '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å');
                        return;
                    }

                    const {
                        data: request,
                        error: requestError
                    } = await supabaseClient.from('ride_requests').select('*').eq('id', requestId).single();
                    if (requestError || !request) {
                        console.error("Request not found:", requestError);
                        return;
                    }

                    const timeForOffer = request.time_interval.split('-')[0] + ':00';
                    const {
                        data: newOffer,
                        error: offerError
                    } = await supabaseClient
                        .from('ride_offers')
                        .insert({
                            driver_id: this.state.currentUser.id,
                            driver_username: this.state.currentUser.username,
                            driver_name: this.state.userProfile.full_name,
                            driver_car: this.state.userProfile.driver_car,
                            from: request.from,
                            to: request.to,
                            ride_date: request.ride_date,
                            ride_time: timeForOffer,
                            seats: 1,
                            price: request.price,
                            linked_request_id: requestId
                        })
                        .select()
                        .single();

                    if (offerError) {
                        console.error("Failed to create offer:", offerError);
                        return;
                    }

                    const {
                        error: bookingError
                    } = await supabaseClient.from('bookings').insert({
                        offer_id: newOffer.id,
                        passenger_id: request.passenger_id,
                        status: 'pending',
                        price: newOffer.price,
                        from_city: newOffer.from,
                        to_city: newOffer.to
                    });

                    if (bookingError) {
                        console.error("Failed to create booking:", bookingError);
                        return;
                    }

                    await supabaseClient.from('ride_requests').update({
                        status: 'pending_confirmation'
                    }).eq('id', requestId);

                    const message = `*–í–∞–º –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ –ø–æ–µ–∑–¥–∫—É!* üöó\n–í–æ–¥–∏—Ç–µ–ª—å *${newOffer.driver_name}* (${newOffer.driver_car}) –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –Ω–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É ${newOffer.from} ‚Üí ${newOffer.to}.\n\n–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏".`;
                    await this.utils.sendTelegramNotification(request.passenger_id, message);

                    const button = document.querySelector(`.offer-ride-btn[data-request-id="${requestId}"]`);
                    if (button) {
                        button.textContent = '–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                        button.disabled = true;
                        button.classList.remove('bg-green-500', 'hover:bg-green-600');
                        button.classList.add('bg-slate-400', 'cursor-not-allowed');
                    }
                }
            },

            navigation: {
                to(screenId, title) {
                    if (App.state.currentConversation.subscription) {
                        supabaseClient.removeChannel(App.state.currentConversation.subscription);
                        App.state.currentConversation.subscription = null;
                    }

                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    document.getElementById(screenId)?.classList.add('active');
                    document.getElementById('headerTitle').textContent = title;

                    if (App.state.navigationHistory.at(-1) !== screenId) {
                        App.state.navigationHistory.push(screenId);
                    }

                    document.getElementById('backButton').classList.toggle('invisible', App.state.navigationHistory.length <= 1);

                    if (screenId === 'offer-screen') App.render.populateOfferForm();
                    if (screenId === 'profile-screen') App.render.populateProfileForm();

                    document.getElementById('main-content').scrollTop = 0;
                },
                back() {
                    if (App.state.navigationHistory.length <= 1) return;

                    App.state.navigationHistory.pop();
                    const lastScreen = App.state.navigationHistory.at(-1);

                    const titles = {
                        'passenger-home-screen': '–ü–∞—Å—Å–∞–∂–∏—Ä',
                        'driver-dashboard-screen': '–ö–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è',
                        'list-screen': document.getElementById('headerTitle').textContent,
                        'my-trips-screen': '–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏',
                        'profile-screen': '–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å'
                    };

                    this.to(lastScreen, titles[lastScreen] || '–ü–æ–ø—É—Ç–∫–∞ 12');
                    App.state.navigationHistory.pop(); // Remove the screen again because `to` adds it
                }
            },

            render: {
                allScreens() {
                    const screenTemplates = {
                        'passenger-home-screen': `<div class="p-5"><div class="text-center mb-6"><h2 class="text-xl font-bold mb-1">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?</h2></div><div class="space-y-3"><button id="view-driver-offers-btn" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">–°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–µ–∑–¥–∫–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π</button><button id="create-passenger-request-btn" class="text-sm btn w-full bg-slate-100 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-200">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–µ–∑–¥–∫—É</button><button id="send-parcel-btn" class="text-sm btn w-full bg-purple-100 text-purple-800 font-bold py-3 px-4 rounded-xl hover:bg-purple-200">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É</button><button id="my-trips-btn" class="text-sm mt-4 btn w-full border border-slate-300 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-100">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏ –∏ –∑–∞—è–≤–∫–∏</button></div></div>`,
                        'driver-dashboard-screen': `<div class="p-5"><div class="text-center mb-6"><h2 class="text-xl font-bold mb-1">–ö–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è</h2></div><div class="space-y-3"><button id="view-passenger-requests-btn" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">–°–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏</button><button id="publish-ride-btn" class="text-sm btn w-full bg-slate-100 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-200">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–≤–æ—é –ø–æ–µ–∑–¥–∫—É</button><button id="my-trips-btn" class="text-sm mt-4 btn w-full border border-slate-300 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-100">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</button></div></div>`,
                        'offer-screen': this.getOfferFormTemplate(),
                        'passenger-request-screen': this.getPassengerRequestFormTemplate(),
                        'parcel-request-screen': this.getParcelRequestFormTemplate(),
                        'list-screen': `<div class="p-4 space-y-4"><div id="filter-section-container" class="hidden"><div class="p-4 bg-slate-50 rounded-xl border border-slate-200"><button id="filter-toggle-btn" class="flex justify-between items-center w-full mb-3"><h3 class="text-base font-semibold text-slate-800">–§–∏–ª—å—Ç—Ä—ã</h3><svg id="filter-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="m18 15-6-6-6 6"/></svg></button><div id="filter-content" class="space-y-3"><div class="grid grid-cols-2 gap-3"><div><label for="filter-from" class="block text-xs font-medium text-slate-600 mb-1">–û—Ç–∫—É–¥–∞</label><select id="filter-from" name="from" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white"><option value="">–õ—é–±–æ–π</option>${App.config.cities.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div><div><label for="filter-to" class="block text-xs font-medium text-slate-600 mb-1">–ö—É–¥–∞</label><select id="filter-to" name="to" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white"><option value="">–õ—é–±–æ–π</option>${App.config.cities.map(c => `<option value="${c}">${c}</option>`).join('')}</select></div></div><div><label for="filter-date" class="block text-xs font-medium text-slate-600 mb-1">–î–∞—Ç–∞</label><input type="date" id="filter-date" name="date" class="w-full p-2 border border-slate-200 rounded-lg text-sm"></div><div id="filter-type-container"><label class="block text-xs font-medium text-slate-600 mb-1">–¢–∏–ø –∑–∞—è–≤–∫–∏</label><div id="filter-type-buttons" class="flex p-1 bg-slate-200 rounded-lg"><button data-type="all" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600 active">–í—Å–µ</button><button data-type="ride" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button><button data-type="parcel" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600">–ü–æ—Å—ã–ª–∫–∏</button></div></div><div class="flex gap-3 pt-2"><button id="reset-filters-btn" class="flex-1 text-sm btn border border-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-100">–°–±—Ä–æ—Å–∏—Ç—å</button><button id="apply-filters-btn" class="flex-1 text-sm btn bg-slate-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div></div></div></div><div id="list-container" class="space-y-3"></div><div id="no-results" class="text-center text-slate-500 py-10 hidden"><h3 id="no-results-title" class="text-base font-semibold"></h3><p id="no-results-text" class="text-xs"></p></div></div>`,
                        'success-screen': `<div class="p-5 flex flex-col items-center justify-center h-full text-center"><div class="mb-4"><svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div><h2 id="success-title" class="text-xl font-bold mt-4 mb-1"></h2><p id="success-text" class="text-slate-600 mb-8 text-sm"></p><button id="back-to-hub-btn" class="text-sm btn w-full max-w-xs bg-slate-800 text-white font-bold py-3 px-4 rounded-lg"></button></div>`,
                        'chat-screen': `<div class="flex-1 flex flex-col h-full"><div id="chat-messages" class="flex-1 p-4 space-y-4 overflow-y-auto flex flex-col"></div><div id="chat-footer" class="p-3 border-t border-slate-200 flex-shrink-0"><form id="chat-form" class="flex items-center space-x-2"><input id="chat-message-input" type="text" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." required><button type="submit" class="p-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg></button></form></div></div>`,
                        'my-trips-screen': `<div class="flex-1 flex flex-col"><div id="my-trips-container" class="p-5 space-y-4 flex-1"></div></div>`,
                        'profile-screen': this.getProfileFormTemplate(),
                    };
                    for (const [id, html] of Object.entries(screenTemplates)) {
                        document.getElementById(id).innerHTML = html;
                    }
                },

                updateRoleSwitcherUI() {
                    const switcher = document.getElementById('role-switcher');
                    switcher.classList.toggle('driver', App.state.userRole === 'driver');
                    switcher.classList.toggle('passenger', App.state.userRole !== 'driver');
                },

                updateAvatar() {
                    const avatarBtn = document.getElementById('profile-avatar-btn');
                    const user = App.state.currentUser;
                    if (user?.photo_url) {
                        avatarBtn.innerHTML = `<img src="${user.photo_url}" alt="Avatar">`;
                    } else {
                        avatarBtn.innerHTML = `<span>${user?.first_name?.charAt(0).toUpperCase() || '?'}</span>`;
                    }
                },

                list(items, type) {
                    const container = document.getElementById('list-container');
                    const noResults = document.getElementById('no-results');
                    container.innerHTML = '';
                    noResults.classList.toggle('hidden', items?.length > 0);
                    if (items?.length === 0) {
                        document.getElementById('no-results-title').textContent = type === 'driverOffer' ? '–ü–æ–µ–∑–¥–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ó–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                        document.getElementById('no-results-text').textContent = type === 'driverOffer' ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ—é –∑–∞—è–≤–∫—É.' : '–ü–æ –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
                        return;
                    }
                    container.innerHTML = items.map(item => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${ type === 'driverOffer' ? this.getDriverOfferCard(item) : this.getPassengerRequestCard(item) }</div>`).join('');
                },

                myTrips(data, role) {
                    const container = document.getElementById('my-trips-container');
                    container.innerHTML = '';

                    if (role === 'driver') {
                        if (!data || data.length === 0) {
                            container.innerHTML = `<div class="text-center text-slate-500 py-10"><h3 class="text-base font-semibold">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</h3><p class="text-xs">–û–ø—É–±–ª–∏–∫—É–π—Ç–µ –ø–æ–µ–∑–¥–∫—É, —á—Ç–æ–±—ã –æ–Ω–∞ –∑–¥–µ—Å—å –ø–æ—è–≤–∏–ª–∞—Å—å.</p></div>`;
                            return;
                        }
                        container.innerHTML = data.map(offer => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyDriverOfferCard(offer)}</div>`).join('');
                    } else {
                        const {
                            bookings,
                            requests,
                            parcels
                        } = data;
                        if (!bookings?.length && !requests?.length && !parcels?.length) {
                            container.innerHTML = `<div class="text-center text-slate-500 py-10"><h3 class="text-base font-semibold">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</h3><p class="text-xs">–ó–∞–±—Ä–æ–Ω–∏—Ä—É–π—Ç–µ –ø–æ–µ–∑–¥–∫—É –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ –∑–∞—è–≤–∫—É.</p></div>`;
                            return;
                        }
                        let content = '';
                        if (bookings?.length) {
                            content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-2">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>` + bookings.map(b => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyBookingCard(b)}</div>`).join('');
                        }
                        if (requests?.length) {
                            content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-4">–ú–æ–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–µ–∑–¥–∫–∏</h3>` + requests.map(r => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyRequestCard(r)}</div>`).join('');
                        }
                        if (parcels?.length) {
                            content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-4">–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</h3>` + parcels.map(p => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyParcelRequestCard(p)}</div>`).join('');
                        }
                        container.innerHTML = content;
                    }
                },

                success(title, text, buttonText) {
                    document.getElementById('success-title').textContent = title;
                    document.getElementById('success-text').textContent = text;
                    document.getElementById('back-to-hub-btn').textContent = buttonText;
                    App.navigation.to('success-screen', '–£—Å–ø–µ—Ö');
                },

                populateOfferForm() {
                    const profile = App.state.userProfile;
                    if (!profile) return;
                    const form = document.getElementById('offer-form');
                    form.querySelector('#driver-name').value = profile.full_name || '';
                    form.querySelector('#driver-car').value = profile.driver_car || '';
                },

                populateProfileForm() {
                    const profile = App.state.userProfile;
                    const form = document.getElementById('profile-form');
                    form.querySelector('#profile-name').value = profile?.full_name || App.state.currentUser?.first_name || '';
                    form.querySelector('#profile-car').value = profile?.driver_car || '';
                },

                updateOfferOptionsUI(form) {
                    const from = form.querySelector('input[name="from"]').value;
                    const to = form.querySelector('input[name="to"]').value;
                    const isCheboksaryRoute = from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';
                    let price = isCheboksaryRoute ? App.config.prices.cheboksary : App.config.prices.base;

                    if (!isCheboksaryRoute && form.querySelector('#via-ferry-toggle')?.checked) {
                        price += App.config.prices.ferrySurcharge;
                    }

                    form.querySelector('#ferry-price-increase').classList.toggle('hidden', isCheboksaryRoute || !form.querySelector('#via-ferry-toggle')?.checked);
                    form.querySelector('#publish-price').textContent = price;
                },

                bookingOptionsModal(offer) {
                    const container = document.getElementById('booking-options-container');
                    const priceFull = App.config.prices.base;
                    const pricePart = App.config.prices.cheboksary;

                    container.innerHTML = `
                    <button class="confirm-booking-segment-btn w-full flex justify-between items-center text-left p-3 text-blue-500 text-base" data-offer-id="${offer.id}" data-segment="full" data-price="${priceFull}" data-from="${offer.from}" data-to="${offer.to}"><span>${offer.from} ‚Üí ${offer.to}</span><span class="font-semibold">${priceFull} ‚ÇΩ</span></button>
                    <div class="h-px bg-slate-200"></div>
                    <button class="confirm-booking-segment-btn w-full flex justify-between items-center text-left p-3 text-blue-500 text-base" data-offer-id="${offer.id}" data-segment="start_to_cheb" data-price="${pricePart}" data-from="${offer.from}" data-to="–ß–µ–±–æ–∫—Å–∞—Ä—ã"><span>${offer.from} ‚Üí –ß–µ–±–æ–∫—Å–∞—Ä—ã</span><span class="font-semibold">${pricePart} ‚ÇΩ</span></button>
                    <div class="h-px bg-slate-200"></div>
                    <button class="confirm-booking-segment-btn w-full flex justify-between items-center text-left p-3 text-blue-500 text-base" data-offer-id="${offer.id}" data-segment="cheb_to_end" data-price="${pricePart}" data-from="–ß–µ–±–æ–∫—Å–∞—Ä—ã" data-to="${offer.to}"><span>–ß–µ–±–æ–∫—Å–∞—Ä—ã ‚Üí ${offer.to}</span><span class="font-semibold">${pricePart} ‚ÇΩ</span></button>
                `;

                    const overlay = document.getElementById('booking-modal-overlay');
                    const modal = document.getElementById('booking-modal');
                    overlay.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        overlay.classList.add('show');
                        modal.classList.add('show');
                    });
                },

                getDriverOfferCard(item) {
                    const seatsLeft = item.seats_left;
                    const seatsText = seatsLeft === 1 ? '1 –º–µ—Å—Ç–æ' : (seatsLeft > 1 && seatsLeft < 5 ? `${seatsLeft} –º–µ—Å—Ç–∞` : `${seatsLeft} –º–µ—Å—Ç`);

                    let buttonHtml;
                    if (item.currentUserBookingId) {
                        buttonHtml = `<button class="cancel-booking-btn btn w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors text-sm" data-booking-id="${item.currentUserBookingId}">–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å</button>`;
                    } else {
                        const buttonClass = seatsLeft <= 0 ? 'bg-slate-300' : 'bg-blue-500 hover:bg-blue-600';
                        const buttonText = seatsLeft <= 0 ? '–ú–µ—Å—Ç –Ω–µ—Ç' : '–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å';
                        if (item.via_cheboksary_detour) {
                            const offerData = encodeURIComponent(JSON.stringify(item));
                            buttonHtml = `<button class="detour-booking-btn btn w-full text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm ${buttonClass}" data-offer='${offerData}' ${seatsLeft <= 0 ? 'disabled' : ''}>${buttonText}</button>`;
                        } else {
                            buttonHtml = `<button class="request-booking-btn btn w-full text-white font-bold py-2 px-4 rounded-lg transition-colors text-sm ${buttonClass}" data-offer-id="${item.id}" ${seatsLeft <= 0 ? 'disabled' : ''}>${buttonText}</button>`;
                        }
                    }

                    const routeInfo = [
                        item.via_ferry ? `<div class="text-xs font-semibold text-blue-800 bg-blue-100 rounded-full px-3 py-1 text-center">‚õ¥Ô∏è –ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º</div>` : '',
                        item.via_cheboksary_detour ? `<div class="text-xs font-semibold text-orange-800 bg-orange-100 rounded-full px-3 py-1 text-center"> detour via Cheboksary</div>` : '',
                        item.via_cheboksary ? `<div class="text-xs font-semibold text-green-800 bg-green-100 rounded-full px-3 py-1 text-center">–î–æ/–ò–∑ –ß–µ–±–æ–∫—Å–∞—Ä</div>` : ''
                    ].filter(Boolean).join('');

                    return `<div class="flex justify-between items-center"><div class="font-bold text-base">${item.from} ‚Üí ${item.to}</div><div class="text-base font-semibold">${item.price} ‚ÇΩ</div></div><div class="text-slate-600 text-sm"><p><strong>–î–∞—Ç–∞:</strong> ${App.utils.formatDate(item.ride_date)} –≤ <strong>${item.ride_time}</strong></p><p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> ${item.driver_name} –Ω–∞ ${item.driver_car}</p><p><strong>–°–≤–æ–±–æ–¥–Ω–æ:</strong> <span class="font-bold ${seatsLeft <= 1 ? 'text-red-500' : 'text-green-600'}">${seatsText}</span></p></div>${routeInfo}${buttonHtml}`;
                },

                getPassengerRequestCard(item) {
                    const isParcel = item.type === 'parcel';
                    const buttonHtml = isParcel ? `<a href="https://t.me/${item.sender_username}" target="_blank" class="block w-full text-center bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm">–°–≤—è–∑–∞—Ç—å—Å—è</a>` : `<button class="offer-ride-btn btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors text-sm" data-request-id="${item.id}">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>`;

                    return `<div class="flex justify-between items-center"><div class="font-bold text-base">${item.from} ‚Üí ${item.to}</div><div class="text-base font-semibold">${item.price} ‚ÇΩ</div></div><div class="text-slate-600 text-sm"><p><strong>–î–∞—Ç–∞:</strong> ${App.utils.formatDate(item.ride_date)}</p><p><strong>${isParcel ? '–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å' : '–ü–∞—Å—Å–∞–∂–∏—Ä'}:</strong> ${isParcel ? item.sender_name : item.passenger_name}</p>${!isParcel ? `<p><strong>–í—Ä–µ–º—è:</strong> ${item.time_interval}</p>` : ''}</div><div class="flex items-center gap-2">${isParcel ? `<div class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">–ü–æ—Å—ã–ª–∫–∞</div>` : `<div class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">–ü–∞—Å—Å–∞–∂–∏—Ä</div>`}</div>${App.state.userRole === 'driver' ? buttonHtml : ''}`;
                },

                getMyDriverOfferCard(offer) {
                    const confirmedBookings = offer.bookings.filter(b => b.status === 'confirmed');
                    const pendingBookings = offer.bookings.filter(b => b.status === 'pending');
                    const seatsLeft = offer.seats - confirmedBookings.length;

                    let bookingsHtml = '<div class="text-xs text-slate-500">–ü–æ–∫–∞ –Ω–µ—Ç –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.</div>';
                    if (offer.bookings.length > 0) {
                        bookingsHtml = `
                        ${pendingBookings.length ? `<h4 class="font-semibold mt-2 text-sm">–ó–∞—è–≤–∫–∏ –Ω–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:</h4><div class="space-y-2">${pendingBookings.map(b => `<div class="flex justify-between items-center bg-amber-50 p-2 rounded-lg"><span class="text-sm">${b.profiles?.full_name || '–ü–∞—Å—Å–∞–∂–∏—Ä'}</span><div class="flex gap-2"><button class="accept-booking-btn bg-green-500 text-white text-xs font-bold py-1 px-2 rounded" data-booking-id="${b.id}">–ü—Ä–∏–Ω—è—Ç—å</button><button class="reject-booking-btn bg-red-500 text-white text-xs font-bold py-1 px-2 rounded" data-booking-id="${b.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button></div></div>`).join('')}</div>` : ''}
                        ${confirmedBookings.length ? `<h4 class="font-semibold mt-2 text-sm">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –ø–∞—Å—Å–∞–∂–∏—Ä—ã:</h4><div class="space-y-2">${confirmedBookings.map(b => `<div class="flex justify-between items-center bg-slate-50 p-2 rounded-lg"><span class="text-sm">${b.profiles?.full_name || '–ü–∞—Å—Å–∞–∂–∏—Ä'}</span>${b.profiles?.username ? `<a href="https://t.me/${b.profiles.username}" target="_blank" class="text-xs bg-blue-500 text-white font-semibold py-1 px-2 rounded-md hover:bg-blue-600">–ù–∞–ø–∏—Å–∞—Ç—å</a>` : ''}</div>`).join('')}</div>` : ''}
                    `;
                    }

                    return `<div class="flex justify-between items-center"><div><div class="font-bold text-base">${offer.from} ‚Üí ${offer.to}</div><div class="text-xs text-slate-500">${App.utils.formatDate(offer.ride_date)} –≤ ${offer.ride_time}</div></div><div class="text-base font-semibold">${offer.price} ‚ÇΩ</div></div><div class="text-slate-600 text-sm"><p><strong>–°–≤–æ–±–æ–¥–Ω–æ –º–µ—Å—Ç:</strong> <span class="font-bold ${seatsLeft <= 1 ? 'text-red-500' : 'text-green-600'}">${seatsLeft} –∏–∑ ${offer.seats}</span></p></div><div class="border-t border-slate-100 pt-2 mt-2">${bookingsHtml}</div><button class="delete-offer-btn btn w-full bg-red-50 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-100 transition-colors mt-2 text-sm" data-offer-id="${offer.id}">–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>`;
                },

                getMyBookingCard(booking) {
                    const offer = booking.ride_offers;
                    if (!offer) return `<div class="text-red-500 text-sm">–û—à–∏–±–∫–∞: –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–µ–∑–¥–∫–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.</div>`;

                    const statusInfo = {
                        pending: {
                            class: 'bg-amber-100 text-amber-800',
                            text: '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è'
                        },
                        confirmed: {
                            class: 'bg-green-100 text-green-800',
                            text: '–í–æ–¥–∏—Ç–µ–ª—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª'
                        },
                        rejected: {
                            class: 'bg-red-100 text-red-800',
                            text: '–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–∫–ª–æ–Ω–∏–ª'
                        }
                    };

                    let currentStatus = statusInfo[booking.status];
                    let actionButtons = `<div class="flex items-center gap-3">${booking.status === 'confirmed' && offer.driver_username ? `<a href="https://t.me/${offer.driver_username}" target="_blank" class="text-xs text-blue-600 hover:underline font-semibold">–ù–∞–ø–∏—Å–∞—Ç—å –≤–æ–¥–∏—Ç–µ–ª—é</a>` : ''}${booking.status !== 'rejected' ? `<button class="cancel-booking-btn text-xs text-red-600 hover:underline" data-booking-id="${booking.id}">–û—Ç–º–µ–Ω–∏—Ç—å</button>` : ''}</div>`;

                    if (booking.status === 'pending' && offer.linked_request_id) {
                        currentStatus.text = '–û–∂–∏–¥–∞–µ—Ç –≤–∞—à–µ–≥–æ —Ä–µ—à–µ–Ω–∏—è';
                        actionButtons = `<div class="flex items-center gap-3"><button class="reject-booking-btn text-xs bg-red-100 text-red-700 font-semibold py-1 px-3 rounded-lg" data-booking-id="${booking.id}">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button><button class="accept-booking-btn text-xs bg-green-100 text-green-700 font-semibold py-1 px-3 rounded-lg" data-booking-id="${booking.id}">–ü—Ä–∏–Ω—è—Ç—å</button></div>`;
                    }

                    return `<div class="flex justify-between items-start"><div><div class="font-bold text-base">${booking.from_city} ‚Üí ${booking.to_city}</div><div class="text-xs text-slate-500">${App.utils.formatDate(offer.ride_date)} –≤ ${offer.ride_time}</div><div class="text-xs text-slate-500">–í–æ–¥–∏—Ç–µ–ª—å: ${offer.driver_name} (${offer.driver_car})</div></div><div class="text-base font-semibold">${booking.price} ‚ÇΩ</div></div><div class="flex justify-between items-center mt-2"><span class="text-xs font-semibold px-2.5 py-0.5 rounded-full ${currentStatus.class}">${currentStatus.text}</span>${actionButtons}</div>`;
                },

                getMyRequestCard(request) {
                    if (request.status === 'pending_confirmation') {
                        return `<div class="flex justify-between items-start opacity-60"><div><div class="font-bold text-base">${request.from} ‚Üí ${request.to}</div><div class="text-xs text-slate-500">${App.utils.formatDate(request.ride_date)} (–≤—Ä–µ–º—è: ${request.time_interval})</div></div><div class="text-base font-semibold">${request.price} ‚ÇΩ</div></div><div class="text-center text-sm text-amber-700 font-semibold bg-amber-50 p-2 rounded-lg mt-2">–û–∂–∏–¥–∞–µ—Ç –≤–∞—à–µ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ "–ú–æ–∏—Ö –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è—Ö"</div>`;
                    }
                    return `<div class="flex justify-between items-start"><div><div class="font-bold text-base">${request.from} ‚Üí ${request.to}</div><div class="text-xs text-slate-500">${App.utils.formatDate(request.ride_date)} (–≤—Ä–µ–º—è: ${request.time_interval})</div></div><div class="text-base font-semibold">${request.price} ‚ÇΩ</div></div><div class="flex justify-end items-center mt-2"><button class="cancel-request-btn text-xs text-red-600 hover:underline" data-request-id="${request.id}">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button></div>`;
                },

                getMyParcelRequestCard(parcel) {
                    return `<div class="flex justify-between items-start"><div><div class="font-bold text-base">${parcel.from} ‚Üí ${parcel.to}</div><div class="text-xs text-slate-500">${App.utils.formatDate(parcel.ride_date)}</div></div><div class="text-base font-semibold">${parcel.price} ‚ÇΩ</div></div><div class="flex justify-between items-center mt-2"><div class="bg-purple-100 text-purple-800 text-xs font-semibold px-2.5 py-0.5 rounded-full">–ü–æ—Å—ã–ª–∫–∞</div><button class="cancel-parcel-request-btn text-xs text-red-600 hover:underline" data-request-id="${parcel.id}">–û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É</button></div>`;
                },

                getFormTemplate(title, formId, fieldsHtml, buttonHtml) {
                    const optionsHtml = App.config.cities.map(city => `<option value="${city}">${city}</option>`).join('');
                    const directionHtml = `<div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label><select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>${optionsHtml}</select></div><div><label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label><select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option>${optionsHtml}</select></div></div><input type="hidden" name="from" required><input type="hidden" name="to" required><div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>`;
                    return `<div class="p-5"><h2 class="text-lg font-bold mb-4">${title}</h2><form id="${formId}" class="space-y-4">${directionHtml}${fieldsHtml}${buttonHtml}</form></div>`;
                },

                getOfferFormTemplate() {
                    const fields = `<div id="ferry-toggle-container" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between"><label for="via-ferry-toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º</label><div class="flex items-center space-x-3"><span id="ferry-price-increase" class="text-sm text-slate-800 font-semibold hidden">(+${App.config.prices.ferrySurcharge} ‚ÇΩ)</span><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-ferry-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label></div></div><div id="cheboksary-detour-container" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between"><label for="via-cheboksary-detour-toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ó–∞–µ–∑–∂–∞—é –≤ –ß–µ–±–æ–∫—Å–∞—Ä—ã</label><label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-cheboksary-detour-toggle" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div></label></div><div class="grid grid-cols-2 gap-4"><div><label class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞</label><input type="date" name="date" id="date-offer" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div><div><label class="block text-xs font-medium text-slate-600 mb-2">–í—Ä–µ–º—è</label><input type="time" name="time" id="time-offer" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div></div><input type="hidden" name="driverName" id="driver-name"><input type="hidden" name="driverCar" id="driver-car"><div><label class="block text-xs font-medium text-slate-600 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label><input type="number" name="seats" min="1" max="8" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3" required></div>`;
                    const button = `<button type="submit" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (<span id="publish-price">${App.config.prices.base}</span> ‚ÇΩ)</button>`;
                    return this.getFormTemplate('–î–∞–Ω–Ω—ã–µ –æ –ø–æ–µ–∑–¥–∫–µ', 'offer-form', fields, button);
                },

                getPassengerRequestFormTemplate() {
                    const timeButtons = ['04-06', '06-08', '08-10', '10-12', '12-14', '14-16', '16-18', '18-20'].map(t => `<button type="button" class="btn p-2 border border-slate-200 rounded-lg text-xs">${t}</button>`).join('');
                    const fields = `<input type="date" name="date" id="date-request" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required><div><label class="block text-xs font-medium text-slate-600 mb-2">–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è –≤—ã–µ–∑–¥–∞</label><div id="time-interval-buttons" class="grid grid-cols-2 sm:grid-cols-4 gap-2">${timeButtons}</div><input type="hidden" name="timeInterval" id="timeIntervalInput" required><div class="form-error-time text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div></div>`;
                    const button = `<button type="submit" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>`;
                    return this.getFormTemplate('–í–∞—à–∞ –∑–∞—è–≤–∫–∞', 'passenger-request-form', fields, button);
                },

                getParcelRequestFormTemplate() {
                    const fields = `<div><label for="date-parcel" class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label><input type="date" name="date" id="date-parcel" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div><div class="bg-slate-100 p-3 rounded-lg text-center text-slate-600 text-sm">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏: <span class="font-bold">${App.config.prices.parcel} ‚ÇΩ</span></div>`;
                    const button = `<button type="submit" class="text-sm btn w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ—Å—ã–ª–∫—É</button>`;
                    return this.getFormTemplate('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É', 'parcel-request-form', fields, button);
                },

                getProfileFormTemplate() {
                    return `<div class="p-5"><h2 class="text-lg font-bold mb-4">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2><p class="text-xs text-slate-600 mb-4">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤–∞—à–µ –∏–º—è. –ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –±—ã—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è.</p><form id="profile-form" class="space-y-4"><div><label for="profile-name" class="block text-xs font-medium text-slate-600 mb-2">–í–∞—à–µ –∏–º—è</label><input type="text" name="fullName" id="profile-name" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–ê–ª–µ–∫—Å–µ–π" required></div><div><label for="profile-car" class="block text-xs font-medium text-slate-600 mb-2">–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω—ã (–¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π)</label><input type="text" name="driverCar" id="profile-car" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="Kia Rio"></div><button type="submit" class="text-sm btn w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></form></div>`;
                },
            },

            utils: {
                formatDate(dateString) {
                    const date = new Date(dateString + 'T00:00:00');
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);
                    const tomorrow = new Date(today);
                    tomorrow.setDate(tomorrow.getDate() + 1);

                    if (date.getTime() === today.getTime()) return '–°–µ–≥–æ–¥–Ω—è';
                    if (date.getTime() === tomorrow.getTime()) return '–ó–∞–≤—Ç—Ä–∞';
                    return date.toLocaleDateString('ru-RU', {
                        day: 'numeric',
                        month: 'long'
                    });
                },

                async sendTelegramNotification(chatId, text) {
                    if (!App.config.botToken) return console.warn('Telegram Bot Token not configured.');

                    const url = `https://api.telegram.org/bot${App.config.botToken}/sendMessage`;
                    const payload = {
                        chat_id: chatId,
                        text: text,
                        parse_mode: 'Markdown',
                        reply_markup: {
                            inline_keyboard: [
                                [{
                                    text: '–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ',
                                    url: 'https://t.me/poputka12_bot?startapp='
                                }]
                            ]
                        }
                    };

                    try {
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload),
                        });
                        if (!response.ok) console.error("Telegram API error:", await response.json());
                    } catch (error) {
                        console.error("Failed to send Telegram message:", error);
                    }
                }
            },

            setDefaultDates() {
                const today = new Date().toISOString().split('T')[0];
                ['date-offer', 'date-request', 'date-parcel'].forEach(id => {
                    const input = document.getElementById(id);
                    if (input) {
                        input.min = today;
                        input.value = today;
                    }
                });
            },

            resetForm(form) {
                form.reset();
                this.setDefaultDates();
                form.querySelectorAll('.active').forEach(el => el.classList.remove('active'));
                form.querySelector('#ferry-toggle-container')?.classList.add('hidden');
                form.querySelector('#cheboksary-detour-container')?.classList.add('hidden');
            },

            renderFilteredList() {
                const {
                    from,
                    to,
                    date,
                    type
                } = this.state.currentFilters;
                let filtered = this.state.allRequests.filter(item =>
                    (!from || item.from === from) &&
                    (!to || item.to === to) &&
                    (!date || item.ride_date === date) &&
                    (type === 'all' || this.state.userRole !== 'driver' || item.type === type)
                );
                this.render.list(filtered, 'passengerRequest');
            },
        };

        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>

</html>

