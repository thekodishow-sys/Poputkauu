<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ü–æ–ø—É—Ç–∫–∞ 12</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: contain;
        }
        .screen { display: none; animation: fadeIn 0.3s ease-in-out; }
        .screen.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .role-btn.active, .direction-buttons button.active {
            background-color: #1e293b; /* slate-800 */
            color: white;
        }
        #time-interval-buttons button.active {
            background-color: #1e293b; /* slate-800 */
            color: white;
            border-color: #1e293b;
        }
        #time-interval-buttons button.active .text-slate-500 {
            color: #cbd5e1; /* slate-300 */
        }
        #role-switcher { position: relative; }
        #role-bg {
            position: absolute; width: 36px; height: 36px;
            top: 2px; left: 2px; background-color: white;
            border-radius: 9999px;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            transform: translateX(0px);
            transition: transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }
        #role-switcher.driver #role-bg { transform: translateX(36px); }
        #role-passenger-icon, #role-driver-icon { transition: opacity 0.3s ease-in-out; }
        #role-passenger-icon span, #role-driver-icon span {
            display: inline-block;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #role-switcher.passenger #role-passenger-icon span,
        #role-switcher.driver #role-driver-icon span { transform: scale(1.15) rotate(-8deg); }
        #role-switcher.passenger #role-driver-icon,
        #role-switcher.driver #role-passenger-icon { opacity: 0.5; }
        #profile-avatar-btn img { width: 100%; height: 100%; object-fit: cover; }
        .modal-overlay { opacity: 0; transition: opacity 0.3s ease-in-out; }
        .modal-overlay.show { opacity: 1; }
        .modal.show { transform: translateY(0); }
        .filter-type-btn.active { background-color: white; color: #1e293b; box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05); }
        #filter-toggle-icon { transition: transform 0.3s ease-in-out; }
        #filter-content {
            max-height: 500px; overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.3s ease-in-out; opacity: 1;
        }
        #filter-content.collapsed { max-height: 0; opacity: 0; }
        #filter-toggle-btn.collapsed #filter-toggle-icon { transform: rotate(-180deg); }
        #main-content::-webkit-scrollbar { width: 4px; }
        #main-content::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        #main-content::-webkit-scrollbar-track { background: transparent; }
        
        /* Partner Widget Slider Styles */
        .slider-container {
            position: relative;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
        }
        .slider-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .slide {
            flex: 0 0 100%;
            width: 100%;
            position: relative;
        }
        .slide-content {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem; /* p-4 */
            background: linear-gradient(to top, rgba(0,0,0,0.8), rgba(0,0,0,0));
            color: white;
        }
        .slider-dots {
            position: absolute;
            bottom: 0.5rem; /* bottom-2 */
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 0.5rem; /* gap-2 */
        }
        .dot {
            width: 8px;
            height: 8px;
            border-radius: 9999px;
            background-color: rgba(255, 255, 255, 0.5);
            transition: background-color 0.3s ease;
        }
        .dot.active {
            background-color: white;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 overflow-hidden">

    <div id="app-container" class="h-screen w-screen max-w-md mx-auto bg-white flex flex-col">
        <header id="app-header" class="p-4 flex items-center justify-between bg-white border-b border-slate-200 flex-shrink-0 sticky top-0 z-10">
            <div class="w-10 h-10 flex items-center justify-start">
                <button id="admin-plus-btn" data-action="navigateTo" data-screen="admin-panel-screen" class="text-slate-500 hover:text-slate-800 transition-colors hidden text-2xl font-light">+</button>
                <button id="backButton" data-action="back" class="text-slate-500 hover:text-slate-800 transition-colors invisible">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
                </button>
            </div>
            <div id="role-switcher" class="flex items-center p-1 bg-slate-100 rounded-full cursor-pointer">
                <div id="role-bg"></div>
                <div id="role-passenger-icon" class="relative z-10 w-9 h-9 flex items-center justify-center text-xl"><span>üßç</span></div>
                <div id="role-driver-icon" class="relative z-10 w-9 h-9 flex items-center justify-center text-xl"><span>üöó</span></div>
            </div>
            <div class="w-10 h-10 flex items-center justify-end">
                <button id="profile-avatar-btn" class="w-10 h-10 rounded-full bg-slate-200 text-slate-600 font-semibold flex items-center justify-center overflow-hidden shrink-0"></button>
            </div>
        </header>

        <main id="main-content" class="flex-grow overflow-y-auto relative">
            <div id="passenger-home-screen" class="screen active"></div>
            <div id="driver-dashboard-screen" class="screen"></div>
            <div id="offer-screen" class="screen"></div>
            <div id="passenger-request-screen" class="screen"></div>
            <div id="parcel-request-screen" class="screen"></div>
            <div id="list-screen" class="screen"></div>
            <div id="success-screen" class="screen"></div>
            <div id="my-trips-screen" class="screen"></div>
            <div id="profile-screen" class="screen"></div>
            <div id="admin-panel-screen" class="screen"></div>
            <div id="admin-edit-partner-screen" class="screen"></div>
        </main>
        
        <footer id="app-footer" class="p-5 border-t border-slate-200 bg-white flex-shrink-0">
            <a href="https://t.me/poputka12rus" target="_blank" class="text-sm btn w-full bg-sky-100 text-sky-800 font-bold py-3 px-4 rounded-xl hover:bg-sky-200 flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>
                <span>–ù–∞—à–∞ –≥—Ä—É–ø–ø–∞ –≤ Telegram</span>
            </a>
        </footer>
    </div>

    <div id="booking-modal-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
    <div id="booking-modal" class="modal fixed bottom-0 left-0 right-0 w-full max-w-md mx-auto bg-transparent z-50 transform translate-y-full transition-transform duration-300">
        <div class="p-4">
            <div id="booking-options-container" class="space-y-2 bg-slate-100 rounded-xl"></div>
            <button id="booking-modal-cancel-btn" class="w-full p-3 mt-2 bg-white rounded-xl text-blue-500 text-lg font-semibold">–û—Ç–º–µ–Ω–∞</button>
        </div>
    </div>

    <template id="passenger-home-screen-template">
        <div class="p-5">
            <div class="text-center mb-6"><h2 class="text-xl font-bold mb-1">–ß—Ç–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ —Å–¥–µ–ª–∞—Ç—å?</h2></div>
            <div class="space-y-3">
                <button data-action="viewDriverOffers" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">–°–º–æ—Ç—Ä–µ—Ç—å –ø–æ–µ–∑–¥–∫–∏ –≤–æ–¥–∏—Ç–µ–ª–µ–π</button>
                <button data-action="navigateTo" data-screen="passenger-request-screen" class="text-sm btn w-full bg-slate-100 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-200">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–µ–∑–¥–∫—É</button>
                <button data-action="myTrips" class="text-sm mt-4 btn w-full border border-slate-300 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-100">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏ –∏ –∑–∞—è–≤–∫–∏</button>
            </div>
            <div class="mt-8 partner-widget-container">
                <!-- Partner widget will be rendered here by JS -->
            </div>
        </div>
    </template>
    <template id="driver-dashboard-screen-template">
        <div class="p-5">
            <div class="text-center mb-6"><h2 class="text-xl font-bold mb-1">–ö–∞–±–∏–Ω–µ—Ç –≤–æ–¥–∏—Ç–µ–ª—è</h2></div>
            <div class="space-y-3">
                <button data-action="viewPassengerRequests" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-slate-800/10 hover:bg-slate-700">–°–º–æ—Ç—Ä–µ—Ç—å –∑–∞—è–≤–∫–∏</button>
                <button data-action="publishRide" class="text-sm btn w-full bg-slate-100 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-200">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å–≤–æ—é –ø–æ–µ–∑–¥–∫—É</button>
                <button data-action="myTrips" class="text-sm mt-4 btn w-full border border-slate-300 text-slate-800 font-bold py-3 px-4 rounded-xl hover:bg-slate-100">–ú–æ–∏ –ø–æ–µ–∑–¥–∫–∏</button>
            </div>
            <div class="mt-8 partner-widget-container">
                <!-- Partner widget will be rendered here by JS -->
            </div>
        </div>
    </template>
    <template id="list-screen-template">
         <div class="p-4 space-y-4">
            <div id="filter-section-container" class="hidden">
                <div class="p-4 bg-slate-50 rounded-xl border border-slate-200">
                    <button data-action="toggleFilter" id="filter-toggle-btn" class="flex justify-between items-center w-full mb-3">
                        <h3 class="text-base font-semibold text-slate-800">–§–∏–ª—å—Ç—Ä—ã</h3>
                        <svg id="filter-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-slate-500"><path d="m18 15-6-6-6 6"/></svg>
                    </button>
                    <div id="filter-content" class="space-y-3">
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="filter-from" class="block text-xs font-medium text-slate-600 mb-1">–û—Ç–∫—É–¥–∞</label>
                                <select id="filter-from" name="from" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white"></select>
                            </div>
                            <div>
                                <label for="filter-to" class="block text-xs font-medium text-slate-600 mb-1">–ö—É–¥–∞</label>
                                <select id="filter-to" name="to" class="w-full p-2 border border-slate-200 rounded-lg text-sm bg-white"></select>
                            </div>
                        </div>
                        <div>
                            <label for="filter-date" class="block text-xs font-medium text-slate-600 mb-1">–î–∞—Ç–∞</label>
                            <input type="date" id="filter-date" name="date" class="w-full p-2 border border-slate-200 rounded-lg text-sm">
                        </div>
                        <div id="filter-type-container">
                            <label class="block text-xs font-medium text-slate-600 mb-1">–¢–∏–ø –∑–∞—è–≤–∫–∏</label>
                            <div id="filter-type-buttons" class="flex p-1 bg-slate-200 rounded-lg">
                                <button data-type="all" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600 active">–í—Å–µ</button>
                                <button data-type="ride" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600">–ü–∞—Å—Å–∞–∂–∏—Ä—ã</button>
                                <button data-type="parcel" class="filter-type-btn flex-1 py-1 px-2 rounded-md text-xs font-semibold text-slate-600">–ü–æ—Å—ã–ª–∫–∏</button>
                            </div>
                        </div>
                        <div class="flex gap-3 pt-2">
                            <button data-action="resetFilters" class="flex-1 text-sm btn border border-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-100">–°–±—Ä–æ—Å–∏—Ç—å</button>
                            <button data-action="applyFilters" class="flex-1 text-sm btn bg-slate-800 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            </div>
            <div id="list-container" class="space-y-3"></div>
            <div id="no-results" class="text-center text-slate-500 py-10 hidden"><h3 id="no-results-title" class="text-base font-semibold"></h3><p id="no-results-text" class="text-xs"></p></div>
        </div>
    </template>
    <template id="success-screen-template">
        <div class="p-5 flex flex-col items-center justify-center h-full text-center">
            <div class="mb-4"><svg class="w-16 h-16 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg></div>
            <h2 id="success-title" class="text-xl font-bold mt-4 mb-1"></h2>
            <p id="success-text" class="text-slate-600 mb-8 text-sm"></p>
            <button data-action="backToHub" id="back-to-hub-btn" class="text-sm btn w-full max-w-xs bg-slate-800 text-white font-bold py-3 px-4 rounded-lg"></button>
        </div>
    </template>
    <template id="my-trips-screen-template">
         <div class="flex-1 flex flex-col p-5 space-y-4">
             <div id="my-trips-container" class="space-y-4 flex-1"></div>
        </div>
    </template>
    <template id="profile-screen-template">
         <div class="p-5">
            <h2 class="text-lg font-bold mb-4">–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
            <p class="text-xs text-slate-600 mb-4">–ó–¥–µ—Å—å –≤—ã –º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –≤–∞—à–µ –∏–º—è. –ï—Å–ª–∏ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –±—ã—Ç—å –≤–æ–¥–∏—Ç–µ–ª–µ–º, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –∞–≤—Ç–æ–º–æ–±–∏–ª—è.</p>
            <form id="profile-form" class="space-y-4">
                <div>
                    <label for="profile-name" class="block text-xs font-medium text-slate-600 mb-2">–í–∞—à–µ –∏–º—è</label>
                    <input type="text" name="full_name" id="profile-name" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–ê–ª–µ–∫—Å–µ–π" required>
                </div>
                <div>
                    <label for="profile-car" class="block text-xs font-medium text-slate-600 mb-2">–ú–∞—Ä–∫–∞ –∏ –º–æ–¥–µ–ª—å –º–∞—à–∏–Ω—ã (–¥–ª—è –≤–æ–¥–∏—Ç–µ–ª–µ–π)</label>
                    <input type="text" name="driver_car" id="profile-car" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="Kia Rio">
                </div>
                <button type="submit" class="text-sm btn w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </form>
        </div>
    </template>
    <template id="offer-screen-template">
        <div class="p-5">
            <h2 class="text-lg font-bold mb-4">–î–∞–Ω–Ω—ã–µ –æ –ø–æ–µ–∑–¥–∫–µ</h2>
            <form id="offer-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                        <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                        <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                </div>
                <input type="hidden" name="from" required><input type="hidden" name="to" required>
                <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                <div id="ferry-toggle-container" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                    <label for="via-ferry-toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º</label>
                    <div class="flex items-center space-x-3">
                        <span id="ferry-price-increase" class="text-sm text-slate-800 font-semibold hidden"></span>
                        <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-ferry-toggle" name="via_ferry" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div></label>
                    </div>
                </div>
                <div id="cheboksary-detour-container" class="hidden p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                    <label for="via-cheboksary-detour-toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ó–∞–µ–∑–∂–∞—é –≤ –ß–µ–±–æ–∫—Å–∞—Ä—ã</label>
                    <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="via-cheboksary-detour-toggle" name="via_cheboksary_detour" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-500"></div></label>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞ –≤—ã–µ–∑–¥–∞</label>
                        <input type="date" name="ride_date" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–í—Ä–µ–º—è –≤—ã–µ–∑–¥–∞</label>
                        <input type="time" name="ride_time" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-2">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –º–µ—Å—Ç</label>
                    <input type="number" name="seats" min="1" max="8" class="w-full p-3 border border-slate-200 rounded-lg text-sm" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3" required>
                </div>
                <button type="submit" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å (<span id="publish-price"></span> ‚ÇΩ)</button>
            </form>
        </div>
    </template>
    <template id="passenger-request-screen-template">
        <div class="p-5">
            <h2 class="text-lg font-bold mb-4">–í–∞—à–∞ –∑–∞—è–≤–∫–∞</h2>
            <form id="passenger-request-form" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                        <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                        <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                </div>
                <input type="hidden" name="from" required><input type="hidden" name="to" required>
                <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                <input type="date" name="ride_date" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-2">–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è –≤—ã–µ–∑–¥–∞</label>
                    <div id="time-interval-buttons" class="grid grid-cols-2 gap-3">
                        <button type="button" data-interval="–£—Ç—Ä–æ (6-11)" class="flex flex-col items-center justify-center text-center p-3 border border-slate-200 rounded-xl hover:bg-slate-100 transition-colors">
                            <span class="text-2xl mb-1">‚òÄÔ∏è</span>
                            <span class="font-semibold text-sm">–£—Ç—Ä–æ</span>
                            <span class="text-xs text-slate-500">6:00 - 11:00</span>
                        </button>
                        <button type="button" data-interval="–î–µ–Ω—å (12-17)" class="flex flex-col items-center justify-center text-center p-3 border border-slate-200 rounded-xl hover:bg-slate-100 transition-colors">
                            <span class="text-2xl mb-1">üòé</span>
                            <span class="font-semibold text-sm">–î–µ–Ω—å</span>
                            <span class="text-xs text-slate-500">12:00 - 17:00</span>
                        </button>
                        <button type="button" data-interval="–í–µ—á–µ—Ä (18-22)" class="flex flex-col items-center justify-center text-center p-3 border border-slate-200 rounded-xl hover:bg-slate-100 transition-colors">
                            <span class="text-2xl mb-1">üåô</span>
                            <span class="font-semibold text-sm">–í–µ—á–µ—Ä</span>
                            <span class="text-xs text-slate-500">18:00 - 22:00</span>
                        </button>
                        <button type="button" data-interval="–õ—é–±–æ–µ" class="flex flex-col items-center justify-center text-center p-3 border border-slate-200 rounded-xl hover:bg-slate-100 transition-colors">
                             <span class="text-2xl mb-1">üîÑ</span>
                            <span class="font-semibold text-sm">–õ—é–±–æ–µ</span>
                            <span class="text-xs text-slate-500">–í —Ç–µ—á–µ–Ω–∏–µ –¥–Ω—è</span>
                        </button>
                    </div>
                    <input type="hidden" name="time_interval" id="timeIntervalInput" required>
                    <div class="form-error-time text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è</div>
                </div>
                <button type="submit" class="text-sm btn w-full bg-slate-800 text-white font-bold py-3 px-4 rounded-lg hover:bg-slate-700">–û—Å—Ç–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
            </form>
        </div>
    </template>
    <template id="parcel-request-screen-template">
        <div class="p-5">
            <h2 class="text-lg font-bold mb-4">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–æ—Å—ã–ª–∫—É</h2>
            <form id="parcel-request-form" class="space-y-4">
                 <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–û—Ç–∫—É–¥–∞</label>
                        <select name="from-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-slate-600 mb-2">–ö—É–¥–∞</label>
                        <select name="to-select" class="w-full p-3 border border-slate-200 rounded-lg text-sm bg-white" required><option value="" disabled selected>–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥</option></select>
                    </div>
                </div>
                <input type="hidden" name="from" required><input type="hidden" name="to" required>
                <div class="form-error-direction text-red-500 text-xs text-center mt-2 hidden">–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç</div>
                <div><label for="date-parcel" class="block text-xs font-medium text-slate-600 mb-2">–î–∞—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏</label><input type="date" name="ride_date" id="date-parcel" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required></div>
                <div id="parcel-price-info" class="bg-slate-100 p-3 rounded-lg text-center text-slate-600 text-sm">–°—Ç–æ–∏–º–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏: <span class="font-bold"></span> ‚ÇΩ</div>
                <button type="submit" class="text-sm btn w-full bg-purple-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-700">–°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ—Å—ã–ª–∫—É</button>
            </form>
        </div>
    </template>
    <template id="admin-panel-screen-template">
        <div class="p-5">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold">–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å: –ü–∞—Ä—Ç–Ω–µ—Ä—ã</h2>
                <button data-action="editPartner" class="text-sm btn bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600">–î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div id="admin-partners-list" class="space-y-3">
                <!-- Partner list will be rendered here -->
            </div>
        </div>
    </template>
    <template id="admin-edit-partner-screen-template">
        <div class="p-5">
            <h2 id="admin-form-title" class="text-lg font-bold mb-4">–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞</h2>
            <form id="admin-partner-form" class="space-y-4">
                <input type="hidden" name="id">
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-2">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <input type="text" name="title" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-2">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–ª—è –≤–∏–¥–∂–µ—Ç–∞)</label>
                    <textarea name="description" class="w-full p-3 border border-slate-200 rounded-lg text-sm" rows="2"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-medium text-slate-600 mb-2">–°—Å—ã–ª–∫–∞ (URL)</label>
                    <input type="url" name="link_url" class="w-full p-3 border border-slate-200 rounded-lg text-sm" required>
                </div>
                <div class="p-3 bg-slate-50 rounded-lg border border-slate-200 flex items-center justify-between">
                    <label for="is_active_toggle" class="text-sm text-slate-700 font-medium cursor-pointer flex-grow">–ê–∫—Ç–∏–≤–µ–Ω</label>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" id="is_active_toggle" name="is_active" class="sr-only peer" checked>
                        <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                    </label>
                </div>

                <h3 class="text-base font-bold pt-2">–°–ª–∞–π–¥—ã</h3>
                <div id="slides-editor" class="space-y-3">
                    <!-- Slide inputs will be rendered here -->
                </div>
                <button type="button" data-action="addSlide" class="text-sm btn w-full border border-slate-300 text-slate-800 font-bold py-2 px-4 rounded-lg hover:bg-slate-100">–î–æ–±–∞–≤–∏—Ç—å —Å–ª–∞–π–¥</button>

                <div class="flex gap-4 pt-4">
                    <button type="submit" class="text-sm btn flex-1 bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button type="button" data-action="deletePartner" id="delete-partner-btn" class="text-sm btn bg-red-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-red-600 hidden">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </template>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const { createClient } = supabase;

        const App = {
            // --- CONFIGURATION ---
            config: {
                adminId: 5017229451,
                supabaseUrl: 'https://scqkpvmmoaolahpxinja.supabase.co',
                supabaseAnonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNjcWtwdm1tb2FvbGFocHhpbmphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2MDIwNDksImV4cCI6MjA3MTE3ODA0OX0.Uz5L2SF8O1EGf_efkq5FLi6g1yl7LlmnTZi_eLnISMw',
                prices: { base: 600, parcel: 300, cheboksary: 400, ferrySurcharge: 100 },
                cities: ['–ô–æ—à–∫–∞—Ä-–û–ª–∞', '–ß–µ–±–æ–∫—Å–∞—Ä—ã', '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫'],
            },
            
            // --- STATE ---
            state: {
                currentUser: null,
                userProfile: null,
                userRole: 'passenger',
                navigationHistory: ['passenger-home-screen'],
                allRequests: [],
                currentFilters: { from: '', to: '', date: '', type: 'all' },
                editingPartnerId: null,
            },
            
            // --- DOM ELEMENTS CACHE ---
            dom: {},

            // --- SUPABASE CLIENT ---
            supabase: null,
            
            // --- INITIALIZATION ---
            async init() {
                this.supabase = createClient(this.config.supabaseUrl, this.config.supabaseAnonKey);
                
                try {
                    Telegram.WebApp.ready();
                    Telegram.WebApp.expand();
                    this.state.currentUser = Telegram.WebApp.initDataUnsafe?.user;
                     if (!this.state.currentUser) {
                        throw new Error("Not in Telegram");
                    }
                    
                    this.ui.setAppHeight(); 
                    Telegram.WebApp.onEvent('viewportChanged', this.ui.setAppHeight);

                } catch (e) {
                    console.warn("–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º.");
                    this.state.currentUser = { id: 5017229451, first_name: 'Admin', username: 'testadmin', photo_url: null };
                }

                if (!this.state.currentUser?.id) {
                    document.body.innerHTML = '<div class="text-center p-8">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram.</div>';
                    return;
                }
                
                await this.api.ensureUserProfile();
                this.cacheDom();
                this.bindEvents();
                this.ui.renderAllScreens();

                if (this.state.currentUser.id === this.config.adminId) {
                    document.getElementById('admin-plus-btn').classList.remove('hidden');
                }

                this.ui.updateRoleSwitcher();
                this.ui.updateAvatar();
            },

            cacheDom() {
                this.dom.backButton = document.getElementById('backButton');
                this.dom.mainContent = document.getElementById('main-content');
            },

            // --- API CALLS (Data Layer) ---
            api: {
                async ensureUserProfile() {
                    if (!App.state.currentUser) return;
                    let { data: profile, error } = await App.supabase.from('profiles').select('*').eq('id', App.state.currentUser.id).single();
                    
                    if (error && error.code === 'PGRST116') { // Profile doesn't exist, create it
                        const { data: newProfile, error: insertError } = await App.supabase.from('profiles')
                            .insert({ 
                                id: App.state.currentUser.id, 
                                username: App.state.currentUser.username, 
                                full_name: App.state.currentUser.first_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' 
                            })
                            .select()
                            .single();
                        
                        if (insertError) { 
                            console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', insertError); 
                            alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤—Ö–æ–¥–µ. –û—à–∏–±–∫–∞: ${insertError.message}`);
                            return; 
                        }
                        profile = newProfile;
                    } else if (error) {
                        console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error); 
                        return;
                    }
                    App.state.userProfile = profile;
                },
                async updateUserProfile(profileData) {
                    const { data, error } = await App.supabase.from('profiles')
                        .update(profileData)
                        .eq('id', App.state.currentUser.id)
                        .select()
                        .single();
                    if (error) {
                        console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è:', error);
                        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å. –û—à–∏–±–∫–∞: ${error.message}`);
                        return null;
                    }
                    return data;
                },
                async getPublicPartners() {
                    return await App.supabase
                        .from('partners')
                        .select(`*, partner_slides(*)`)
                        .eq('is_active', true)
                        .order('display_order', { referencedTable: 'partner_slides', ascending: true });
                },
                async getAllPartnersAdmin() {
                     return await App.supabase
                        .from('partners')
                        .select(`*, partner_slides(*)`)
                        .order('created_at', { ascending: false });
                },
                async getPartnerById(id) {
                    return await App.supabase
                        .from('partners')
                        .select(`*, partner_slides(*)`)
                        .eq('id', id)
                        .single();
                },
                async upsertPartner(partnerData) {
                    const { slides, ...partner } = partnerData;
                    
                    // Upsert Partner details
                    const { data: savedPartner, error: partnerError } = await App.supabase
                        .from('partners')
                        .upsert(partner)
                        .select()
                        .single();

                    if (partnerError) return { partnerError };

                    // Delete old slides for this partner
                    const { error: deleteError } = await App.supabase
                        .from('partner_slides')
                        .delete()
                        .eq('partner_id', savedPartner.id);
                    
                    if (deleteError) return { deleteError };

                    // Insert new slides
                    if (slides && slides.length > 0) {
                        const slidesToInsert = slides.map((slide, index) => ({
                            ...slide,
                            partner_id: savedPartner.id,
                            display_order: index
                        }));

                        const { error: slidesError } = await App.supabase
                            .from('partner_slides')
                            .insert(slidesToInsert);
                        
                        if (slidesError) return { slidesError };
                    }

                    return { data: savedPartner };
                },
                async deletePartner(partnerId) {
                    return await App.supabase
                        .from('partners')
                        .delete()
                        .eq('id', partnerId);
                }
            },

            // --- EVENT HANDLERS (Controller Layer) ---
            bindEvents() {
                 document.body.addEventListener('click', (e) => {
                    const target = e.target;
                    const button = target.closest('button, [data-action]');
                    if (!button) return;

                    const { action, screen, ...dataset } = button.dataset;

                    const actions = {
                        // Navigation
                        navigateTo: () => this.navigation.to(screen),
                        back: () => this.navigation.back(),
                        backToHub: () => {
                            const hubScreen = this.state.userRole === 'driver' ? 'driver-dashboard-screen' : 'passenger-home-screen';
                            this.navigation.to(hubScreen, true);
                        },
                        // Main actions
                        switchRole: () => {
                            this.state.userRole = this.state.userRole === 'passenger' ? 'driver' : 'passenger';
                            this.ui.updateRoleSwitcher();
                            const newScreen = this.state.userRole === 'passenger' ? 'passenger-home-screen' : 'driver-dashboard-screen';
                            this.navigation.to(newScreen, true); // Reset history
                        },
                        viewDriverOffers: this.handlers.onViewDriverOffers,
                        viewPassengerRequests: this.handlers.onViewPassengerRequests,
                        myTrips: this.handlers.onMyTrips,
                        publishRide: () => {
                            if (!this.state.userProfile?.driver_car?.trim()) {
                                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º –∞–≤—Ç–æ–º–æ–±–∏–ª–µ –≤ –ø—Ä–æ—Ñ–∏–ª–µ.");
                                this.navigation.to('profile-screen');
                            } else {
                                this.navigation.to('offer-screen');
                            }
                        },
                        // List item actions
                        requestBooking: () => this.handlers.onRequestBooking(dataset.offerId),
                        detourBooking: () => this.ui.showBookingOptionsModal(JSON.parse(decodeURIComponent(dataset.offer))),
                        confirmBookingSegment: () => {
                            this.ui.hideBookingModal();
                            this.handlers.onRequestBooking(dataset.offerId, { 
                                segment: dataset.segment, 
                                price: parseInt(dataset.price), 
                                from: dataset.from, 
                                to: dataset.to 
                            });
                        },
                        cancelBooking: () => this.handlers.onCancelBooking(dataset.bookingId),
                        offerRide: () => this.handlers.onOfferRideToRequest(dataset.requestId, button),
                        updateBookingStatus: () => this.handlers.onUpdateBookingStatus(dataset.bookingId, dataset.status),
                        deleteOffer: () => this.handlers.onDeleteOffer(dataset.offerId),
                        cancelRequest: () => this.handlers.onCancelRequest(dataset.requestId),
                        cancelParcelRequest: () => this.handlers.onCancelParcelRequest(dataset.requestId),
                        // Modals & Filters
                        hideModal: this.ui.hideBookingModal,
                        toggleFilter: this.ui.toggleFilter,
                        applyFilters: this.handlers.onApplyFilters,
                        resetFilters: this.handlers.onResetFilters,

                        // --- ADMIN ACTIONS ---
                        editPartner: () => this.handlers.onEditPartner(dataset.partnerId),
                        addSlide: () => this.ui.addSlideInput(),
                        removeSlide: () => button.closest('.slide-input-group').remove(),
                        deletePartner: () => this.handlers.onDeletePartner(),
                    };

                    if (actions[action]) {
                        actions[action]();
                    } else if (target.closest('#time-interval-buttons')) {
                        this.handlers.onTimeSelect(button);
                    } else if (button.classList.contains('filter-type-btn')) {
                        this.handlers.onFilterTypeSelect(button);
                    }
                });

                document.body.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const formHandlers = {
                        'profile-form': this.handlers.onProfileSubmit,
                        'offer-form': this.handlers.onOfferSubmit,
                        'passenger-request-form': this.handlers.onPassengerRequestSubmit,
                        'parcel-request-form': this.handlers.onParcelRequestSubmit,
                        'admin-partner-form': this.handlers.onSavePartner,
                    };
                    if (formHandlers[e.target.id]) formHandlers[e.target.id](e.target);
                });

                 document.body.addEventListener('change', (e) => {
                    if (['via-ferry-toggle', 'via-cheboksary-detour-toggle'].includes(e.target.id)) this.handlers.onRouteOptionChange(e.target);
                    if (['from-select', 'to-select'].includes(e.target.name)) this.handlers.onRouteDropdownChange(e.target);
                });
            },

            // --- ACTION HANDLERS (Business Logic) ---
            handlers: {
                async onProfileSubmit(form) {
                    const formData = new FormData(form);
                    const fullName = formData.get('full_name').trim();
                    if (!fullName) { alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º."); return; }
                    
                    const updatedProfile = await App.api.updateUserProfile({
                        full_name: fullName,
                        driver_car: formData.get('driver_car').trim()
                    });

                    if (updatedProfile) {
                        App.state.userProfile = updatedProfile;
                        App.ui.updateAvatar();
                        App.navigation.back();
                    }
                },
                async onOfferSubmit(form) {
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());
                    
                    if (!data.from || !data.to) { form.querySelector('.form-error-direction').classList.remove('hidden'); return; }
                    
                    const isCheboksaryRoute = data.from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || data.to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';
                    data.price = isCheboksaryRoute ? App.config.prices.cheboksary : (data.via_ferry ? App.config.prices.base + App.config.prices.ferrySurcharge : App.config.prices.base);
                    
                    const offerData = {
                        driver_id: App.state.currentUser.id,
                        from: data.from,
                        to: data.to,
                        ride_date: data.ride_date,
                        ride_time: data.ride_time,
                        seats: parseInt(data.seats),
                        price: data.price,
                        via_ferry: !!data.via_ferry,
                        via_cheboksary_detour: !!data.via_cheboksary_detour
                    };

                    const { error } = await App.supabase.from('ride_offers').insert(offerData);

                    if (error) { console.error(error); alert(`–û—à–∏–±–∫–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ–µ–∑–¥–∫–∏: ${error.message}`); return; }
                    
                    App.ui.resetForm(form);
                    App.ui.showSuccess('–ü–æ–µ–∑–¥–∫–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–∞', '–ü–∞—Å—Å–∞–∂–∏—Ä—ã —Ç–µ–ø–µ—Ä—å –≤–∏–¥—è—Ç –≤–∞—à–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ.', '–í –∫–∞–±–∏–Ω–µ—Ç');
                },
                async onPassengerRequestSubmit(form) {
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    if (!data.from || !data.to || !data.time_interval) {
                        if (!data.from || !data.to) form.querySelector('.form-error-direction').classList.remove('hidden');
                        if (!data.time_interval) form.querySelector('.form-error-time').classList.remove('hidden');
                        return;
                    }
                    
                    const requestData = {
                        passenger_id: App.state.currentUser.id,
                        from: data.from,
                        to: data.to,
                        ride_date: data.ride_date,
                        time_interval: data.time_interval,
                        price: (data.from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || data.to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã') ? App.config.prices.cheboksary : App.config.prices.base
                    };

                    const { error } = await App.supabase.from('ride_requests').insert(requestData);

                    if (error) { console.error(error); alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏: ${error.message}`); return; }
                    App.ui.resetForm(form);
                    App.ui.showSuccess('–ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª–∏ —Å–∫–æ—Ä–æ —É–≤–∏–¥—è—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É.', '–û—Ç–ª–∏—á–Ω–æ');
                },
                async onParcelRequestSubmit(form) {
                    const formData = new FormData(form);
                    const data = Object.fromEntries(formData.entries());

                    if (!data.from || !data.to) { form.querySelector('.form-error-direction').classList.remove('hidden'); return; }

                    const parcelData = {
                        sender_id: App.state.currentUser.id,
                        from: data.from,
                        to: data.to,
                        ride_date: data.ride_date,
                        price: App.config.prices.parcel
                    };
                    
                    const { error } = await App.supabase.from('parcel_requests').insert(parcelData);

                    if (error) { console.error(error); alert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ—Å—ã–ª–∫—É: ${error.message}`); return; }
                    App.ui.resetForm(form);
                    App.ui.showSuccess('–ó–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Å—ã–ª–∫—É —Å–æ–∑–¥–∞–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª–∏ —É–≤–∏–¥—è—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É.', '–û—Ç–ª–∏—á–Ω–æ');
                },
                async onViewDriverOffers() {
                    App.navigation.to('list-screen');
                    document.getElementById('filter-section-container').classList.add('hidden');
                    App.ui.renderList([], 'driverOffer', true); // Show loader

                    const { data: offers, error } = await App.supabase.from('ride_offers_with_seats')
                        .select('*')
                        .gte('ride_date', new Date().toISOString().split('T')[0])
                        .gt('seats_left', 0)
                        .order('ride_date', { ascending: true })
                        .order('ride_time', { ascending: true });

                    if (error) { console.error(error); App.ui.renderList([], 'driverOffer'); return; }
                    
                    const { data: userBookings } = await App.supabase.from('bookings')
                        .select('id, offer_id')
                        .eq('passenger_id', App.state.currentUser.id);
                        
                    const userBookingsMap = new Map(userBookings?.map(b => [b.offer_id, b.id]) || []);
                    const augmentedOffers = offers.map(offer => ({ ...offer, currentUserBookingId: userBookingsMap.get(offer.id) || null }));
                    
                    App.ui.renderList(augmentedOffers, 'driverOffer');
                },
                async onViewPassengerRequests() {
                    App.navigation.to('list-screen');
                    document.getElementById('filter-section-container').classList.remove('hidden');
                    App.ui.renderList([], 'passengerRequest', true); // Show loader

                    const today = new Date().toISOString().split('T')[0];
                    document.getElementById('filter-date').setAttribute('min', today);

                    const { data, error } = await App.supabase.from('all_requests').select('*');
                    if (error) { console.error(error); App.ui.renderList([], 'passengerRequest'); return; }

                    App.state.allRequests = data || [];
                    App.handlers.onResetFilters();
                },
                async onMyTrips() {
                    App.navigation.to('my-trips-screen');
                    const container = document.getElementById('my-trips-container');
                    container.innerHTML = App.ui.getLoaderHTML();

                    if (App.state.userRole === 'driver') {
                        const { data, error } = await App.supabase.from('ride_offers')
                            .select(`*, bookings(*, passenger:profiles(full_name, username))`)
                            .eq('driver_id', App.state.currentUser.id)
                            .gte('ride_date', new Date().toISOString().split('T')[0])
                            .order('ride_date', { ascending: true });
                            
                        if (error) { console.error(error); container.innerHTML = App.ui.getErrorHTML("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–µ–∑–¥–æ–∫"); return; }
                        App.ui.renderMyTrips(data, 'driver');
                    } else {
                        const today = new Date(); today.setHours(0,0,0,0);
                        const [bookingsRes, requestsRes, parcelsRes] = await Promise.all([
                            App.supabase.from('bookings').select(`*, offer:ride_offers(*, driver:profiles(full_name, driver_car, username))`).eq('passenger_id', App.state.currentUser.id),
                            App.supabase.from('ride_requests').select(`*`).eq('passenger_id', App.state.currentUser.id).gte('ride_date', new Date().toISOString().split('T')[0]),
                            App.supabase.from('parcel_requests').select(`*`).eq('sender_id', App.state.currentUser.id).gte('ride_date', new Date().toISOString().split('T')[0])
                        ]);

                        if (bookingsRes.error || requestsRes.error || parcelsRes.error) {
                             container.innerHTML = App.ui.getErrorHTML("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö"); return;
                        }
                        
                        const activeBookings = (bookingsRes.data || []).filter(b => b.offer && new Date(b.offer.ride_date) >= today);
                        App.ui.renderMyTrips({ bookings: activeBookings, requests: requestsRes.data, parcels: parcelsRes.data }, 'passenger');
                    }
                },
                async onRequestBooking(offerId, bookingDetails = null) {
                    const { data: offer, error: offerError } = await App.supabase.from('ride_offers').select('*').eq('id', offerId).single();
                    if(offerError || !offer) { console.error("–ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"); alert(`–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –ø–æ–µ–∑–¥–∫—É: ${offerError.message}`); return; }
                    
                    const bookingData = {
                        offer_id: offerId,
                        passenger_id: App.state.currentUser.id,
                        status: 'pending',
                        booking_segment: bookingDetails?.segment || 'full',
                        price: bookingDetails?.price || offer.price,
                        from_city: bookingDetails?.from || offer.from,
                        to_city: bookingDetails?.to || offer.to,
                    };
                    
                    const { error } = await App.supabase.from('bookings').insert(bookingData);
                    if (error) { console.error('–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è:', error); alert(`–û—à–∏–±–∫–∞ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`); return; }
                    
                    App.utils.sendTelegramNotification(offer.driver_id, `*–ù–æ–≤–æ–µ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ!* üöó\n–ü–∞—Å—Å–∞–∂–∏—Ä *${App.state.userProfile.full_name}* —Ö–æ—á–µ—Ç –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –º–µ—Å—Ç–æ –Ω–∞ –≤–∞—à—É –ø–æ–µ–∑–¥–∫—É ${offer.from} ‚Üí ${offer.to}.`);
                    App.ui.showSuccess('–ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞', '–í–æ–¥–∏—Ç–µ–ª—å —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç –≤–∞—à—É –∑–∞—è–≤–∫—É –∏ –≤—ã –ø–æ–ª—É—á–∏—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.', '–û—Ç–ª–∏—á–Ω–æ');
                },
                 async onUpdateBookingStatus(bookingId, status) {
                     const { data: booking, error } = await App.supabase.from('bookings').update({ status }).eq('id', bookingId).select('*, offer:ride_offers(*)').single();
                     if (error) { console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –±—Ä–æ–Ω–∏:', error); return; }

                     const message = status === 'confirmed' ? `*–ë—Ä–æ–Ω—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∞!* ‚úÖ` : `*–ë—Ä–æ–Ω—å –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞* ‚ùå`;
                     App.utils.sendTelegramNotification(booking.passenger_id, `${message}\n–í–æ–¥–∏—Ç–µ–ª—å –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ–µ–∑–¥–∫—É ${booking.offer.from} ‚Üí ${booking.offer.to}.`);
                     
                     App.handlers.onMyTrips(); // Refresh the list
                 },
                async onCancelBooking(bookingId) {
                    const { data: booking } = await App.supabase.from('bookings').select('offer:ride_offers(driver_id)').eq('id', bookingId).single();
                    const { error } = await App.supabase.from('bookings').delete().eq('id', bookingId);
                    if(error) { console.error(error); return; }
                    
                    if (booking?.offer?.driver_id) {
                        App.utils.sendTelegramNotification(booking.offer.driver_id, `–ü–∞—Å—Å–∞–∂–∏—Ä –æ—Ç–º–µ–Ω–∏–ª –±—Ä–æ–Ω—å –Ω–∞ –≤–∞—à—É –ø–æ–µ–∑–¥–∫—É.`);
                    }

                    if (App.state.navigationHistory.at(-1) === 'list-screen') App.handlers.onViewDriverOffers();
                    else App.handlers.onMyTrips();
                },
                 async onDeleteOffer(offerId) {
                    const { data: bookings } = await App.supabase.from('bookings').select('passenger_id').eq('offer_id', offerId);
                     if (bookings?.length) {
                         const notifications = bookings.map(b => App.utils.sendTelegramNotification(b.passenger_id, `*–ü–æ–µ–∑–¥–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–º* ‚ùå`));
                         await Promise.all(notifications);
                     }
                    await App.supabase.from('ride_offers').delete().eq('id', offerId); // Bookings will be deleted by CASCADE
                    App.handlers.onMyTrips();
                },
                async onCancelRequest(requestId) { await App.supabase.from('ride_requests').delete().eq('id', requestId); App.handlers.onMyTrips(); },
                async onCancelParcelRequest(requestId) { await App.supabase.from('parcel_requests').delete().eq('id', requestId); App.handlers.onMyTrips(); },
                async onOfferRideToRequest(requestId, button) {
                    if (!App.state.userProfile?.driver_car?.trim()) { alert("–£–∫–∞–∂–∏—Ç–µ –∞–≤—Ç–æ –≤ –ø—Ä–æ—Ñ–∏–ª–µ."); App.navigation.to('profile-screen'); return; }
                    
                    button.disabled = true;
                    button.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞...';

                    const { data: request, error } = await App.supabase.from('ride_requests').select('*').eq('id', requestId).single();
                    if (error || !request) { console.error("–ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:", error); button.disabled = false; return; }

                    let timeForOffer;
                    const interval = request.time_interval || '';
                    if (interval.includes('–£—Ç—Ä–æ')) {
                        timeForOffer = '06:00';
                    } else if (interval.includes('–î–µ–Ω—å')) {
                        timeForOffer = '12:00';
                    } else if (interval.includes('–í–µ—á–µ—Ä')) {
                        timeForOffer = '18:00';
                    } else { // Covers "–õ—é–±–æ–µ" and any unexpected cases
                        timeForOffer = '12:00';
                    }

                    const { error: offerError } = await App.supabase.rpc('create_offer_and_booking_for_request', {
                        p_request_id: requestId,
                        p_driver_id: App.state.currentUser.id,
                        p_ride_time: timeForOffer
                    });

                    if (offerError) {
                        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ:", offerError);
                        alert(`–û—à–∏–±–∫–∞. –í–æ–∑–º–æ–∂–Ω–æ, –Ω–∞ —ç—Ç—É –∑–∞—è–≤–∫—É —É–∂–µ –æ—Ç–≤–µ—Ç–∏–ª–∏. \n\n–î–µ—Ç–∞–ª–∏: ${offerError.message}`);
                        button.disabled = false;
                        button.textContent = '–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–µ–∑–¥–∫—É';
                        return;
                    }
                    
                    App.utils.sendTelegramNotification(request.passenger_id, `*–í–∞–º –ø—Ä–µ–¥–ª–æ–∂–∏–ª–∏ –ø–æ–µ–∑–¥–∫—É!* üöó\n–í–æ–¥–∏—Ç–µ–ª—å *${App.state.userProfile.full_name}* –æ—Ç–∫–ª–∏–∫–Ω—É–ª—Å—è –Ω–∞ –≤–∞—à—É –∑–∞—è–≤–∫—É.`);
                    
                    button.textContent = '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ';
                    button.classList.remove('bg-green-500', 'hover:bg-green-600');
                    button.classList.add('bg-slate-400', 'cursor-not-allowed');
                },
                // --- ADMIN HANDLERS ---
                async onEditPartner(partnerId = null) {
                    App.state.editingPartnerId = partnerId;
                    App.navigation.to('admin-edit-partner-screen');
                    if (partnerId) {
                        const { data, error } = await App.api.getPartnerById(partnerId);
                        if (error) {
                            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–∞—Ä—Ç–Ω–µ—Ä–∞.');
                            return;
                        }
                        App.ui.renderAdminForm(data);
                    } else {
                        App.ui.renderAdminForm(); // Render empty form
                    }
                },
                async onSavePartner(form) {
                    const formData = new FormData(form);
                    const partnerData = {
                        id: App.state.editingPartnerId || undefined,
                        title: formData.get('title'),
                        description: formData.get('description'),
                        link_url: formData.get('link_url'),
                        is_active: form.querySelector('#is_active_toggle').checked,
                        slides: []
                    };

                    form.querySelectorAll('.slide-input-group').forEach(group => {
                        const image_url = group.querySelector('input[name="image_url"]').value;
                        const caption = group.querySelector('input[name="caption"]').value;
                        if (image_url) {
                            partnerData.slides.push({ image_url, caption });
                        }
                    });

                    const { error } = await App.api.upsertPartner(partnerData);
                    if (error) {
                        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞: ${error.message}`);
                        return;
                    }
                    App.navigation.to('admin-panel-screen', true);
                },
                async onDeletePartner() {
                    if (!App.state.editingPartnerId || !confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–∞—Ä—Ç–Ω–µ—Ä–∞?')) {
                        return;
                    }
                    const { error } = await App.api.deletePartner(App.state.editingPartnerId);
                    if (error) {
                        alert(`–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞: ${error.message}`);
                        return;
                    }
                     App.navigation.to('admin-panel-screen', true);
                },
                // --- UI RELATED HANDLERS ---
                onApplyFilters() {
                    App.state.currentFilters = { from: document.getElementById('filter-from').value, to: document.getElementById('filter-to').value, date: document.getElementById('filter-date').value, type: document.querySelector('#filter-type-buttons .active').dataset.type };
                    App.ui.renderFilteredList();
                },
                onResetFilters() {
                    App.state.currentFilters = { from: '', to: '', date: '', type: 'all' };
                    document.getElementById('filter-from').value = '';
                    document.getElementById('filter-to').value = '';
                    document.getElementById('filter-date').value = '';
                    document.querySelectorAll('#filter-type-buttons .filter-type-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.type === 'all'));
                    App.ui.renderFilteredList();
                },
                onFilterTypeSelect(button) {
                    button.parentElement.querySelectorAll('.filter-type-btn').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                },
                onTimeSelect(button) {
                    const form = button.closest('form');
                    button.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    form.querySelector('#timeIntervalInput').value = button.dataset.interval;
                    form.querySelector('.form-error-time').classList.add('hidden');
                },
                onRouteOptionChange(checkbox) {
                    const form = checkbox.closest('form');
                    if (checkbox.id === 'via-ferry-toggle' && checkbox.checked) {
                        form.querySelector('#via-cheboksary-detour-toggle').checked = false;
                    }
                    this.onRouteDropdownChange(form.querySelector('select[name="from-select"]'));
                },
                onRouteDropdownChange(selectElement) {
                    const form = selectElement.closest('form');
                    const fromSelect = form.querySelector('select[name="from-select"]');
                    const toSelect = form.querySelector('select[name="to-select"]');
                    form.querySelector('input[name="from"]').value = fromSelect.value;
                    form.querySelector('input[name="to"]').value = toSelect.value;
                    Array.from(toSelect.options).forEach(opt => { opt.disabled = opt.value === fromSelect.value; });
                    Array.from(fromSelect.options).forEach(opt => { opt.disabled = opt.value === toSelect.value; });
                    const isKozYoRoute = (fromSelect.value === '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫' && toSelect.value === '–ô–æ—à–∫–∞—Ä-–û–ª–∞') || (fromSelect.value === '–ô–æ—à–∫–∞—Ä-–û–ª–∞' && toSelect.value === '–ö–æ–∑—å–º–æ–¥–µ–º—å—è–Ω—Å–∫');
                    const ferryContainer = form.querySelector('#ferry-toggle-container');
                    const detourContainer = form.querySelector('#cheboksary-detour-container');
                    const ferryToggle = form.querySelector('#via-ferry-toggle');
                    if (ferryContainer) ferryContainer.classList.toggle('hidden', !isKozYoRoute);
                    if (detourContainer) detourContainer.classList.toggle('hidden', !(isKozYoRoute && !ferryToggle.checked));
                    App.ui.updateOfferPrice(form);
                },
            },

            // --- NAVIGATION ---
            navigation: {
                to(screenId, resetHistory = false) {
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    const screenElement = document.getElementById(screenId);
                    if (!screenElement) { console.error(`Screen "${screenId}" not found.`); return; }
                    
                    screenElement.classList.add('active');
                    
                    if (resetHistory) {
                        App.state.navigationHistory = [screenId];
                    } else if (App.state.navigationHistory.at(-1) !== screenId) {
                        App.state.navigationHistory.push(screenId);
                    }
                    
                    const isAdmin = App.state.currentUser.id === App.config.adminId;
                    const backButtonVisible = App.state.navigationHistory.length > 1;
                    App.dom.backButton.classList.toggle('invisible', !backButtonVisible);
                    
                    const adminButton = document.getElementById('admin-plus-btn');
                    if (adminButton) {
                        adminButton.classList.toggle('hidden', !isAdmin || backButtonVisible);
                    }
                    
                    // Pre-population/rendering logic for new screens
                    if (screenId === 'profile-screen') App.ui.populateProfileForm();
                    if (screenId === 'offer-screen') App.handlers.onRouteDropdownChange(document.querySelector('#offer-form select'));
                    if (screenId === 'admin-panel-screen') App.ui.renderAdminPanel();
                },
                back() {
                    if (App.state.navigationHistory.length <= 1) return;
                    // Remove current screen from history
                    App.state.navigationHistory.pop();
                    // Get the new last screen
                    const lastScreenId = App.state.navigationHistory.at(-1);

                    // Manually switch screens without calling the full `to` method
                    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
                    const screenElement = document.getElementById(lastScreenId);
                    if (screenElement) screenElement.classList.add('active');

                    // Manually update header buttons based on new state
                    const isAdmin = App.state.currentUser.id === App.config.adminId;
                    const backButtonVisible = App.state.navigationHistory.length > 1;
                    App.dom.backButton.classList.toggle('invisible', !backButtonVisible);
                    
                    const adminButton = document.getElementById('admin-plus-btn');
                    if (adminButton) {
                        adminButton.classList.toggle('hidden', !isAdmin || backButtonVisible);
                    }
                }
            },
            
            // --- UI & RENDER ---
            ui: {
                setAppHeight() {
                    const appContainer = document.getElementById('app-container');
                    if (appContainer && window.Telegram?.WebApp?.viewportStableHeight) {
                        appContainer.style.height = `${window.Telegram.WebApp.viewportStableHeight}px`;
                    }
                },
                renderAllScreens() {
                    const templates = document.querySelectorAll('template');
                    templates.forEach(template => {
                        const screenId = template.id.replace('-template', '');
                        const screen = document.getElementById(screenId);
                        if (screen) screen.innerHTML = template.innerHTML;
                    });
                    this.setDefaultDates();
                    this.populateSelects();
                    this.populatePartnerWidgets();
                    const offerPriceSpan = document.querySelector('#offer-form #publish-price');
                    if (offerPriceSpan) offerPriceSpan.textContent = App.config.prices.base;
                    const parcelPriceSpan = document.querySelector('#parcel-request-form #parcel-price-info span');
                    if(parcelPriceSpan) parcelPriceSpan.textContent = App.config.prices.parcel;
                },

                updateRoleSwitcher() {
                    const switcher = document.getElementById('role-switcher');
                    switcher.classList.toggle('driver', App.state.userRole === 'driver');
                    switcher.classList.toggle('passenger', App.state.userRole === 'passenger');
                    switcher.dataset.action = 'switchRole';
                },
                
                updateAvatar() {
                    const avatarBtn = document.getElementById('profile-avatar-btn');
                    avatarBtn.dataset.action = 'navigateTo';
                    avatarBtn.dataset.screen = 'profile-screen';
                    if (!avatarBtn || !App.state.currentUser) return;
                    
                    if(App.state.currentUser.photo_url) {
                        avatarBtn.innerHTML = `<img src="${App.state.currentUser.photo_url}" alt="Avatar">`;
                    } else {
                        const initials = (App.state.userProfile?.full_name || App.state.currentUser.first_name || '?').charAt(0).toUpperCase();
                        avatarBtn.innerHTML = `<span>${initials}</span>`;
                    }
                },

                renderList(items, type, isLoading = false) {
                    const container = document.getElementById('list-container');
                    const noResults = document.getElementById('no-results');
                    container.innerHTML = '';

                    if (isLoading) {
                        container.innerHTML = this.getLoaderHTML();
                        noResults.classList.add('hidden'); return;
                    }
                    if (!items || items.length === 0) {
                        noResults.classList.remove('hidden');
                        document.getElementById('no-results-title').textContent = type === 'driverOffer' ? '–ü–æ–µ–∑–¥–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' : '–ó–∞—è–≤–æ–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ';
                        document.getElementById('no-results-text').textContent = type === 'driverOffer' ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–π—Ç–∏ –ø–æ–∑–∂–µ –∏–ª–∏ –æ—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ—é –∑–∞—è–≤–∫—É.' : '–ü–æ –≤–∞—à–∏–º —Ñ–∏–ª—å—Ç—Ä–∞–º –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.';
                        return;
                    }
                    noResults.classList.add('hidden');
                    const cardRenderer = type === 'driverOffer' ? this.getDriverOfferCard : this.getPassengerRequestCard;
                    container.innerHTML = items.map(item => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${cardRenderer.call(this, item)}</div>`).join('');
                },
                
                renderFilteredList() {
                    let filtered = [...App.state.allRequests];
                    const { from, to, date, type } = App.state.currentFilters;
                    if (from) filtered = filtered.filter(r => r.from === from);
                    if (to) filtered = filtered.filter(r => r.to === to);
                    if (date) filtered = filtered.filter(r => r.ride_date === date);
                    if (type !== 'all') filtered = filtered.filter(r => r.type === (type === 'ride' ? 'ride_request' : 'parcel_request'));

                    this.renderList(filtered, 'passengerRequest');
                },

                renderMyTrips(data, role) {
                    const container = document.getElementById('my-trips-container');
                    if (role === 'driver') {
                        if (!data || data.length === 0) { container.innerHTML = `<div class="text-center text-slate-500 py-10"><h3 class="text-base font-semibold">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–µ–∑–¥–æ–∫</h3></div>`; return; }
                        container.innerHTML = data.map(offer => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyDriverOfferCard(offer)}</div>`).join('');
                    } else {
                        const { bookings, requests, parcels } = data;
                        if (!bookings?.length && !requests?.length && !parcels?.length) { container.innerHTML = `<div class="text-center text-slate-500 py-10"><h3 class="text-base font-semibold">–£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–µ–π</h3></div>`; return; }
                        let content = '';
                        if (bookings?.length) content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-2">–ú–æ–∏ –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>` + bookings.map(b => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyBookingCard(b)}</div>`).join('');
                        if (requests?.length) content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-4">–ú–æ–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –ø–æ–µ–∑–¥–∫–∏</h3>` + requests.map(r => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyRequestCard(r)}</div>`).join('');
                        if (parcels?.length) content += `<h3 class="text-base font-bold text-slate-800 px-1 pt-4">–ú–æ–∏ –ø–æ—Å—ã–ª–∫–∏</h3>` + parcels.map(p => `<div class="bg-white border border-slate-200 rounded-xl p-4 space-y-3">${this.getMyParcelRequestCard(p)}</div>`).join('');
                        container.innerHTML = content;
                    }
                },
                
                showSuccess(title, text, buttonText) {
                    document.getElementById('success-title').textContent = title;
                    document.getElementById('success-text').textContent = text;
                    document.getElementById('back-to-hub-btn').textContent = buttonText;
                    App.navigation.to('success-screen');
                },
                showBookingOptionsModal(offer) {
                    const container = document.getElementById('booking-options-container');
                    const { base, cheboksary } = App.config.prices;
                    container.innerHTML = `
                        <button class="w-full flex justify-between items-center text-left p-3 text-blue-500 text-base" data-action="confirmBookingSegment" data-offer-id="${offer.id}" data-segment="full" data-price="${base}" data-from="${offer.from}" data-to="${offer.to}"><span>${offer.from} ‚Üí ${offer.to}</span><span class="font-semibold">${base} ‚ÇΩ</span></button>
                        <div class="h-px bg-slate-200"></div>
                        <button class="w-full flex justify-between items-center text-left p-3 text-blue-500 text-base" data-action="confirmBookingSegment" data-offer-id="${offer.id}" data-segment="start_to_cheb" data-price="${cheboksary}" data-from="${offer.from}" data-to="–ß–µ–±–æ–∫—Å–∞—Ä—ã"><span>${offer.from} ‚Üí –ß–µ–±–æ–∫—Å–∞—Ä—ã</span><span class="font-semibold">${cheboksary} ‚ÇΩ</span></button>
                        <div class="h-px bg-slate-200"></div>
                        <button class="w-full flex justify-between items-center text-left p-3 text-blue-500 text-base" data-action="confirmBookingSegment" data-offer-id="${offer.id}" data-segment="cheb_to_end" data-price="${cheboksary}" data-from="–ß–µ–±–æ–∫—Å–∞—Ä—ã" data-to="${offer.to}"><span>–ß–µ–±–æ–∫—Å–∞—Ä—ã ‚Üí ${offer.to}</span><span class="font-semibold">${cheboksary} ‚ÇΩ</span></button>`;
                    
                    const overlay = document.getElementById('booking-modal-overlay');
                    const modal = document.getElementById('booking-modal');
                    overlay.classList.remove('hidden');
                    overlay.dataset.action = 'hideModal';
                    document.getElementById('booking-modal-cancel-btn').dataset.action = 'hideModal';
                    
                    requestAnimationFrame(() => {
                        overlay.classList.add('show');
                        modal.classList.add('show');
                    });
                },
                hideBookingModal() {
                    const overlay = document.getElementById('booking-modal-overlay');
                    const modal = document.getElementById('booking-modal');
                    overlay.classList.remove('show');
                    modal.classList.remove('show');
                    setTimeout(() => { overlay.classList.add('hidden'); }, 300);
                },
                toggleFilter() {
                    document.getElementById('filter-content').classList.toggle('collapsed');
                    document.getElementById('filter-toggle-btn').classList.toggle('collapsed');
                },
                populateProfileForm() {
                    const form = document.getElementById('profile-form');
                    if(form && App.state.userProfile) {
                        form.querySelector('#profile-name').value = App.state.userProfile.full_name || '';
                        form.querySelector('#profile-car').value = App.state.userProfile.driver_car || '';
                    }
                },
                updateOfferPrice(form) {
                    const from = form.querySelector('input[name="from"]').value;
                    const to = form.querySelector('input[name="to"]').value;
                    const isFerryChecked = form.querySelector('#via-ferry-toggle')?.checked;
                    const isCheboksaryRoute = from === '–ß–µ–±–æ–∫—Å–∞—Ä—ã' || to === '–ß–µ–±–æ–∫—Å–∞—Ä—ã';
                    let price = isCheboksaryRoute ? App.config.prices.cheboksary : (isFerryChecked ? App.config.prices.base + App.config.prices.ferrySurcharge : App.config.prices.base);
                    const priceIncreaseSpan = form.querySelector('#ferry-price-increase');
                    if(priceIncreaseSpan) { priceIncreaseSpan.classList.toggle('hidden', !isFerryChecked || isCheboksaryRoute); priceIncreaseSpan.textContent = `(+${App.config.prices.ferrySurcharge} ‚ÇΩ)`; }
                    form.querySelector('#publish-price').textContent = price;
                },
                async populatePartnerWidgets() {
                    const { data, error } = await App.api.getPublicPartners();
                    if (error || !data || data.length === 0) {
                        console.warn('No active partners found or error fetching them.', error);
                        return;
                    }
                    
                    const partner = data[0]; // For now, we only show the first partner
                    
                    document.querySelectorAll('.partner-widget-container').forEach(container => {
                        const widgetHTML = this.getPartnerWidgetHTML(partner);
                        container.innerHTML = widgetHTML;
                        const widgetEl = container.querySelector('.partner-widget');
                        if (widgetEl) this.initPartnerWidget(widgetEl);
                    });
                },
                getPartnerWidgetHTML(partner) {
                    if (!partner || !partner.partner_slides || partner.partner_slides.length === 0) return '';
                    const slidesHTML = partner.partner_slides.map(slide => `
                        <div class="slide">
                            <img src="${slide.image_url}" onerror="this.onerror=null;this.src='https://placehold.co/600x400/e2e8f0/64748b?text=Image+Error';" alt="${slide.caption || partner.title}" class="w-full h-48 object-cover">
                            <div class="slide-content">
                                <h4 class="font-bold">${partner.title}</h4>
                                <p class="text-xs mt-1 mb-2">${slide.caption || partner.description}</p>
                            </div>
                        </div>`).join('');

                    return `
                        <h3 class="text-base font-bold text-slate-800 mb-3 text-center">–ü–∞—Ä—Ç–Ω–µ—Ä—ã</h3>
                        <div class="partner-widget">
                            <div class="slider-container shadow-lg">
                                <div class="slider-track">${slidesHTML}</div>
                                <div class="slider-dots"></div>
                            </div>
                            <a href="${partner.link_url}" target="_blank" class="mt-3 text-sm btn w-full bg-blue-100 text-blue-800 font-bold py-2 px-4 rounded-xl hover:bg-blue-200 flex items-center justify-center gap-2">
                                –ü–µ—Ä–µ–π—Ç–∏
                            </a>
                        </div>`;
                },
                initPartnerWidget(widget) {
                    const track = widget.querySelector('.slider-track');
                    const slides = Array.from(track.children);
                    const dotsContainer = widget.querySelector('.slider-dots');
                    if (!slides.length || slides.length < 2) return;

                    let currentIndex = 0;
                    let autoSlideInterval;
                    let touchStartX = 0;
                    
                    slides.forEach((_, i) => {
                        const dot = document.createElement('button');
                        dot.classList.add('dot');
                        if (i === 0) dot.classList.add('active');
                        dot.addEventListener('click', () => {
                            goToSlide(i);
                            resetAutoSlide();
                        });
                        dotsContainer.appendChild(dot);
                    });
                    const dots = Array.from(dotsContainer.children);

                    const goToSlide = (index) => {
                        track.style.transform = `translateX(-${index * 100}%)`;
                        dots.forEach((dot, i) => dot.classList.toggle('active', i === index));
                        currentIndex = index;
                    };

                    const nextSlide = () => goToSlide((currentIndex + 1) % slides.length);
                    const prevSlide = () => goToSlide((currentIndex - 1 + slides.length) % slides.length);
                    
                    const resetAutoSlide = () => {
                         clearInterval(autoSlideInterval);
                         autoSlideInterval = setInterval(nextSlide, 5000);
                    };

                    track.addEventListener('touchstart', e => {
                        touchStartX = e.touches[0].clientX;
                        clearInterval(autoSlideInterval);
                    }, { passive: true });
                    
                    track.addEventListener('touchend', e => {
                        const touchEndX = e.changedTouches[0].clientX;
                        if (touchStartX - touchEndX > 50) nextSlide();
                        else if (touchEndX - touchStartX > 50) prevSlide();
                        resetAutoSlide();
                    });

                    resetAutoSlide();
                },
                async renderAdminPanel() {
                    const container = document.getElementById('admin-partners-list');
                    if (!container) return;
                    container.innerHTML = this.getLoaderHTML();

                    const { data, error } = await App.api.getAllPartnersAdmin();
                    if (error) {
                        container.innerHTML = this.getErrorHTML('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤.');
                        return;
                    }
                    if (!data.length) {
                        container.innerHTML = '<p class="text-center text-slate-500">–ü–∞—Ä—Ç–Ω–µ—Ä—ã –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã.</p>';
                        return;
                    }

                    container.innerHTML = data.map(p => `
                        <div class="border rounded-lg p-3 flex justify-between items-center">
                            <div>
                                <p class="font-bold">${p.title}</p>
                                <p class="text-xs ${p.is_active ? 'text-green-600' : 'text-slate-500'}">${p.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}</p>
                            </div>
                            <button data-action="editPartner" data-partner-id="${p.id}" class="text-sm btn bg-slate-100 text-slate-800 font-bold py-1 px-3 rounded-lg">–ò–∑–º.</button>
                        </div>
                    `).join('');
                },
                renderAdminForm(partner = {}) {
                    const form = document.getElementById('admin-partner-form');
                    const title = document.getElementById('admin-form-title');
                    const deleteBtn = document.getElementById('delete-partner-btn');
                    
                    title.textContent = partner.id ? '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞' : '–î–æ–±–∞–≤–∏—Ç—å –ø–∞—Ä—Ç–Ω–µ—Ä–∞';
                    form.querySelector('[name="id"]').value = partner.id || '';
                    form.querySelector('[name="title"]').value = partner.title || '';
                    form.querySelector('[name="description"]').value = partner.description || '';
                    form.querySelector('[name="link_url"]').value = partner.link_url || '';
                    form.querySelector('#is_active_toggle').checked = partner.id ? partner.is_active : true;
                    
                    const slidesEditor = document.getElementById('slides-editor');
                    slidesEditor.innerHTML = '';
                    if(partner.partner_slides && partner.partner_slides.length > 0) {
                        partner.partner_slides.forEach(slide => this.addSlideInput(slide));
                    } else {
                        this.addSlideInput(); // Add one empty slide by default
                    }
                    
                    deleteBtn.classList.toggle('hidden', !partner.id);
                },
                addSlideInput(slide = {}) {
                    const container = document.getElementById('slides-editor');
                    const div = document.createElement('div');
                    div.className = 'slide-input-group border rounded-lg p-3 space-y-2 relative';
                    div.innerHTML = `
                        <input type="url" name="image_url" class="w-full p-2 border border-slate-200 rounded-lg text-sm" placeholder="URL –ö–∞—Ä—Ç–∏–Ω–∫–∏" value="${slide.image_url || ''}" required>
                        <input type="text" name="caption" class="w-full p-2 border border-slate-200 rounded-lg text-sm" placeholder="–ü–æ–¥–ø–∏—Å—å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" value="${slide.caption || ''}">
                        <button type="button" data-action="removeSlide" class="absolute top-2 right-2 text-red-500 hover:text-red-700">&times;</button>
                    `;
                    container.appendChild(div);
                },
                getDriverOfferCard(item) {
                    const seatsLeft = item.seats_left;
                    const seatsText = seatsLeft === 1 ? '1 –º–µ—Å—Ç–æ' : (seatsLeft > 1 && seatsLeft < 5 ? `${seatsLeft} –º–µ—Å—Ç–∞` : `${seatsLeft} –º–µ—Å—Ç`);
                    let buttonHtml = '';
                    if (item.currentUserBookingId) {
                        buttonHtml = `<button class="btn w-full bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 text-sm" data-action="cancelBooking" data-booking-id="${item.currentUserBookingId}">–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å</button>`;
                    } else if (item.via_cheboksary_detour) {
                         buttonHtml = `<button class="btn w-full bg-orange-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-orange-600 text-sm" data-action="detourBooking" data-offer='${encodeURIComponent(JSON.stringify(item))}'>–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`;
                    } else {
                        buttonHtml = `<button class="btn w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 text-sm" data-action="requestBooking" data-offer-id="${item.id}">–ó–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å</button>`;
                    }
                    return `
                        <p class="text-xs text-slate-500">${item.driver_car || '–ê–≤—Ç–æ –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <div class="flex justify-between items-center">
                            <h3 class="text-base font-bold">${item.from} ‚Üí ${item.to}</h3>
                            <span class="text-base font-bold">${item.price} ‚ÇΩ</span>
                        </div>
                        <p class="text-sm text-slate-600">${this.formatDate(item.ride_date)} –≤ ${this.formatTime(item.ride_time)}</p>
                        <p class="text-sm">–°–≤–æ–±–æ–¥–Ω–æ: <b>${seatsText}</b></p>
                         ${(item.via_ferry || item.via_cheboksary_detour) ? `<p class="text-xs font-medium ${item.via_ferry ? 'text-blue-600' : 'text-orange-600'}">${item.via_ferry ? '‚õ¥Ô∏è –ß–µ—Ä–µ–∑ –ø–∞—Ä–æ–º' : ' detour-icon –ó–∞–µ–∑–¥ –≤ –ß–µ–±–æ–∫—Å–∞—Ä—ã'}</p>` : ''}
                        <div class="pt-2">${buttonHtml}</div>`;
                },
                getPassengerRequestCard(item) {
                    const isParcel = item.type === 'parcel_request';
                    const buttonHtml = isParcel ? '' : `<button data-action="offerRide" data-request-id="${item.id}" class="btn w-full bg-green-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-600 text-sm">–ü—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>`;
                    return `
                        <div class="flex justify-between items-center">
                             <h3 class="text-base font-bold">${item.from} ‚Üí ${item.to}</h3>
                            <span class="text-base font-bold">${item.price} ‚ÇΩ</span>
                        </div>
                        <p class="text-sm text-slate-600">${this.formatDate(item.ride_date)}</p>
                        <p class="text-sm">${isParcel ? '<b>–ü–æ—Å—ã–ª–∫–∞</b>' : `–ñ–µ–ª–∞–µ–º–æ–µ –≤—Ä–µ–º—è: <b>${item.time_interval}</b>`}</p>
                        <div class="pt-2">${buttonHtml}</div>`;
                },
                getMyDriverOfferCard(offer) {
                    let passengerList = '<p class="text-xs text-slate-500">–ü–æ–∫–∞ –Ω–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã—Ö –ø–∞—Å—Å–∞–∂–∏—Ä–æ–≤.</p>';
                    if (offer.bookings && offer.bookings.length > 0) {
                        passengerList = offer.bookings.map(b => `
                            <div class="flex items-center justify-between p-2 rounded-lg ${b.status === 'pending' ? 'bg-yellow-100' : 'bg-green-100'}">
                                <div>
                                    <p class="text-sm font-medium">${b.passenger.full_name}</p>
                                    <a href="https://t.me/${b.passenger.username}" target="_blank" class="text-xs text-blue-600">@${b.passenger.username}</a>
                                </div>
                                ${b.status === 'pending' ? `
                                <div class="flex gap-2">
                                    <button data-action="updateBookingStatus" data-booking-id="${b.id}" data-status="confirmed" class="w-8 h-8 flex items-center justify-center bg-green-500 text-white rounded-md hover:bg-green-600">‚úì</button>
                                    <button data-action="updateBookingStatus" data-booking-id="${b.id}" data-status="rejected" class="w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-md hover:bg-red-600">√ó</button>
                                </div>
                                ` : `<span class="text-xs font-bold text-green-700">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</span>`}
                            </div>`).join('');
                    }
                    return `
                        <h3 class="text-base font-bold">${offer.from} ‚Üí ${offer.to} - ${offer.price} ‚ÇΩ</h3>
                        <p class="text-sm text-slate-600">${this.formatDate(offer.ride_date, true)} –≤ ${this.formatTime(offer.ride_time)}</p>
                        <div class="space-y-2">
                            <h4 class="text-xs font-semibold text-slate-600">–ü–∞—Å—Å–∞–∂–∏—Ä—ã:</h4>
                            ${passengerList}
                        </div>
                        <div class="pt-2">
                           <button data-action="deleteOffer" data-offer-id="${offer.id}" class="btn w-full bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200 text-sm">–£–¥–∞–ª–∏—Ç—å –ø–æ–µ–∑–¥–∫—É</button>
                        </div>`;
                },
                getMyBookingCard(booking) {
                    const statusMap = {
                        pending: { text: '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è', color: 'bg-yellow-100 text-yellow-800' },
                        confirmed: { text: '–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ', color: 'bg-green-100 text-green-800' },
                        rejected: { text: '–û—Ç–∫–ª–æ–Ω–µ–Ω–æ', color: 'bg-red-100 text-red-800' },
                    };
                    const driver = booking.offer.driver;
                    return `
                        <h3 class="text-base font-bold">${booking.from_city} ‚Üí ${booking.to_city} - ${booking.price} ‚ÇΩ</h3>
                        <p class="text-sm text-slate-600">${this.formatDate(booking.offer.ride_date, true)} –≤ ${this.formatTime(booking.offer.ride_time)}</p>
                        <p class="text-xs font-medium px-2 py-1 rounded-full ${statusMap[booking.status]?.color} inline-block">${statusMap[booking.status]?.text}</p>
                        ${booking.status === 'confirmed' ? `
                         <div>
                            <p class="text-sm">–í–æ–¥–∏—Ç–µ–ª—å: <b>${driver.full_name}</b> (${driver.driver_car || ''})</p>
                            <a href="https://t.me/${driver.username}" target="_blank" class="text-sm text-blue-600">–°–≤—è–∑–∞—Ç—å—Å—è –≤ Telegram</a>
                         </div>
                        ` : ''}
                        <div class="pt-2">
                           <button data-action="cancelBooking" data-booking-id="${booking.id}" class="btn w-full bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200 text-sm">–û—Ç–º–µ–Ω–∏—Ç—å –±—Ä–æ–Ω—å</button>
                        </div>`;
                },
                getMyRequestCard(request) {
                    return `
                        <h3 class="text-base font-bold">${request.from} ‚Üí ${request.to} - ${request.price} ‚ÇΩ</h3>
                        <p class="text-sm text-slate-600">${this.formatDate(request.ride_date, true)}, –ø—Ä–∏–º–µ—Ä–Ω–æ –≤ ${request.time_interval}</p>
                        <div class="pt-2">
                           <button data-action="cancelRequest" data-request-id="${request.id}" class="btn w-full bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200 text-sm">–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É</button>
                        </div>`;
                },
                getMyParcelRequestCard(parcel) {
                    return `
                        <h3 class="text-base font-bold">–ü–æ—Å—ã–ª–∫–∞: ${parcel.from} ‚Üí ${parcel.to} - ${parcel.price} ‚ÇΩ</h3>
                        <p class="text-sm text-slate-600">–î–∞—Ç–∞: ${this.formatDate(parcel.ride_date, true)}</p>
                        <div class="pt-2">
                           <button data-action="cancelParcelRequest" data-request-id="${parcel.id}" class="btn w-full bg-red-100 text-red-700 font-bold py-2 px-4 rounded-lg hover:bg-red-200 text-sm">–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –ø–æ—Å—ã–ª–∫—É</button>
                        </div>`;
                },
                // --- HELPERS ---
                getLoaderHTML() { return '<div class="text-center p-8">–ó–∞–≥—Ä—É–∑–∫–∞...</div>'; },
                getErrorHTML(message) { return `<div class="text-center text-red-500 p-8">${message}</div>`},
                setDefaultDates() {
                    const today = new Date().toISOString().split('T')[0];
                    document.querySelectorAll('input[type="date"]').forEach(input => {
                        input.value = today;
                        input.min = today;
                    });
                },
                populateSelects() {
                    const optionsHTML = App.config.cities.map(city => `<option value="${city}">${city}</option>`).join('');
                    document.querySelectorAll('select[name="from-select"], select[name="to-select"], #filter-from, #filter-to').forEach(select => {
                        const placeholder = select.querySelector('option[disabled]')?.outerHTML || '<option value="">–í—Å–µ –≥–æ—Ä–æ–¥–∞</option>';
                        select.innerHTML = placeholder + optionsHTML;
                    });
                },
                resetForm(form) {
                    form.reset();
                    this.setDefaultDates();
                    if (form.id === 'passenger-request-form') {
                        form.querySelectorAll('#time-interval-buttons button').forEach(btn => btn.classList.remove('active'));
                    }
                },
                 formatDate(dateStr, withYear = false) {
                    const date = new Date(dateStr);
                    const options = { day: 'numeric', month: 'long' };
                    if (withYear) options.year = 'numeric';
                    return date.toLocaleDateString('ru-RU', options);
                },
                formatTime(timeStr) {
                    return timeStr.substring(0, 5);
                }
            },

            // --- UTILS ---
            utils: {
                sendTelegramNotification(userId, text) {
                    console.log(`Sending notification to ${userId}: ${text}`);
                }
            },
        };

        App.init();
    });
    </script>
</body>
</html>

